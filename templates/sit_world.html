<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sit Mode â€“ Virtual Street Sit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MAPLIBRE -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/maplibre-gl.css') }}">
  <script src="{{ url_for('static', filename='js/maplibre-gl.js') }}"></script>

  <style>
    :root {
      --bg-page: #020617;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #f97316;
      --accent-soft: rgba(249,115,22,0.14);
      --accent-strong: #ea580c;
      --radius-lg: 18px;
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #020617, #000 80%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      overflow: hidden;
    }

    .viewer-panel {
      position: relative;
      width: 100%;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .viewer-canvas {
      position: relative;
      width: 100%;
      height: 100%;
      background: black;
      overflow: hidden;
    }

    /* ---------- Mode header (brand + location) ---------- */
    .mode-header {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      z-index: 60;
      pointer-events: none;
    }

    .mode-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 6px 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, #020617ee, #111827ee);
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: 0 14px 32px rgba(0,0,0,0.9);
      pointer-events: auto;
    }

    .mode-dot {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fee2e2, #fecaca 40%, #991b1b 100%);
      border: 2px solid rgba(15,23,42,0.9);
      box-shadow: 0 8px 20px rgba(0,0,0,0.8);
    }

    .mode-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #e5e7eb;
      opacity: 0.9;
    }

    .mode-tag {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #0b1120;
      box-shadow: 0 10px 26px rgba(248, 113, 22, 0.55);
    }

    .mode-location {
      margin-top: 3px;
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 999px;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.5);
      color: #e5e7eb;
      max-width: 260px;
      text-align: center;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      pointer-events: auto;
    }

    /* ---------- Mini map + full map ---------- */
    .mini-map {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 100px;
      height: 100px;
      border-radius: 999px;
      overflow: hidden;
      background: var(--bg-page);
      border: 2px solid rgba(148, 163, 184, 0.6);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.75);
      z-index: 50;
      cursor: pointer;
    }
    .mini-map canvas { border-radius: 999px; }

    #fullMapOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(6px);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #fullMapContainer {
      width: 90%;
      height: 80%;
      background: #0b1120;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 25px 70px rgba(0, 0, 0, 0.9);
    }
    #closeMapBtn {
      position: absolute;
      top: 30px;
      right: 40px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: rgba(0, 0, 0, 0.65);
      color: white;
      font-size: 22px;
      cursor: pointer;
      backdrop-filter: blur(4px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
    }

    /* ---------- Street info (bottom-left) ---------- */
    .street-info {
      position: absolute;
      bottom: 24px;
      left: 16px;
      padding: 10px 14px;
      background: rgba(15, 23, 42, 0.78);
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      z-index: 50;
      max-width: 260px;
      user-select: none;
    }
    .street-info h2 {
      margin: 0;
      font-size: 15px;
      line-height: 1.2;
    }
    .street-info p {
      margin: 4px 0 0;
      font-size: 12px;
      color: #cbd5e1;
      line-height: 1.3;
    }
    .street-info .category-pill {
      margin-top: 6px;
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid rgba(248, 250, 252, 0.12);
      color: #fed7aa;
      display: inline-block;
    }

    /* ---------- Video + fade + subtle parallax ---------- */
    #streetVideo {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
      z-index: 1;
      transition: transform 0.18s ease-out;
      user-select: none;
      -webkit-user-select: none;
      will-change: transform;
      transform: translate3d(0,0,0);
      backface-visibility: hidden;
    }
    #fadeLayer {
      position: absolute;
      inset: 0;
      background: black;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s;
      z-index: 110;
      user-select: none;
    }

    /* ---------- Sound toggle button ---------- */
    .sound-toggle {
      position: absolute;
      right: 18px;
      bottom: 24px;
      width: 42px;
      height: 42px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 60;
      box-shadow: 0 14px 32px rgba(0,0,0,0.9);
      transition:
        background 0.16s ease,
        border-color 0.16s ease,
        transform 0.12s ease,
        box-shadow 0.16s ease;
    }

    .sound-toggle span {
      font-size: 18px;
      line-height: 1;
    }

    .sound-toggle:hover {
      background: rgba(15,23,42,1);
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(248,113,22,0.35);
    }

    .sound-toggle.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: rgba(248,250,252,0.8);
      color: #0b1120;
    }

    @media (max-width: 900px) {
      .mini-map {
        width: 80px !important;
        height: 80px !important;
        top: 14px !important;
        left: 14px !important;
      }
    }

    @media (max-width: 480px) {
      .street-info {
        left: 12px;
        right: 12px;
        max-width: none;
        bottom: 18px;
      }
      .mode-header {
        top: 10px;
      }
      .mode-location {
        max-width: 200px;
      }
      .sound-toggle {
        right: 14px;
        bottom: 18px;
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>

<body>

<!-- Full map overlay -->
<div id="fullMapOverlay" role="dialog" aria-modal="true" aria-label="Full map view">
  <div id="fullMapContainer" tabindex="0" aria-live="polite"></div>
  <button id="closeMapBtn" aria-label="Close full map">âœ•</button>
</div>

<div class="viewer-panel" role="main" aria-live="polite">
  <div class="viewer-canvas" id="viewerCanvas">

    <!-- Mode header -->
    <div class="mode-header">
      <div class="mode-pill">
        <div class="mode-dot"></div>
        <div class="mode-label">ABTO Â· Virtual Street Walk</div>
        <div class="mode-tag">SIT MODE</div>
      </div>
      <div class="mode-location" id="topLocationPill">Pick a seat to begin</div>
    </div>

    <!-- Mini map -->
    <div id="miniMap" class="mini-map" aria-label="Mini map preview" role="button" tabindex="0"></div>

    <!-- Street info -->
    <div class="street-info" aria-live="polite" aria-atomic="true">
      <h2 id="streetName">Select a Sit Spot</h2>
      <p id="streetLocation">Waiting for a viewâ€¦</p>
      <span class="category-pill" id="categoryLabel">Ambient view</span>
    </div>

    <!-- Sound toggle -->
    <button
      type="button"
      class="sound-toggle"
      id="soundToggle"
      aria-label="Unmute ambience (press M)">
      <span>ðŸ”‡</span>
    </button>

    <!-- Sit video -->
    <video
      id="streetVideo"
      preload="auto"
      playsinline
      disablepictureinpicture
      controlslist="nodownload nofullscreen noplaybackrate"
      aria-label="Sit view video">
      <source id="videoSource" src="">
    </video>

    <div id="fadeLayer" aria-hidden="true"></div>

  </div>
</div>

<!-- Streets data from Flask -->
<script id="streets-data" type="application/json">
  {{ streets | tojson | safe }}
</script>
<script id="selected-street-data" type="application/json">
  {{ selected_street | tojson | safe if selected_street else 'null' }}
</script>

<script type="module">
  const MAP_STYLE_URL = "{{ map_style_url or '' }}";
  const BASE_MAP_STYLE = MAP_STYLE_URL || "https://demotiles.maplibre.org/style.json";

  const STREETS = JSON.parse(
    document.getElementById('streets-data').textContent
  );
  const SELECTED_STREET = JSON.parse(
    document.getElementById('selected-street-data').textContent
  );

  let miniMap, miniMarker;
  let fullMap, fullMapReady = false;

  function initMiniMap() {
    miniMap = new maplibregl.Map({
      container: "miniMap",
      style: BASE_MAP_STYLE,
      center: [0, 20],
      zoom: 1.5,
      interactive: false,
      attributionControl: false,
    });
  }

  function ensureFullMap() {
    if (fullMapReady) return;

    fullMap = new maplibregl.Map({
      container: "fullMapContainer",
      style: BASE_MAP_STYLE,
      center: [0, 20],
      zoom: 2.5,
    });
    fullMap.addControl(new maplibregl.NavigationControl());

    STREETS.forEach((st, index) => {
      const lat = parseFloat(st.lat);
      const lng = parseFloat(st.lng);
      if (Number.isNaN(lat) || Number.isNaN(lng)) return;

      const marker = new maplibregl.Marker().setLngLat([lng, lat]).addTo(fullMap);
      marker.getElement().addEventListener("click", () => {
        loadStreetByIndex(index);
        hideFullMap();
      });
    });

    fullMapReady = true;
  }

  function updateMiniMapForStreet(street) {
    if (!miniMap) return;
    const lat = parseFloat(street.lat);
    const lng = parseFloat(street.lng);
    if (Number.isNaN(lat) || Number.isNaN(lng)) return;

    miniMap.jumpTo({ center: [lng, lat], zoom: 14 });

    if (!miniMarker) {
      miniMarker = new maplibregl.Marker({ color: "#ef4444", scale: 0.9 })
        .setLngLat([lng, lat])
        .addTo(miniMap);
    } else {
      miniMarker.setLngLat([lng, lat]);
    }
  }

  const miniMapEl = document.getElementById("miniMap");
  const fullMapOverlay = document.getElementById("fullMapOverlay");
  const closeMapBtn = document.getElementById("closeMapBtn");

  function showFullMap() {
    fullMapOverlay.style.display = "flex";
    ensureFullMap();
  }
  function hideFullMap() {
    fullMapOverlay.style.display = "none";
  }

  miniMapEl.addEventListener("click", showFullMap);
  miniMapEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") showFullMap();
  });
  closeMapBtn.addEventListener("click", hideFullMap);

  initMiniMap();

  const video = document.getElementById("streetVideo");
  const vsrc = document.getElementById("videoSource");
  const fadeLayer = document.getElementById("fadeLayer");
  const streetNameEl = document.getElementById("streetName");
  const streetLocationEl = document.getElementById("streetLocation");
  const topLocationEl = document.getElementById("topLocationPill");
  const categoryEl = document.getElementById("categoryLabel");
  const viewerCanvas = document.getElementById("viewerCanvas");
  const soundToggleBtn = document.getElementById("soundToggle");
  const soundIconSpan = soundToggleBtn?.querySelector("span");

  let currentStreetIndex = -1;
  let currentVideos = [];
  let currentVideoIndex = 0;

  // start muted for autoplay, user can unmute
  // start with sound ON by default
if (video) {
  video.muted = false;
  video.volume = 1.0;
}


  function updateSoundUI() {
    if (!soundToggleBtn || !video) return;
    if (video.muted) {
      soundToggleBtn.classList.remove("active");
      soundToggleBtn.setAttribute("aria-label", "Unmute ambience (press M)");
      if (soundIconSpan) soundIconSpan.textContent = "ðŸ”‡";
    } else {
      soundToggleBtn.classList.add("active");
      soundToggleBtn.setAttribute("aria-label", "Mute ambience (press M)");
      if (soundIconSpan) soundIconSpan.textContent = "ðŸ”Š";
    }
  }

  function toggleSound() {
    if (!video) return;
    video.muted = !video.muted;
    // Ensure playback continues after user gesture
    video.play().catch(() => {});
    updateSoundUI();
  }

  soundToggleBtn?.addEventListener("click", toggleSound);

  // Keyboard shortcut: M to mute/unmute
  document.addEventListener("keydown", (e) => {
    if (e.key === "m" || e.key === "M") {
      toggleSound();
    }
  });

  updateSoundUI();

  function safePlay() {
    if (!video || !video.paused) return;
    video.play().catch(() => {});
  }

  function safePause() {
    if (!video || video.paused) return;
    video.pause();
  }

  function doLoadStreet(street) {
    const name = street.name || "Sit Spot";
    const city = street.city || "";
    const country = street.country || "";
    const category = street.category || "Ambient view";

    const locationText = `${city}${city && country ? ", " : ""}${country}`;

    streetNameEl.textContent = name;
    streetLocationEl.textContent = locationText || "Somewhere in the world";
    if (topLocationEl) topLocationEl.textContent = locationText || "Pick a seat to begin";
    if (categoryEl) categoryEl.textContent = category;

    currentVideos = [];
    currentVideoIndex = 0;
    if (Array.isArray(street.videos) && street.videos.length > 0) {
      currentVideos = street.videos.map(v => v.url).filter(Boolean);
    }

    const videoUrl = currentVideos[0] || "";
    if (vsrc) vsrc.src = videoUrl;
    video.load();
    video.currentTime = 0;
    // respect current mute state, just play
    safePlay();

    updateMiniMapForStreet(street);
  }

  function loadStreet(street) {
    if (!street) return;
    fadeLayer.style.opacity = 1;
    setTimeout(() => {
      doLoadStreet(street);
      fadeLayer.style.opacity = 0;
    }, 220);
  }

  function loadStreetByIndex(index) {
    if (index < 0 || index >= STREETS.length) return;
    currentStreetIndex = index;
    loadStreet(STREETS[index]);
  }

  // Always loop gently between all videos for that sit spot
  video.addEventListener("ended", () => {
    if (currentVideos.length > 0) {
      currentVideoIndex = (currentVideoIndex + 1) % currentVideos.length;
      const nextUrl = currentVideos[currentVideoIndex];
      if (vsrc) vsrc.src = nextUrl;
      video.load();
      video.currentTime = 0;
      safePlay();
    } else {
      // single video with no list: just loop
      video.currentTime = 0;
      safePlay();
    }
  });

  // subtle parallax
  if (viewerCanvas && video) {
    const maxShift = 10;
    viewerCanvas.addEventListener("pointermove", (e) => {
      const rect = viewerCanvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width - 0.5;
      const y = (e.clientY - rect.top) / rect.height - 0.5;
      const tx = -x * maxShift;
      const ty = -y * maxShift;
      video.style.transform = `translate(${tx}px, ${ty}px) scale(1.03)`;
    });
    viewerCanvas.addEventListener("pointerleave", () => {
      video.style.transform = "translate(0,0) scale(1)";
    });
  }

  // Initial street selection
  if (SELECTED_STREET) {
    const idx = STREETS.findIndex(s => s._id === SELECTED_STREET._id);
    if (idx !== -1) {
      loadStreetByIndex(idx);
    } else if (Array.isArray(STREETS) && STREETS.length > 0) {
      loadStreetByIndex(0);
    }
  } else if (Array.isArray(STREETS) && STREETS.length > 0) {
    loadStreetByIndex(0);
  }
</script>

</body>
</html>
