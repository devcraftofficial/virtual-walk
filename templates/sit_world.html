<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sit Mode ‚Äì Virtual Street Sit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- MAPLIBRE -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/maplibre-gl.css') }}">
  <script src="{{ url_for('static', filename='js/maplibre-gl.js') }}"></script>

  <style>
    :root{
      --bg-page:#020617;
      --text-main:#e5e7eb;
      --text-muted:#9ca3af;

      --accent:#f97316;
      --accent-soft:rgba(249,115,22,.14);
      --accent-strong:#ea580c;

      --glass:rgba(15,23,42,.84);
      --glass-strong:rgba(15,23,42,.96);
      --border:rgba(148,163,184,.40);
      --border-strong:rgba(148,163,184,.55);

      --radius-lg:18px;
      --radius-md:14px;
      --shadow-soft: 0 14px 32px rgba(0,0,0,.85);

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
    }

    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; height:100%; }
    body{
      background: radial-gradient(circle at top, #020617, #000 80%);
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--text-main);
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .viewer-panel{
      position:relative;
      width:100%;
      height:100vh;
      height:100dvh;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .viewer-canvas{
      position:relative;
      width:100%;
      height:100%;
      background:black;
      overflow:hidden;
    }

    /* cinematic overlays */
    .vignette{
      position:absolute; inset:0;
      pointer-events:none;
      z-index: 5;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0) 35%, rgba(0,0,0,.35) 72%, rgba(0,0,0,.65) 100%);
    }
    .top-fade{
      position:absolute; inset:0;
      pointer-events:none;
      z-index: 6;
      background: linear-gradient(to bottom, rgba(0,0,0,.55), rgba(0,0,0,0) 35%);
      opacity:.75;
    }

    /* ---------- Mode header (brand + location) ---------- */
    .mode-header{
      position:absolute;
      top: calc(16px + var(--safe-top));
      left:50%;
      transform:translateX(-50%);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      z-index:60;
      pointer-events:none;
    }
    .mode-pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:6px 12px;
      border-radius:999px;
      background: linear-gradient(135deg, rgba(2,6,23,.90), rgba(17,24,39,.88));
      border:1px solid var(--border-strong);
      box-shadow: var(--shadow-soft);
      pointer-events:auto;
      backdrop-filter: blur(10px);
    }
    .mode-dot{
      width:22px; height:22px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 20%, #fee2e2, #fecaca 40%, #991b1b 100%);
      border:2px solid rgba(15,23,42,.9);
      box-shadow: 0 8px 20px rgba(0,0,0,.8);
      flex: 0 0 auto;
    }
    .mode-label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.09em;
      color:#e5e7eb;
      opacity:.9;
      white-space:nowrap;
    }
    .mode-tag{
      font-size:11px;
      font-weight:700;
      padding:4px 10px;
      border-radius:999px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color:#0b1120;
      box-shadow: 0 10px 26px rgba(248,113,22,.55);
      white-space:nowrap;
    }
    .mode-switch{
      font-size:11px;
      font-weight:650;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(56,189,248,.14);
      border: 1px solid rgba(56,189,248,.28);
      color:#7dd3fc;
      text-decoration:none;
      pointer-events:auto;
      white-space:nowrap;
    }
    .mode-switch:hover{
      background: rgba(56,189,248,.20);
      border-color: rgba(56,189,248,.45);
    }
    .mode-location{
      margin-top:3px;
      padding:4px 10px;
      font-size:11px;
      border-radius:999px;
      background: rgba(15,23,42,.80);
      border:1px solid rgba(148,163,184,.50);
      color:#e5e7eb;
      max-width: 280px;
      text-align:center;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
      pointer-events:auto;
      backdrop-filter: blur(8px);
    }

    /* ---------- Mini map + full map ---------- */
    .mini-map{
      position:absolute;
      top: calc(16px + var(--safe-top));
      left: calc(16px + var(--safe-left));
      width:100px;
      height:100px;
      border-radius:999px;
      overflow:hidden;
      background:var(--bg-page);
      border:2px solid rgba(148,163,184,.60);
      box-shadow: 0 12px 30px rgba(0,0,0,.75);
      z-index:50;
      cursor:pointer;
      touch-action: manipulation;
    }
    .mini-map canvas{ border-radius:999px; }

    #fullMapOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.75);
      backdrop-filter: blur(8px);
      z-index:200;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 20px;
    }
    #fullMapContainer{
      width:min(980px, 92vw);
      height:min(640px, 82vh);
      background:#0b1120;
      border-radius: var(--radius-lg);
      overflow:hidden;
      border:1px solid rgba(148,163,184,.50);
      box-shadow: 0 25px 70px rgba(0,0,0,.90);
    }
    #closeMapBtn{
      position:absolute;
      top: calc(18px + var(--safe-top));
      right: calc(18px + var(--safe-right));
      width:46px;
      height:46px;
      border-radius:50%;
      border:1px solid rgba(148,163,184,.35);
      background: rgba(0,0,0,.55);
      color:#fff;
      font-size: 22px;
      cursor:pointer;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,.80);
      touch-action: manipulation;
    }

    /* ---------- Street info (bottom-left) ---------- */
    .street-info{
      position:absolute;
      bottom: calc(24px + var(--safe-bottom));
      left: calc(16px + var(--safe-left));
      padding: 10px 14px;
      background: rgba(15,23,42,.78);
      border:1px solid rgba(148,163,184,.40);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      z-index:50;
      max-width: 320px;
      user-select:none;
      box-shadow: 0 18px 44px rgba(0,0,0,.55);
    }
    .street-info h2{ margin:0; font-size: 15px; line-height: 1.2; }
    .street-info p{ margin:4px 0 0; font-size: 12px; color:#cbd5e1; line-height: 1.3; }
    .street-info .category-pill{
      margin-top:6px;
      font-size:11px;
      padding: 3px 9px;
      border-radius:999px;
      background: var(--accent-soft);
      border:1px solid rgba(248,250,252,.12);
      color:#fed7aa;
      display:inline-block;
    }

    /* ---------- Video + fade + subtle parallax ---------- */
    #streetVideo{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      pointer-events:none;
      z-index:1;
      transition: transform .18s ease-out;
      user-select:none;
      -webkit-user-select:none;
      will-change: transform;
      transform: translate3d(0,0,0);
      backface-visibility:hidden;
      filter: saturate(1.05) contrast(1.02);
    }

    /* loading shimmer */
    .loading-scrim{
      position:absolute;
      inset:0;
      z-index: 20;
      pointer-events:none;
      background: linear-gradient(110deg, rgba(2,6,23,.85) 0%, rgba(15,23,42,.80) 40%, rgba(2,6,23,.85) 70%);
      background-size: 200% 100%;
      opacity: 0;
      transition: opacity .25s ease;
      animation: shimmer 1.1s linear infinite;
    }
    .loading-scrim.show{ opacity: 1; }
    @keyframes shimmer{
      0%{ background-position: 200% 0; }
      100%{ background-position: -200% 0; }
    }

    #fadeLayer{
      position:absolute;
      inset:0;
      background:black;
      opacity:0;
      pointer-events:none;
      transition: opacity .35s;
      z-index:110;
      user-select:none;
    }

    /* ---------- SOUND BUTTONS ---------- */
    .sound-toggle{
      position:absolute;
      right: calc(18px + var(--safe-right));
      bottom: calc(24px + var(--safe-bottom));
      width:42px;
      height:42px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.70);
      background: rgba(15,23,42,.90);
      color:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      z-index:60;
      box-shadow: var(--shadow-soft);
      transition: background .16s ease, border-color .16s ease, transform .12s ease, box-shadow .16s ease;
      backdrop-filter: blur(8px);
      touch-action: manipulation;
    }
    .sound-toggle span{ font-size:18px; line-height:1; }
    .sound-toggle:hover{
      background: rgba(15,23,42,1);
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(248,113,22,.35);
    }
    .sound-toggle.active{
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: rgba(248,250,252,.80);
      color: #0b1120;
    }

    /* ---------- TOP-RIGHT DOCK (desktop/tablet) ---------- */
    .top-right-dock{
      position:absolute;
      top: calc(16px + var(--safe-top));
      right: calc(16px + var(--safe-right));
      display:flex;
      gap:10px;
      z-index:80;
    }
    .dock-btn{
      width:40px;
      height:40px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.60);
      background: rgba(15,23,42,.90);
      color:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow-soft);
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
      user-select:none;
      touch-action: manipulation;
    }
    .dock-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(0,0,0,.90);
      border-color: rgba(148,163,184,.80);
    }
    .dock-btn.active{
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      border-color: rgba(248,250,252,.75);
      color:#0b1120;
    }

    /* Hide mobile fullscreen button when dock exists */
    @media (min-width: 1024px){
      .fullscreen-btn{ display:none; }
    }
    @media (max-width: 1023px){
      .top-right-dock{ display:none; } /* keep mobile buttons */
    }

    /* ---------- FULLSCREEN BUTTON (mobile) ---------- */
    .fullscreen-btn{
      position:absolute;
      top: calc(16px + var(--safe-top));
      right: calc(16px + var(--safe-right));
      width:40px;
      height:40px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.70);
      background: rgba(15,23,42,.90);
      color:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      cursor:pointer;
      z-index:70;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(8px);
      touch-action: manipulation;
    }

    /* ---------- MOBILE: LIST BUTTON (fix for ‚Äústreet list not showing‚Äù) ---------- */
    .list-btn{
      position:absolute;
      top: calc(16px + var(--safe-top));
      right: calc(64px + var(--safe-right)); /* sits left of fullscreen */
      width:40px;
      height:40px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.70);
      background: rgba(15,23,42,.90);
      color:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      cursor:pointer;
      z-index:70;
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(8px);
      touch-action: manipulation;
    }
    @media (min-width: 1024px){
      .list-btn{ display:none; }
    }

    /* ---------- ORIENTATION GATE (mobile portrait) ---------- */
    .orientation-gate{
      position:fixed;
      inset:0;
      background: radial-gradient(circle at top, #020617, #000 80%);
      display:none;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:40px 24px;
      z-index:300;
    }
    .orientation-inner{ max-width: 360px; }
    .orientation-icon{
      font-size:46px;
      margin-bottom:18px;
      display:inline-block;
      animation: rotateHint 1.8s ease-in-out infinite;
    }
    .orientation-title{ font-size:18px; font-weight:700; margin-bottom:8px; }
    .orientation-text{ font-size:14px; color: var(--text-muted); line-height: 1.45; }
    @keyframes rotateHint{
      0%,100%{ transform: rotate(0deg); }
      50%{ transform: rotate(90deg); }
    }
    @media (max-width: 768px) and (orientation: portrait){
      .orientation-gate{ display:flex; }
    }

    /* ---------- Streets Drawer ---------- */
    .streets-overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      display:none;
      z-index:240;
      /* IMPORTANT: allow taps/scrolls inside on mobile */
      pointer-events:auto;
      touch-action: none; /* we manage scroll only inside drawer */
    }
    .streets-drawer{
      width: min(380px, 92vw);
      height: 100%;
      background: rgba(2,6,23,.96);
      border-right: 1px solid rgba(148,163,184,.22);
      padding: 14px;
      box-shadow: 26px 0 70px rgba(0,0,0,.80);
      display:flex;
      flex-direction:column;
      gap: 10px;
      touch-action: pan-y;
    }
    .drawer-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 4px;
    }
    .drawer-title{ font-weight: 750; letter-spacing: .01em; }
    .drawer-close{
      width: 38px; height: 38px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,.35);
      background: rgba(15,23,42,.75);
      color:#fff;
      cursor:pointer;
      touch-action: manipulation;
    }
    .drawer-search{
      width: 100%;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.65);
      color: var(--text-main);
      outline: none;
    }
    .drawer-search::placeholder{ color: rgba(148,163,184,.75); }

    .streets-list{
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-right: 2px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }
    .street-item{
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(15,23,42,.58);
      border: 1px solid rgba(148,163,184,.18);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      touch-action: manipulation;
    }
    .street-item:hover{
      transform: translateY(-1px);
      border-color: rgba(148,163,184,.35);
      background: rgba(15,23,42,.70);
    }
    .street-item strong{ display:block; font-size: 13px; margin-bottom: 2px; }
    .street-item small{ color: rgba(203,213,225,.90); font-size: 11px; }
    .street-item .pill{
      display:inline-block;
      margin-top: 6px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(249,115,22,.12);
      border:1px solid rgba(249,115,22,.20);
      color:#fed7aa;
    }
    .street-item.active{
      border-color: rgba(249,115,22,.55);
      box-shadow: 0 10px 24px rgba(249,115,22,.12);
    }

    /* ---------- Toast ---------- */
    .device-toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(18px + var(--safe-bottom));
      width: min(540px, 92vw);
      background: rgba(15,23,42,.95);
      border: 1px solid rgba(148,163,184,.26);
      border-radius: 16px;
      padding: 12px 12px;
      display:none;
      z-index: 260;
      box-shadow: 0 18px 50px rgba(0,0,0,.70);
      backdrop-filter: blur(10px);
    }
    .toast-row{ display:flex; align-items:flex-start; justify-content:space-between; gap: 12px; }
    .toast-row strong{ display:block; font-size: 13px; margin-bottom: 2px; }
    .toast-row span{ font-size: 12px; color: rgba(203,213,225,.92); line-height: 1.35; }
    .toast-close{
      width: 34px; height: 34px;
      border-radius: 999px;
      border:1px solid rgba(148,163,184,.25);
      background: rgba(2,6,23,.55);
      color:#fff;
      cursor:pointer;
      flex: 0 0 auto;
      touch-action: manipulation;
    }

    /* ---------- Responsive tweaks ---------- */
    @media (max-width: 900px){
      .mini-map{ width:80px !important; height:80px !important; top: calc(14px + var(--safe-top)) !important; left: calc(14px + var(--safe-left)) !important; }
    }
    @media (max-width: 480px){
      .street-info{
        left: calc(12px + var(--safe-left));
        right: calc(12px + var(--safe-right));
        max-width: none;
        bottom: calc(18px + var(--safe-bottom));
      }
      .mode-header{ top: calc(10px + var(--safe-top)); }
      .mode-location{ max-width: 220px; }
      .sound-toggle{
        right: calc(14px + var(--safe-right));
        bottom: calc(18px + var(--safe-bottom));
        width:40px; height:40px;
      }
      .fullscreen-btn{
        top: calc(12px + var(--safe-top));
        right: calc(12px + var(--safe-right));
      }
      .list-btn{
        top: calc(12px + var(--safe-top));
        right: calc(58px + var(--safe-right));
      }
    }

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce){
      #streetVideo, .loading-scrim{ transition: none !important; animation: none !important; }
      .orientation-icon{ animation: none !important; }
    }
  </style>
</head>

<body>
  <!-- Full map overlay -->
  <div id="fullMapOverlay" role="dialog" aria-modal="true" aria-label="Full map view">
    <div id="fullMapContainer" tabindex="0" aria-live="polite"></div>
    <button id="closeMapBtn" aria-label="Close full map">‚úï</button>
  </div>

  <!-- Streets drawer overlay -->
  <div id="streetsDrawerOverlay" class="streets-overlay" aria-hidden="true">
    <div class="streets-drawer" role="dialog" aria-modal="true" aria-label="All sit spots">
      <div class="drawer-header">
        <div class="drawer-title">All Sit Spots</div>
        <button class="drawer-close" id="closeDrawerBtn" aria-label="Close">‚úï</button>
      </div>
      <input id="streetSearch" class="drawer-search" placeholder="Search city, country, or name‚Ä¶" autocomplete="off" />
      <div id="streetsList" class="streets-list" aria-live="polite"></div>
    </div>
  </div>

  <!-- Orientation gate for mobile portrait -->
  <div id="orientationGate" class="orientation-gate">
    <div class="orientation-inner">
      <div class="orientation-icon">üì±</div>
      <div class="orientation-title">Rotate your phone for Sit Mode</div>
      <p class="orientation-text">
        Sit Mode is best experienced in <strong>landscape</strong>.<br>
        Please rotate your phone sideways to see the full street view.
      </p>
    </div>
  </div>

  <!-- Best on desktop toast -->
  <div id="deviceToast" class="device-toast" role="status" aria-live="polite">
    <div class="toast-row">
      <div>
        <strong>Best on Desktop</strong>
        <span>Sit Mode looks calmer on a bigger screen. You can still use mobile‚Äîtry landscape + fullscreen.</span>
      </div>
      <button class="toast-close" id="toastClose" aria-label="Close">‚úï</button>
    </div>
  </div>

  <div class="viewer-panel" role="main" aria-live="polite">
    <div class="viewer-canvas" id="viewerCanvas">

      <!-- cinematic overlays -->
      <div class="vignette" aria-hidden="true"></div>
      <div class="top-fade" aria-hidden="true"></div>

      <!-- Mode header -->
      <div class="mode-header">
        <div class="mode-pill">
          <div class="mode-dot"></div>
          <div class="mode-label">ABTO ¬∑ Virtual Street Walk</div>
          <div class="mode-tag">SIT MODE</div>
          <a class="mode-switch" href="/world" title="Go to Walk Mode">Walk</a>
        </div>
        <div class="mode-location" id="topLocationPill">Pick a seat to begin</div>
      </div>

      <!-- Mini map -->
      <div id="miniMap" class="mini-map" aria-label="Mini map preview" role="button" tabindex="0"></div>

      <!-- Street info -->
      <div class="street-info" aria-live="polite" aria-atomic="true">
        <h2 id="streetName">Select a Sit Spot</h2>
        <p id="streetLocation">Waiting for a view‚Ä¶</p>
        <span class="category-pill" id="categoryLabel">Ambient view</span>
      </div>

      <!-- Desktop dock -->
      <div class="top-right-dock" id="topRightDock" aria-label="Controls">
        <button class="dock-btn" id="dockSoundBtn" aria-label="Toggle sound (M)">
          <span id="dockSoundIcon">üîä</span>
        </button>
        <button class="dock-btn" id="dockStreetsBtn" aria-label="All sit spots (L)">‚ò∞</button>
        <button class="dock-btn" id="dockFullscreenBtn" aria-label="Fullscreen (F)">‚§¢</button>
      </div>

      <!-- Mobile: Streets list button (NEW) -->
      <button id="listBtn" class="list-btn" aria-label="All sit spots (tap)">‚ò∞</button>

      <!-- Sound toggle (mobile) -->
      <button type="button" class="sound-toggle" id="soundToggle" aria-label="Mute ambience (press M)">
        <span>üîä</span>
      </button>

      <!-- Fullscreen button (mobile) -->
      <button id="fullscreenBtn" class="fullscreen-btn" aria-label="Enter full screen">‚§¢</button>

      <!-- Video loading shimmer -->
      <div id="loadingScrim" class="loading-scrim" aria-hidden="true"></div>

      <!-- Sit video -->
      <video
        id="streetVideo"
        preload="auto"
        playsinline
        webkit-playsinline
        disablepictureinpicture
        controlslist="nodownload nofullscreen noplaybackrate"
        aria-label="Sit view video">
        <source id="videoSource" src="">
      </video>

      <div id="fadeLayer" aria-hidden="true"></div>

    </div>
  </div>

  <!-- Streets data from Flask -->
  <script id="streets-data" type="application/json">
    {{ streets | tojson | safe }}
  </script>
  <script id="selected-street-data" type="application/json">
    {{ selected_street | tojson | safe if selected_street else 'null' }}
  </script>

  <script type="module">
    const MAP_STYLE_URL = "{{ map_style_url or '' }}";
    const BASE_MAP_STYLE = MAP_STYLE_URL || "https://demotiles.maplibre.org/style.json";

    const STREETS = JSON.parse(document.getElementById('streets-data').textContent || "[]");
    const SELECTED_STREET = JSON.parse(document.getElementById('selected-street-data').textContent || "null");

    // ---------- DOM ----------
    const miniMapEl = document.getElementById("miniMap");
    const fullMapOverlay = document.getElementById("fullMapOverlay");
    const closeMapBtn = document.getElementById("closeMapBtn");

    const video = document.getElementById("streetVideo");
    const vsrc = document.getElementById("videoSource");
    const fadeLayer = document.getElementById("fadeLayer");
    const loadingScrim = document.getElementById("loadingScrim");

    const streetNameEl = document.getElementById("streetName");
    const streetLocationEl = document.getElementById("streetLocation");
    const topLocationEl = document.getElementById("topLocationPill");
    const categoryEl = document.getElementById("categoryLabel");
    const viewerCanvas = document.getElementById("viewerCanvas");

    const soundToggleBtn = document.getElementById("soundToggle");
    const soundIconSpan = soundToggleBtn?.querySelector("span");

    const dockSoundBtn = document.getElementById("dockSoundBtn");
    const dockSoundIcon = document.getElementById("dockSoundIcon");
    const dockStreetsBtn = document.getElementById("dockStreetsBtn");
    const dockFullscreenBtn = document.getElementById("dockFullscreenBtn");
    const fullscreenBtn = document.getElementById("fullscreenBtn");

    const listBtn = document.getElementById("listBtn"); // NEW mobile list button

    const orientationGate = document.getElementById("orientationGate");

    const drawerOverlay = document.getElementById("streetsDrawerOverlay");
    const streetsListEl = document.getElementById("streetsList");
    const streetSearch = document.getElementById("streetSearch");
    const closeDrawerBtn = document.getElementById("closeDrawerBtn");

    const deviceToast = document.getElementById("deviceToast");
    const toastClose = document.getElementById("toastClose");

    // ---------- MAPS ----------
    let miniMap, miniMarker;
    let fullMap, fullMapReady = false;

    function initMiniMap(){
      try{
        miniMap = new maplibregl.Map({
          container: "miniMap",
          style: BASE_MAP_STYLE,
          center: [0, 20],
          zoom: 1.5,
          interactive: false,
          attributionControl: false,
        });
      } catch(e){
        console.warn("Mini map init failed:", e);
      }
    }

    function ensureFullMap(){
      if (fullMapReady) return;
      try{
        fullMap = new maplibregl.Map({
          container: "fullMapContainer",
          style: BASE_MAP_STYLE,
          center: [0, 20],
          zoom: 2.5,
        });
        fullMap.addControl(new maplibregl.NavigationControl());

        STREETS.forEach((st, index) => {
          const lat = parseFloat(st.lat);
          const lng = parseFloat(st.lng);
          if (Number.isNaN(lat) || Number.isNaN(lng)) return;

          const marker = new maplibregl.Marker().setLngLat([lng, lat]).addTo(fullMap);
          marker.getElement().addEventListener("click", () => {
            loadStreetByIndex(index);
            hideFullMap();
          });
        });

        fullMapReady = true;
      } catch(e){
        console.warn("Full map init failed:", e);
      }
    }

    function updateMiniMapForStreet(street){
      if (!miniMap) return;
      const lat = parseFloat(street.lat);
      const lng = parseFloat(street.lng);
      if (Number.isNaN(lat) || Number.isNaN(lng)) return;

      miniMap.jumpTo({ center: [lng, lat], zoom: 14 });

      if (!miniMarker){
        miniMarker = new maplibregl.Marker({ color: "#ef4444", scale: 0.9 })
          .setLngLat([lng, lat])
          .addTo(miniMap);
      } else {
        miniMarker.setLngLat([lng, lat]);
      }
    }

    function showFullMap(){
      fullMapOverlay.style.display = "flex";
      ensureFullMap();
      setTimeout(() => { try{ fullMap?.resize(); } catch(_){} }, 50);
    }
    function hideFullMap(){
      fullMapOverlay.style.display = "none";
    }

    miniMapEl?.addEventListener("click", showFullMap);
    miniMapEl?.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") showFullMap();
    });
    closeMapBtn?.addEventListener("click", hideFullMap);

    initMiniMap();

    // ---------- VIDEO STATE ----------
    let currentStreetIndex = -1;
    let currentVideos = [];
    let currentVideoIndex = 0;

    // ‚úÖ IMPORTANT: "sound ON by default" is not possible as true autoplay on mobile
    // unless user interacts. So we:
    // 1) start muted=false and try play
    // 2) if browser blocks, we auto-mute and show a gentle hint
    if (video){
      video.muted = false;
      video.volume = 1.0;
    }

    function showLoading(on){
      if (!loadingScrim) return;
      loadingScrim.classList.toggle("show", !!on);
    }

    function updateSoundUI(){
      const isMuted = !!video?.muted;

      // mobile button
      if (soundToggleBtn){
        soundToggleBtn.classList.toggle("active", !isMuted);
        soundToggleBtn.setAttribute("aria-label", isMuted ? "Unmute ambience (press M)" : "Mute ambience (press M)");
        if (soundIconSpan) soundIconSpan.textContent = isMuted ? "üîá" : "üîä";
      }

      // desktop dock
      if (dockSoundBtn){
        dockSoundBtn.classList.toggle("active", !isMuted);
        if (dockSoundIcon) dockSoundIcon.textContent = isMuted ? "üîá" : "üîä";
      }
    }

    function showTapToUnmuteHint(){
      // reuse existing toast if available, otherwise just update street text
      try{
        if (deviceToast){
          deviceToast.style.display = "block";
          const strong = deviceToast.querySelector("strong");
          const span = deviceToast.querySelector("span");
          if (strong) strong.textContent = "Tap for Sound";
          if (span) span.textContent = "Your browser blocked autoplay with audio. Tap üîä once to enable ambience.";
        }
      } catch(_) {}
    }

    async function safePlay(){
      if (!video) return;
      try{
        await video.play();
      } catch(e){
        // If autoplay with sound is blocked, fallback to muted autoplay
        if (video && !video.muted){
          video.muted = true;
          updateSoundUI();
          try{ await video.play(); } catch(_) {}
          showTapToUnmuteHint();
        }
      }
    }

    function setMuted(muted){
      if (!video) return;
      video.muted = muted;
      updateSoundUI();
      safePlay();
    }

    function toggleSound(){
      if (!video) return;
      setMuted(!video.muted);
    }

    soundToggleBtn?.addEventListener("click", toggleSound);
    dockSoundBtn?.addEventListener("click", toggleSound);

    // Ensure first user interaction tries to enable sound (keeps your ‚Äúsound on default‚Äù feel)
    const enableSoundOnFirstTap = async () => {
      if (!video) return;
      // if already unmuted, nothing
      if (!video.muted) return;
      video.muted = false;
      updateSoundUI();
      try{ await video.play(); } catch(_) {
        // if still blocked, keep muted
        video.muted = true;
        updateSoundUI();
      }
      window.removeEventListener("pointerdown", enableSoundOnFirstTap, true);
      window.removeEventListener("touchstart", enableSoundOnFirstTap, true);
    };
    window.addEventListener("pointerdown", enableSoundOnFirstTap, true);
    window.addEventListener("touchstart", enableSoundOnFirstTap, true);

    // Gentle loop through sit videos
    video?.addEventListener("ended", () => {
      if (currentVideos.length > 0){
        currentVideoIndex = (currentVideoIndex + 1) % currentVideos.length;
        const nextUrl = currentVideos[currentVideoIndex];
        if (vsrc) vsrc.src = nextUrl || "";
        showLoading(true);
        video.load();
        video.currentTime = 0;
        safePlay().finally(()=>showLoading(false));
      } else {
        video.currentTime = 0;
        safePlay();
      }
    });

    // Loading + errors
    video?.addEventListener("loadstart", ()=>showLoading(true));
    video?.addEventListener("canplay", ()=>showLoading(false));
    video?.addEventListener("playing", ()=>showLoading(false));
    video?.addEventListener("error", ()=>{
      showLoading(false);
      if (streetLocationEl) streetLocationEl.textContent = "Video unavailable. Try another sit spot.";
    });

    function buildLocationText(city, country){
      const c1 = (city || "").trim();
      const c2 = (country || "").trim();
      return `${c1}${c1 && c2 ? ", " : ""}${c2}`.trim();
    }

    function doLoadStreet(street){
      if (!street) return;

      const name = street.name || "Sit Spot";
      const city = street.city || "";
      const country = street.country || "";
      const category = street.category || "Ambient view";
      const locationText = buildLocationText(city, country);

      if (streetNameEl) streetNameEl.textContent = name;
      if (streetLocationEl) streetLocationEl.textContent = locationText || "Somewhere in the world";
      if (topLocationEl) topLocationEl.textContent = locationText || "Pick a seat to begin";
      if (categoryEl) categoryEl.textContent = category;

      // gather videos
      currentVideos = [];
      currentVideoIndex = 0;

      if (Array.isArray(street.videos) && street.videos.length > 0){
        currentVideos = street.videos
          .map(v => (typeof v === "string" ? v : v?.url))
          .filter(Boolean);
      }

      const videoUrl = currentVideos[0] || "";
      if (vsrc) vsrc.src = videoUrl;

      showLoading(true);
      video.load();
      video.currentTime = 0;

      safePlay().finally(()=>showLoading(false));
      updateMiniMapForStreet(street);
      renderDrawerList(); // keep active highlight in sync
    }

    function loadStreet(street){
      if (!street) return;
      fadeLayer.style.opacity = 1;
      setTimeout(() => {
        doLoadStreet(street);
        fadeLayer.style.opacity = 0;
      }, 220);
    }

    function loadStreetByIndex(index){
      if (!Array.isArray(STREETS) || index < 0 || index >= STREETS.length) return;
      currentStreetIndex = index;
      loadStreet(STREETS[index]);
    }

    // ---------- PARALLAX (desktop only-ish) ----------
    if (viewerCanvas && video){
      const maxShift = 10;
      viewerCanvas.addEventListener("pointermove", (e) => {
        if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

        const rect = viewerCanvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width - 0.5;
        const y = (e.clientY - rect.top) / rect.height - 0.5;
        const tx = -x * maxShift;
        const ty = -y * maxShift;
        video.style.transform = `translate(${tx}px, ${ty}px) scale(1.03)`;
      });
      viewerCanvas.addEventListener("pointerleave", () => {
        video.style.transform = "translate(0,0) scale(1)";
      });
    }

    // ---------- ORIENTATION GATE ----------
    function updateOrientationGate(){
      if (!orientationGate) return;
      const isMobile = window.innerWidth <= 768;
      const isPortrait = window.innerHeight >= window.innerWidth;
      orientationGate.style.display = (isMobile && isPortrait) ? "flex" : "none";
    }
    updateOrientationGate();
    window.addEventListener("resize", updateOrientationGate);
    window.addEventListener("orientationchange", updateOrientationGate);

    // ---------- FULLSCREEN ----------
    function isFullscreen(){
      return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
    }
    async function enterFullscreen(){
      const el = document.documentElement;
      if (el.requestFullscreen) return el.requestFullscreen();
      if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
    }
    async function exitFullscreen(){
      if (document.exitFullscreen) return document.exitFullscreen();
      if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
    }
    function updateFullscreenIcons(){
      const fs = !!isFullscreen();
      if (fullscreenBtn){
        fullscreenBtn.textContent = fs ? "‚§°" : "‚§¢";
        fullscreenBtn.setAttribute("aria-label", fs ? "Exit full screen" : "Enter full screen");
      }
      if (dockFullscreenBtn){
        dockFullscreenBtn.textContent = fs ? "‚§°" : "‚§¢";
        dockFullscreenBtn.setAttribute("aria-label", fs ? "Exit full screen (F)" : "Enter full screen (F)");
      }
    }

    async function toggleFullscreen(){
      try{
        if (!isFullscreen()) await enterFullscreen();
        else await exitFullscreen();
      } catch(e){
        console.warn("Fullscreen error:", e);
      } finally {
        updateFullscreenIcons();
      }
    }

    fullscreenBtn?.addEventListener("click", toggleFullscreen);
    dockFullscreenBtn?.addEventListener("click", toggleFullscreen);

    document.addEventListener("fullscreenchange", updateFullscreenIcons);
    document.addEventListener("webkitfullscreenchange", updateFullscreenIcons);
    updateFullscreenIcons();

    // ---------- DRAWER (FIXED FOR MOBILE) ----------
    function lockBodyScroll(lock){
      // prevent background page scrolling while drawer is open
      document.documentElement.style.overflow = lock ? "hidden" : "";
      document.body.style.overflow = lock ? "hidden" : "";
    }

    function openDrawer(){
      if (!drawerOverlay) return;
      drawerOverlay.style.display = "block";
      drawerOverlay.setAttribute("aria-hidden","false");
      lockBodyScroll(true);
      renderDrawerList();
      setTimeout(()=>streetSearch?.focus(), 60);
    }
    function closeDrawer(){
      if (!drawerOverlay) return;
      drawerOverlay.style.display = "none";
      drawerOverlay.setAttribute("aria-hidden","true");
      lockBodyScroll(false);
    }

    // Desktop dock list
    dockStreetsBtn?.addEventListener("click", openDrawer);
    // ‚úÖ Mobile list button
    listBtn?.addEventListener("click", openDrawer);

    closeDrawerBtn?.addEventListener("click", closeDrawer);

    // click outside drawer to close
    drawerOverlay?.addEventListener("click", (e)=>{
      if (e.target === drawerOverlay) closeDrawer();
    }, { passive:true });

    // stop tap inside drawer from closing
    document.querySelector(".streets-drawer")?.addEventListener("click", (e)=>e.stopPropagation(), { passive:true });

    function normalize(s){ return (s || "").toString().toLowerCase().trim(); }

    function renderDrawerList(){
      if (!streetsListEl) return;

      const q = normalize(streetSearch?.value);
      const rows = (Array.isArray(STREETS) ? STREETS : []).map((s, i) => ({ s, i }))
        .filter(({s})=>{
          if (!q) return true;
          const hay = normalize([s.name, s.city, s.country, s.category].filter(Boolean).join(" "));
          return hay.includes(q);
        });

      if (rows.length === 0){
        streetsListEl.innerHTML = `
          <div style="padding:10px 6px; color: rgba(203,213,225,.85); font-size: 12px;">
            No sit spots match your search.
          </div>
        `;
        return;
      }

      streetsListEl.innerHTML = rows.map(({s,i})=>{
        const loc = buildLocationText(s.city, s.country) || "Somewhere";
        const cat = s.category || "Ambient view";
        const active = i === currentStreetIndex ? "active" : "";
        return `
          <div class="street-item ${active}" data-index="${i}" role="button" tabindex="0">
            <strong>${escapeHtml(s.name || "Sit Spot")}</strong>
            <small>${escapeHtml(loc)}</small>
            <div class="pill">${escapeHtml(cat)}</div>
          </div>
        `;
      }).join("");

      streetsListEl.querySelectorAll(".street-item").forEach(el=>{
        const idx = Number(el.getAttribute("data-index"));
        el.addEventListener("click", ()=>{
          loadStreetByIndex(idx);
          closeDrawer();
        }, { passive:true });
        el.addEventListener("keydown", (e)=>{
          if (e.key === "Enter" || e.key === " "){
            e.preventDefault();
            loadStreetByIndex(idx);
            closeDrawer();
          }
        });
      });
    }

    streetSearch?.addEventListener("input", renderDrawerList);

    // ---------- TOAST ----------
    try{
      const shouldToast = window.innerWidth < 980 && !localStorage.getItem("abto_sit_toast_seen");
      if (shouldToast && deviceToast){
        deviceToast.style.display = "block";
      }
      toastClose?.addEventListener("click", ()=>{
        if (deviceToast) deviceToast.style.display = "none";
        localStorage.setItem("abto_sit_toast_seen", "1");
      });
    } catch(_) {}

    // ---------- KEYBOARD SHORTCUTS ----------
    document.addEventListener("keydown", (e)=>{
      if (e.key === "m" || e.key === "M"){
        toggleSound();
      } else if (e.key === "f" || e.key === "F"){
        toggleFullscreen();
      } else if (e.key === "l" || e.key === "L"){
        if (drawerOverlay?.style.display === "block") closeDrawer();
        else openDrawer();
      } else if (e.key === "Escape"){
        if (drawerOverlay?.style.display === "block") closeDrawer();
        if (fullMapOverlay?.style.display === "flex") hideFullMap();
      }
    });

    // ---------- ESCAPE HTML ----------
    function escapeHtml(str){
      return (str || "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ---------- INIT: choose initial street ----------
    function pickInitialStreet(){
      if (SELECTED_STREET && Array.isArray(STREETS)){
        const idx = STREETS.findIndex(s => s?._id && SELECTED_STREET?._id && s._id === SELECTED_STREET._id);
        if (idx !== -1) return idx;
      }
      return (Array.isArray(STREETS) && STREETS.length > 0) ? 0 : -1;
    }

    const initialIdx = pickInitialStreet();
    if (initialIdx !== -1){
      loadStreetByIndex(initialIdx);
    } else {
      if (streetNameEl) streetNameEl.textContent = "No Sit Spots Found";
      if (streetLocationEl) streetLocationEl.textContent = "Please add sit spots in your database.";
      if (topLocationEl) topLocationEl.textContent = "No sit spots";
      showLoading(false);
    }

    // Make sure sound UI reflects current mute state
    updateSoundUI();
  </script>
</body>
</html>
