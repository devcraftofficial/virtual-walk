<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Virtual Street Walk – Avatar Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MODEL-VIEWER for avatar only -->
  <script type="module" src="https://unpkg.com/@google/model-viewer@^3.3.0/dist/model-viewer.min.js"></script>

  <!-- MAPLIBRE only for full map -->
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

  <style>
    :root {
      --bg-page: #020617;
      --text-main: #e5e7eb;
      --accent: #38bdf8;
      --radius-lg: 18px;
    }
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #020617, #000 80%);
      font-family: system-ui, sans-serif;
      color: var(--text-main);
      overflow: hidden;
    }

    .viewer-panel {
      width: 100%;
      height: 100vh;
      position: relative;
    }
    .viewer-canvas {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
    }

    /* Mini-map */
    .mini-map {
      position: absolute;
      top: 16px; left: 16px;
      width: 100px; height: 100px;
      border-radius: 999px;
      overflow: hidden;
      background: #020617;
      border: 2px solid rgba(148,163,184,0.6);
      box-shadow: 0 12px 30px rgba(0,0,0,0.75);
      cursor: pointer;
      z-index: 50;
    }
    .mini-map img { width: 100%; height: 100%; object-fit: cover; }

    /* Full Map */
    #fullMapOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(6px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 200;
    }
    #fullMapContainer {
      width: 90%; height: 80%;
      background: #0b1120;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148,163,184,0.5);
      overflow: hidden;
    }
    #closeMapBtn {
      position: absolute;
      top: 30px; right: 40px;
      width: 48px; height: 48px;
      background: rgba(0,0,0,0.65);
      color: #fff;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 22px;
      z-index: 500;
    }

    /* Gender Switch */
    .gender-row {
      position: absolute;
      top: 16px; right: 16px;
      z-index: 60;
    }
    .gender-buttons { display: flex; gap: 6px; }
    .gender-buttons button {
      padding: 6px 10px;
      font-size: 11px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.4);
      background: rgba(0,0,0,0.4);
      color: white;
      cursor: pointer;
      backdrop-filter: blur(8px);
    }
    .gender-buttons .active {
      background: #1d4ed8;
      border-color: #3b82f6;
    }

    /* Street Info */
    .street-info {
      position: absolute;
      top: 60px; right: 16px;
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(148,163,184,0.4);
      padding: 8px 14px;
      border-radius: 12px;
      z-index: 50;
      max-width: 220px;
      font-size: 12px;
    }

    /* Video */
    #streetVideo {
      position: absolute;
      inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: 1;
      pointer-events: none;
      transition: transform 0.15s ease-out, filter 0.3s ease-out;
    }

    /* Night overlay */
    #nightOverlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.4), rgba(0,0,0,0.9));
      mix-blend-mode: multiply;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-out;
      z-index: 2;
    }

    /* Avatar */
    #avatarShadow {
      position: absolute;
      bottom: 20px; left: 50%;
      transform: translateX(-50%);
      width: 200px;
      height: 45px;
      background: radial-gradient(circle, rgba(0,0,0,0.45), transparent);
      filter: blur(12px);
      z-index: 7;
    }
    #avatarMV {
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 240px; height: 440px;
      z-index: 10;
      pointer-events: none;
    }

    /* Joystick */
    #joystickBase {
      position: absolute;
      bottom: 20px; right: 20px;
      width: 96px; height: 96px;
      border-radius: 50%;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(148,163,184,0.6);
      display: flex; justify-content: center; align-items: center;
      backdrop-filter: blur(8px);
      touch-action: none;
      z-index: 70;
    }
    #joystickKnob {
      width: 48px; height: 48px;
      background: #2563eb;
      border-radius: 50%;
      box-shadow: 0 0 0 4px rgba(37,99,235,0.4);
      touch-action: none;
    }

    /* Move joystick up on mobile */
    @media (max-width: 768px) {
      #joystickBase {
        bottom: 90px;
      }
    }

    #fadeLayer {
      position: absolute;
      inset: 0;
      background: black;
      opacity: 0;
      transition: opacity 0.7s;
      pointer-events: none;
      z-index: 200;
    }

    /* Settings button: under mini map */
    #settingsBtn {
      position: absolute;
      top: 126px;         /* 16px + 100px mini-map height + 10px gap */
      left: 16px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 60;
      font-size: 18px;
      backdrop-filter: blur(8px);
    }

    /* Settings panel */
    #settingsPanel {
      position: absolute;
      right: 16px;
      bottom: 80px;
      width: 260px;
      max-width: 70vw;
      background: rgba(15,23,42,0.96);
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: 0 18px 45px rgba(0,0,0,0.9);
      padding: 10px 12px 12px;
      z-index: 90;
      transform: translateY(12px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease-out, transform 0.18s ease-out;
      font-size: 12px;
    }
    #settingsPanel.open {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    #settingsPanel h3 {
      margin: 0 0 6px;
      font-size: 13px;
    }
    .settings-section {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(30,64,175,0.4);
    }
    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }
    .settings-row label {
      flex: 1;
      cursor: pointer;
    }
    .settings-row input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: var(--accent);
    }
  </style>
</head>

<body>

<!-- FULL MAP -->
<div id="fullMapOverlay">
  <div id="fullMapContainer"></div>
  <button id="closeMapBtn">✕</button>
</div>

<!-- MAIN VIEWER -->
<div class="viewer-panel">
  <div class="viewer-canvas">

    <!-- Mini-map -->
    <div id="miniMap" class="mini-map">
      <img src="/static/img/minimap_placeholder.png" alt="">
    </div>

    <!-- Settings button under mini-map -->
    <button id="settingsBtn" aria-label="Settings">⚙</button>

    <!-- Gender -->
    <div class="gender-row">
      <div class="gender-buttons">
        <button class="active" data-gender="male">Male</button>
        <button data-gender="female">Female</button>
      </div>
    </div>

    <!-- Street Info -->
    <div class="street-info">
      <h2 id="streetName">Select a Street</h2>
      <p id="streetLocation">Waiting…</p>
    </div>

    <!-- Walking Video -->
    <video id="streetVideo" preload="metadata" muted playsinline disablepictureinpicture>
      <source id="videoSource" src="">
    </video>

    <!-- Night overlay -->
    <div id="nightOverlay"></div>

    <!-- Avatar -->
    <div id="avatarShadow"></div>
    <model-viewer id="avatarMV" src="/static/avatars/male/idle.glb"
      autoplay shadow-intensity="1" disable-zoom disable-pan>
    </model-viewer>

    <!-- Joystick -->
    <div id="joystickBase">
      <div id="joystickKnob"></div>
    </div>

    <!-- Settings panel -->
    <div id="settingsPanel" aria-label="View settings">
      <h3>View settings</h3>

      <div class="settings-section">
        <strong style="font-size:11px;">Video</strong>
        <div class="settings-row">
          <label for="setVideoMuted">Mute video</label>
          <input type="checkbox" id="setVideoMuted" checked>
        </div>
        <div class="settings-row">
          <label for="setVideoSlow">Slow motion</label>
          <input type="checkbox" id="setVideoSlow">
        </div>
      </div>

      <div class="settings-section">
        <strong style="font-size:11px;">Avatar</strong>
        <div class="settings-row">
          <label for="setHideAvatar">Hide avatar</label>
          <input type="checkbox" id="setHideAvatar">
        </div>
        <div class="settings-row">
          <label for="setWalkNoAvatar">Walk without avatar</label>
          <input type="checkbox" id="setWalkNoAvatar">
        </div>
      </div>

      <div class="settings-section">
        <strong style="font-size:11px;">Environment</strong>
        <div class="settings-row">
          <label for="setNightMode">Night view</label>
          <input type="checkbox" id="setNightMode">
        </div>
      </div>
    </div>

    <!-- Fade -->
    <div id="fadeLayer"></div>

  </div>
</div>

<audio id="footstepAudio" src="/static/audio/footsteps_loop.wav" loop preload="auto"></audio>

<script id="streets-data" type="application/json">
  {{ streets | tojson | safe }}
</script>

<script id="selected-street-data" type="application/json">
  {{ selected_street | tojson | safe if selected_street else 'null' }}
</script>

<script type="module">
/* ================== GLOBALS ================== */
const STREETS = JSON.parse(document.getElementById('streets-data').textContent);
const SELECTED = JSON.parse(document.getElementById('selected-street-data').textContent);

const video = document.getElementById("streetVideo");
const vsrc = document.getElementById("videoSource");
const avatar = document.getElementById("avatarMV");
const shadowEl = document.getElementById("avatarShadow");
const fadeLayer = document.getElementById("fadeLayer");
const nightOverlay = document.getElementById("nightOverlay");
const footstepAudio = document.getElementById("footstepAudio");

let currentIndex = -1;
let currentVideos = [];
let currentVideoIndex = 0;
let currentGender = "male";

let yawCurrent = 180;
let yawTarget = 180;
let currentDir = 0;
let joyDir = 0;
let reversePlaying = false;
let headBob = 0, bobDirection = 1;
let strafe = 0;
let strafeOffset = 0;
const STRAFE_MAX = 120;

/* ================== VIDEO LOADING ================== */
function loadStreet(street) {
  document.getElementById("streetName").textContent = street.name || "Untitled Street";
  document.getElementById("streetLocation").textContent =
    `${street.city || ""}${street.city && street.country ? ", " : ""}${street.country || ""}`;

  currentVideos = [];
  currentVideoIndex = 0;

  if (Array.isArray(street.videos) && street.videos.length) {
    currentVideos = street.videos.map(v => v.url).filter(Boolean);
  } else if (street.videoUrl) {
    currentVideos = [street.videoUrl];
  }

  const url = currentVideos[0] || "";
  vsrc.src = url;
  video.load();
  video.currentTime = 0;
  video.pause();
}

function loadStreetByIndex(i) {
  if (i < 0 || i >= STREETS.length) return;
  currentIndex = i;
  loadStreet(STREETS[i]);
}

/* ================== PLAYBACK ================== */
function playForward() {
  reversePlaying = false;
  const slow = document.getElementById("setVideoSlow").checked;
  video.playbackRate = slow ? 0.5 : 1;
  video.play().catch(() => {});
}

function playReverse() {
  reversePlaying = true;
  video.pause();

  function frameBack() {
    if (!reversePlaying) return;
    const slow = document.getElementById("setVideoSlow").checked;
    const step = slow ? 0.008 : 0.016;
    video.currentTime -= step;
    if (video.currentTime <= 0.02) {
      video.currentTime = video.duration || 0;
    }
    requestAnimationFrame(frameBack);
  }
  requestAnimationFrame(frameBack);
}

function setAvatarState() {
  const state = currentDir === 0 ? "idle" : "walk";
  avatar.src = `/static/avatars/${currentGender}/${state}.glb`;
}

/* Footsteps */
function updateFootsteps() {
  if (currentDir !== 0) {
    if (footstepAudio.paused) {
      footstepAudio.play().catch(() => {});
    }
  } else {
    footstepAudio.pause();
    footstepAudio.currentTime = 0;
  }
}

/* ================== NEAREST TELEPORT ================== */
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lat2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
    Math.sin(dLon/2)**2;
  return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function nearestStreetIndex() {
  const base = STREETS[currentIndex];
  if (!base) return -1;
  let best = -1, bestDist = Infinity;
  STREETS.forEach((s, i) => {
    if (i === currentIndex) return;
    const d = haversine(parseFloat(base.lat), parseFloat(base.lng),
                        parseFloat(s.lat), parseFloat(s.lng));
    if (!Number.isNaN(d) && d < bestDist) {
      bestDist = d;
      best = i;
    }
  });
  return best;
}

async function teleportNearest() {
  const next = nearestStreetIndex();
  if (next === -1) return;
  fadeLayer.style.opacity = "1";
  await new Promise(r => setTimeout(r, 450));
  loadStreetByIndex(next);
  fadeLayer.style.opacity = "0";
}

/* ================== VIDEO ENDED ================== */
video.addEventListener("ended", () => {
  if (currentVideos.length > 1 && currentVideoIndex < currentVideos.length - 1) {
    currentVideoIndex++;
    vsrc.src = currentVideos[currentVideoIndex] || "";
    video.load();
    video.currentTime = 0;
    if (currentDir === 1) playForward();
    return;
  }
  reversePlaying = false;
  currentDir = 0;
  video.pause();
  setAvatarState();
  updateFootsteps();
  teleportNearest();
});

/* ================== KEYBOARD ================== */
window.addEventListener("keydown", e => {
  const k = e.key.toLowerCase();
  if (k === "arrowleft" || k === "a") yawTarget -= 10;
  else if (k === "arrowright" || k === "d") yawTarget += 10;
  else if (k === "arrowup" || k === "w") {
    currentDir = 1;
    playForward();
    setAvatarState();
    updateFootsteps();
  } else if (k === "arrowdown" || k === "s") {
    currentDir = -1;
    playReverse();
    setAvatarState();
    updateFootsteps();
  } else if (k === "q") {
    strafe = -1;
  } else if (k === "e") {
    strafe = 1;
  }
});

window.addEventListener("keyup", e => {
  const k = e.key.toLowerCase();
  if (["arrowup","w","arrowdown","s"].includes(k)) {
    currentDir = 0;
    reversePlaying = false;
    video.pause();
    setAvatarState();
    updateFootsteps();
  }
  if (k === "q" || k === "e") {
    strafe = 0;
  }
});

/* ================== GENDER SWITCH ================== */
document.querySelectorAll(".gender-buttons button").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".gender-buttons button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentGender = btn.dataset.gender;
    setAvatarState();
  });
});

/* ================== JOYSTICK ================== */
const joystickBase = document.getElementById("joystickBase");
const joystickKnob = document.getElementById("joystickKnob");
let joyActive = false;

function joyMove(ev) {
  const rect = joystickBase.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;
  const dx = ev.clientX - cx;
  const dy = ev.clientY - cy;
  const r = rect.width/2;

  const nx = dx / r;
  const ny = dy / r;

  joystickKnob.style.transform = `translate(${nx*30}px, ${ny*30}px)`;

  if (Math.abs(ny) > 0.2) currentDir = ny < 0 ? 1 : -1;
  else currentDir = 0;

  if (Math.abs(nx) > 0.2) strafe = nx > 0 ? 1 : -1;
  else strafe = 0;

  if (currentDir === 1) playForward();
  else if (currentDir === -1) playReverse();
  else {
    reversePlaying = false;
    video.pause();
  }
  setAvatarState();
  updateFootsteps();
}

joystickBase.addEventListener("pointerdown", e => {
  joyActive = true;
  joystickBase.setPointerCapture(e.pointerId);
  joyMove(e);
});
joystickBase.addEventListener("pointermove", e => { if (joyActive) joyMove(e); });
joystickBase.addEventListener("pointerup", () => {
  joyActive = false;
  joystickKnob.style.transform = "translate(0,0)";
  currentDir = 0;
  strafe = 0;
  reversePlaying = false;
  video.pause();
  setAvatarState();
  updateFootsteps();
});
joystickBase.addEventListener("pointercancel", () => {
  joyActive = false;
  joystickKnob.style.transform = "translate(0,0)";
  currentDir = 0;
  strafe = 0;
  reversePlaying = false;
  video.pause();
  setAvatarState();
  updateFootsteps();
});

/* ================== SETTINGS PANEL ================== */
const settingsBtn = document.getElementById("settingsBtn");
const settingsPanel = document.getElementById("settingsPanel");
const setVideoMuted = document.getElementById("setVideoMuted");
const setVideoSlow = document.getElementById("setVideoSlow");
const setHideAvatar = document.getElementById("setHideAvatar");
const setWalkNoAvatar = document.getElementById("setWalkNoAvatar");
const setNightMode = document.getElementById("setNightMode");

settingsBtn.addEventListener("click", () => {
  settingsPanel.classList.toggle("open");
});

/* Video settings */
setVideoMuted.addEventListener("change", () => {
  video.muted = setVideoMuted.checked;
});
setVideoSlow.addEventListener("change", () => {
  if (!video.paused && !reversePlaying) {
    video.playbackRate = setVideoSlow.checked ? 0.5 : 1;
  }
});

/* Avatar settings */
function applyAvatarVisibility() {
  const hide = setHideAvatar.checked || setWalkNoAvatar.checked;
  avatar.style.display = hide ? "none" : "block";
  shadowEl.style.display = hide ? "none" : "block";
}
setHideAvatar.addEventListener("change", () => {
  if (setHideAvatar.checked) setWalkNoAvatar.checked = false;
  applyAvatarVisibility();
});
setWalkNoAvatar.addEventListener("change", () => {
  if (setWalkNoAvatar.checked) setHideAvatar.checked = false;
  applyAvatarVisibility();
});

/* Night mode */
setNightMode.addEventListener("change", () => {
  nightOverlay.style.opacity = setNightMode.checked ? "1" : "0";
});

/* defaults */
video.muted = true;

/* ================== ANIMATION LOOP ================== */
function tick() {
  yawCurrent += (yawTarget - yawCurrent) * 0.18;
  avatar.orientation = `0deg 0deg ${yawCurrent}deg`;

  if (currentDir !== 0) {
    headBob += bobDirection * 0.25;
    if (headBob > 2 || headBob < -2) bobDirection *= -1;
  } else {
    headBob *= 0.85;
  }

  if (strafe !== 0) {
    strafeOffset += strafe * 4;
    strafeOffset = Math.max(-STRAFE_MAX, Math.min(STRAFE_MAX, strafeOffset));
  } else {
    strafeOffset *= 0.9;
  }

  video.style.transform = `translateY(${headBob}px)`;
  avatar.style.transform =
    `translate(calc(-50% + ${strafeOffset}px), -15px)`;

  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

/* ================== MAPLIBRE (LAZY) ================== */
let fullMapReady = false;
let fullMap;

function loadMap() {
  if (fullMapReady) return;
  fullMap = new maplibregl.Map({
    container: "fullMapContainer",
    style: "https://demotiles.maplibre.org/style.json",
    center: [0, 20],
    zoom: 2
  });
  fullMap.addControl(new maplibregl.NavigationControl());

  STREETS.forEach((s, i) => {
    const m = new maplibregl.Marker().setLngLat([parseFloat(s.lng), parseFloat(s.lat)]).addTo(fullMap);
    m.getElement().addEventListener("click", () => {
      loadStreetByIndex(i);
      document.getElementById("fullMapOverlay").style.display = "none";
    });
  });

  fullMapReady = true;
}

document.getElementById("miniMap").onclick = () => {
  document.getElementById("fullMapOverlay").style.display = "flex";
  loadMap();
};
document.getElementById("closeMapBtn").onclick = () => {
  document.getElementById("fullMapOverlay").style.display = "none";
};

/* ================== INITIAL STREET ================== */
if (SELECTED) {
  const idx = STREETS.findIndex(s => s._id === SELECTED._id);
  loadStreetByIndex(idx !== -1 ? idx : 0);
} else if (Array.isArray(STREETS) && STREETS.length > 0) {
  loadStreetByIndex(0);
}
</script>
</body>
</html>
