<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Virtual Street Walk â€“ Avatar Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- MODEL-VIEWER -->
  <script type="module" src="https://unpkg.com/@google/model-viewer@^3.3.0/dist/model-viewer.min.js"></script>

  <!-- MAPLIBRE -->
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

  <style>
    :root {
      --bg-page: #020617;
      --text-main: #e5e7eb;
      --accent: #38bdf8;
      --radius-lg: 18px;
    }
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #020617, #000 80%);
      font-family: system-ui, sans-serif;
      color: var(--text-main);
      overflow: hidden;
    }

    .viewer-panel {
      width: 100%;
      height: 100vh;
      position: relative;
    }
    .viewer-canvas {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
    }

    .mini-map {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 100px;
      height: 100px;
      border-radius: 999px;
      overflow: hidden;
      background: #020617;
      border: 2px solid rgba(148,163,184,0.6);
      box-shadow: 0 12px 30px rgba(0,0,0,0.75);
      cursor: pointer;
      z-index: 50;
    }
    .mini-map img { width: 100%; height: 100%; object-fit: cover; }

    #fullMapOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(6px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 200;
    }
    #fullMapContainer {
      width: 90%;
      height: 80%;
      background: #0b1120;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148,163,184,0.5);
      overflow: hidden;
    }
    #closeMapBtn {
      position: absolute;
      top: 30px;
      right: 40px;
      width: 48px;
      height: 48px;
      background: rgba(0,0,0,0.65);
      color: #fff;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 22px;
      z-index: 500;
    }

    .gender-row {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 60;
    }
    .gender-buttons {
      display: flex;
      gap: 6px;
    }
    .gender-buttons button {
      padding: 6px 10px;
      font-size: 11px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.4);
      background: rgba(0,0,0,0.4);
      color: white;
      cursor: pointer;
      backdrop-filter: blur(8px);
    }
    .gender-buttons .active {
      background: #1d4ed8;
      border-color: #3b82f6;
    }

    .street-info {
      position: absolute;
      top: 60px;
      right: 16px;
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(148,163,184,0.4);
      padding: 8px 14px;
      border-radius: 12px;
      z-index: 50;
      max-width: 220px;
      font-size: 12px;
    }

    #streetVideo {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
      pointer-events: none;
      transition: transform 0.12s ease-out, opacity 0.2s ease-out;
    }

    #nightOverlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.4), rgba(0,0,0,0.9));
      mix-blend-mode: multiply;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-out;
      z-index: 2;
    }

    #avatarShadow {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      height: 45px;
      background: radial-gradient(circle, rgba(0,0,0,0.45), transparent);
      filter: blur(12px);
      z-index: 7;
    }
    #avatarMV {
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 240px;
      height: 440px;
      z-index: 10;
      pointer-events: none;
    }

    #avatarSpeech,
    #streetSpeech {
      font-size: 12px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease-out, transform 0.2s ease-out;
      box-shadow: 0 18px 45px rgba(0,0,0,0.8);
      border: 1px solid rgba(148,163,184,0.7);
    }
    #avatarSpeech {
      position: absolute;
      bottom: 410px;
      left: 50%;
      transform: translateX(-50%) translateY(6px);
      max-width: 260px;
      padding: 6px 10px;
      background: rgba(15,23,42,0.96);
      border-radius: 999px;
      color: #e5e7eb;
      z-index: 11;
    }
    #streetSpeech {
      position: absolute;
      bottom: 420px;
      right: 40px;
      max-width: 240px;
      padding: 6px 10px;
      background: rgba(30,41,59,0.95);
      border-radius: 12px;
      color: #f1f5f9;
      z-index: 12;
    }
    #avatarSpeech.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(-4px);
    }
    #streetSpeech.visible {
      opacity: 1;
      transform: translateY(-4px);
    }

    #joystickBase {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 96px;
      height: 96px;
      border-radius: 50%;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(148,163,184,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(8px);
      touch-action: none;
      z-index: 70;
    }
    #joystickKnob {
      width: 48px;
      height: 48px;
      background: #2563eb;
      border-radius: 50%;
      box-shadow: 0 0 0 4px rgba(37,99,235,0.4);
      touch-action: none;
    }

    @media (max-width: 768px) {
      #joystickBase { bottom: 90px; }
    }

    #fadeLayer {
      position: absolute;
      inset: 0;
      background: black;
      opacity: 0;
      transition: opacity 0.5s;
      pointer-events: none;
      z-index: 200;
    }

    #settingsBtn {
      position: absolute;
      top: 190px;
      left: 16px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 60;
      font-size: 18px;
      backdrop-filter: blur(8px);
    }

    #settingsPanel {
      position: absolute;
      right: 16px;
      bottom: 80px;
      width: 260px;
      max-width: 70vw;
      background: rgba(15,23,42,0.96);
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: 0 18px 45px rgba(0,0,0,0.9);
      padding: 10px 12px 12px;
      z-index: 90;
      transform: translateY(12px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease-out, transform 0.18s ease-out;
      font-size: 12px;
    }
    #settingsPanel.open {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .settings-section {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid rgba(30,64,175,0.5);
    }
    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      gap: 8px;
      font-size: 11px;
    }

    #streetPopup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    #streetPopupCard {
      width: 90%;
      max-width: 420px;
      background: rgba(15,23,42,0.92);
      border: 1px solid rgba(148,163,184,0.4);
      padding: 26px;
      border-radius: 18px;
      animation: popupFade 0.3s ease;
    }
    #streetPopupCard h2 {
      margin: 0 0 10px 0;
      font-size: 22px;
      color: var(--accent);
    }
    #streetPopupCard p {
      margin: 6px 0;
      font-size: 14px;
      color: var(--text-main);
    }
    #popupClose {
      margin-top: 16px;
      padding: 10px 22px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: #000;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
    }
    @keyframes popupFade {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0);   }
    }

    .map-marker-selected {
      width: 26px !important;
      height: 26px !important;
      background: #38bdf8 !important;
      border-radius: 50%;
      border: 3px solid white !important;
      box-shadow: 0 0 18px #38bdf8, 0 0 32px #38bdf8;
      animation: markerPulse 1.4s infinite ease-in-out;
    }
    @keyframes markerPulse {
      0%   { transform: scale(1);   opacity: 1;   }
      50%  { transform: scale(1.3); opacity: 0.7; }
      100% { transform: scale(1);   opacity: 1;   }
    }

    /* First-load video overlay */
    #videoLoading {
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.9);
      z-index:5;
      pointer-events:none;
    }
    #videoLoadingSpinner{
      width:36px;height:36px;border-radius:50%;
      border:3px solid rgba(148,163,184,0.4);
      border-top-color:#38bdf8;
      animation:spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>

<div id="fullMapOverlay">
  <div id="fullMapContainer"></div>
  <button id="closeMapBtn">âœ•</button>
</div>

<div class="viewer-panel">
  <div class="viewer-canvas" id="viewerCanvas">

    <div id="miniMap" class="mini-map">
      <img src="/static/img/minimap_placeholder.png" alt="">
    </div>

    <div class="gender-row">
      <div class="gender-buttons">
        <button class="active" data-gender="male">Male</button>
        <button data-gender="female">Female</button>
      </div>
    </div>

    <div class="street-info">
      <h2 id="streetName">Select a Street</h2>
      <p id="streetLocation">Waitingâ€¦</p>
    </div>

    <button id="settingsBtn" aria-label="Settings">âš™</button>

    <video id="streetVideo" preload="metadata" muted playsinline disablepictureinpicture>
      <source id="videoSource" src="">
    </video>

    <!-- first-load overlay -->
    <div id="videoLoading">
      <div id="videoLoadingSpinner"></div>
    </div>

    <div id="nightOverlay"></div>

    <div id="avatarShadow"></div>
    <model-viewer id="avatarMV"
      src="/static/avatars/male/idle.glb"
      autoplay
      shadow-intensity="1"
      disable-zoom
      disable-pan>
    </model-viewer>

    <div id="avatarSpeech"></div>
    <div id="streetSpeech"></div>

    <div id="joystickBase">
      <div id="joystickKnob"></div>
    </div>

    <div id="settingsPanel" aria-label="View settings">
      <h3 style="margin:0 0 6px 0;font-size:13px;">View settings</h3>

      <div class="settings-section">
        <strong style="font-size:11px;">Video</strong>
        <div class="settings-row">
          <label for="setVideoMuted">Mute video</label>
          <input type="checkbox" id="setVideoMuted" checked>
        </div>
        <div class="settings-row">
          <label for="setVideoSlow">Slow motion</label>
          <input type="checkbox" id="setVideoSlow">
        </div>
      </div>

      <div class="settings-section">
        <strong style="font-size:11px;">Avatar</strong>
        <div class="settings-row">
          <label for="setHideAvatar">Hide avatar</label>
          <input type="checkbox" id="setHideAvatar">
        </div>
        <div class="settings-row">
          <label for="setWalkNoAvatar">Walk without avatar</label>
          <input type="checkbox" id="setWalkNoAvatar">
        </div>
      </div>

      <div class="settings-section">
        <strong style="font-size:11px;">Environment</strong>
        <div class="settings-row">
          <label for="setNightMode">Night view</label>
          <input type="checkbox" id="setNightMode">
        </div>
      </div>
    </div>

    <div id="streetPopup">
      <div id="streetPopupCard">
        <h2 id="popupTitle"></h2>
        <p id="popupCity"></p>
        <p id="popupCategory"></p>
        <p id="popupDescription"></p>
        <button id="popupClose">Close</button>
      </div>
    </div>

    <div id="fadeLayer"></div>
  </div>
</div>

<audio id="footstepAudio" src="/static/audio/footsteps_loop.wav" loop preload="auto"></audio>
<audio id="voiceAudio" preload="auto"></audio>

<script id="streets-data" type="application/json">
  {{ streets | tojson | safe }}
</script>

<script id="selected-street-data" type="application/json">
  {{ selected_street | tojson | safe if selected_street else 'null' }}
</script>

<script type="module">
  let markerEls = [];

  const STREETS = JSON.parse(document.getElementById("streets-data").textContent);
  const SELECTED = JSON.parse(document.getElementById("selected-street-data").textContent);

  const video         = document.getElementById("streetVideo");
  const vsrc          = document.getElementById("videoSource");
  const avatar        = document.getElementById("avatarMV");
  const shadowEl      = document.getElementById("avatarShadow");
  const fadeLayer     = document.getElementById("fadeLayer");
  const nightOverlay  = document.getElementById("nightOverlay");
  const footstepAudio = document.getElementById("footstepAudio");
  const videoLoading  = document.getElementById("videoLoading");

  const speechEl        = document.getElementById("avatarSpeech");
  const streetSpeechEl  = document.getElementById("streetSpeech");
  const voiceAudio      = document.getElementById("voiceAudio");

  const settingsBtn      = document.getElementById("settingsBtn");
  const settingsPanel    = document.getElementById("settingsPanel");
  const setVideoMuted    = document.getElementById("setVideoMuted");
  const setVideoSlow     = document.getElementById("setVideoSlow");
  const setHideAvatar    = document.getElementById("setHideAvatar");
  const setWalkNoAvatar  = document.getElementById("setWalkNoAvatar");
  const setNightMode     = document.getElementById("setNightMode");

  const joystickBase = document.getElementById("joystickBase");
  const joystickKnob = document.getElementById("joystickKnob");

  let currentIndex       = -1;
  let currentVideos      = [];
  let currentVideoIndex  = 0;
  let currentGender      = "male";

  let yawCurrent   = 180;
  let yawTarget    = 180;
  let currentDir   = 0;
  let reversePlaying = false;
  let headBob      = 0;
  let bobDirection = 1;
  let strafe       = 0;
  let strafeOffset = 0;
  const STRAFE_MAX = 120;

  let joyActive    = false;
  let fullMapReady = false;
  let fullMap;

  let isFirstStreetLoad = true;

  const avatarSources = {
    male: {
      idle: "/static/avatars/male/idle.glb",
      walk: "/static/avatars/male/walk.glb"
    },
    female: {
      idle: "/static/avatars/female/idle.glb",
      walk: "/static/avatars/female/walk.glb"
    }
  };

  function preloadAvatars() {
    Object.values(avatarSources).forEach(group => {
      Object.values(group).forEach(url => {
        fetch(url).catch(() => {});
      });
    });
  }
  preloadAvatars();

  const dialogues = {
    male: [
      { q: "Good morning!", a: "Good morning! Have a nice day!", qFile: "/static/audio/greetings/male/male_greet_1.mp3", aFile: "/static/audio/street/reply_1.mp3" },
      { q: "Hello there!", a: "Hi! Welcome to the street!", qFile: "/static/audio/greetings/male/male_greet_2.mp3", aFile: "/static/audio/street/reply_2.mp3" },
      { q: "Hey, ready for a walk?", a: "Yes! Enjoy your walk!", qFile: "/static/audio/greetings/male/male_greet_3.mp3", aFile: "/static/audio/street/reply_3.mp3" },
      { q: "Nice to see you here!", a: "Nice to see you too, enjoy this place!", qFile: "/static/audio/greetings/male/male_greet_4.mp3", aFile: "/static/audio/street/reply_4.mp3" },
      { q: "Beautiful morning, right?", a: "Perfect time for a street walk!", qFile: "/static/audio/greetings/male/male_greet_5.mp3", aFile: "/static/audio/street/reply_5.mp3" },
      { q: "Ready to explore this street?", a: "Of course, letâ€™s see whatâ€™s around!", qFile: "/static/audio/greetings/male/male_greet_6.mp3", aFile: "/static/audio/street/reply_6.mp3" },
      { q: "Do you like this street?", a: "Yes, itâ€™s one of my favorites!", qFile: "/static/audio/greetings/male/male_greet_7.mp3", aFile: "/static/audio/street/reply_7.mp3" },
      { q: "Thanks for walking with me.", a: "Anytime! Keep exploring!", qFile: "/static/audio/greetings/male/male_greet_8.mp3", aFile: "/static/audio/street/reply_8.mp3" },
      { q: "How is your day going?", a: "Pretty good, hope yours is great too!", qFile: "/static/audio/greetings/male/male_greet_9.mp3", aFile: "/static/audio/street/reply_9.mp3" },
      { q: "Letâ€™s keep moving forward.", a: "Sure, the next street looks amazing!", qFile: "/static/audio/greetings/male/male_greet_10.mp3", aFile: "/static/audio/street/reply_10.mp3" }
    ],
    female: [
      { q: "Hello, how are you today?", a: "Iâ€™m good! Have a lovely day!", qFile: "/static/audio/greetings/female/female_greet_1.mp3", aFile: "/static/audio/street/reply_1.mp3" },
      { q: "Hi, letâ€™s take a walk.", a: "Sure! Welcome to the street!", qFile: "/static/audio/greetings/female/female_greet_2.mp3", aFile: "/static/audio/street/reply_2.mp3" },
      { q: "Good morning!", a: "Good morning! Enjoy your walk!", qFile: "/static/audio/greetings/female/female_greet_3.mp3", aFile: "/static/audio/street/reply_3.mp3" },
      { q: "Nice to meet you here!", a: "Nice to meet you too, enjoy this view!", qFile: "/static/audio/greetings/female/female_greet_4.mp3", aFile: "/static/audio/street/reply_4.mp3" },
      { q: "Itâ€™s a beautiful day.", a: "Yes, perfect weather for walking!", qFile: "/static/audio/greetings/female/female_greet_5.mp3", aFile: "/static/audio/street/reply_5.mp3" },
      { q: "Ready to explore this street?", a: "Definitely, letâ€™s look around!", qFile: "/static/audio/greetings/female/female_greet_6.mp3", aFile: "/static/audio/street/reply_6.mp3" },
      { q: "Do you like this place?", a: "Yes, it feels so cozy!", qFile: "/static/audio/greetings/female/female_greet_7.mp3", aFile: "/static/audio/street/reply_7.mp3" },
      { q: "Thanks for joining me.", a: "Youâ€™re welcome, letâ€™s keep going!", qFile: "/static/audio/greetings/female/female_greet_8.mp3", aFile: "/static/audio/street/reply_8.mp3" },
      { q: "Howâ€™s your day so far?", a: "Pretty good, hope youâ€™re doing well too!", qFile: "/static/audio/greetings/female/female_greet_9.mp3", aFile: "/static/audio/street/reply_9.mp3" },
      { q: "Letâ€™s walk a bit more.", a: "Yes, the next corner looks interesting!", qFile: "/static/audio/greetings/female/female_greet_10.mp3", aFile: "/static/audio/street/reply_10.mp3" }
    ]
  };

  const teleportLines = {
    male: [
      { text: "Teleporting to the next street.", file: "/static/audio/teleport/male_tp_1.mp3" },
      { text: "Jumping to another street!", file: "/static/audio/teleport/male_tp_2.mp3" },
      { text: "Hold tight, moving ahead!", file: "/static/audio/teleport/male_tp_3.mp3" },
      { text: "Letâ€™s explore the next street.", file: "/static/audio/teleport/male_tp_4.mp3" },
      { text: "Next stop, a new street!", file: "/static/audio/teleport/male_tp_5.mp3" }
    ],
    female: [
      { text: "Teleporting to the next street.", file: "/static/audio/teleport/female_tp_1.mp3" },
      { text: "Jumping to another cute street!", file: "/static/audio/teleport/female_tp_2.mp3" },
      { text: "Hold on, weâ€™re moving ahead!", file: "/static/audio/teleport/female_tp_3.mp3" },
      { text: "Letâ€™s explore the next street together.", file: "/static/audio/teleport/female_tp_4.mp3" },
      { text: "New street coming up!", file: "/static/audio/teleport/female_tp_5.mp3" }
    ]
  };

  function preloadVoices() {
    Object.values(dialogues).forEach(list => {
      list.forEach(pair => {
        if (pair.qFile) new Audio(pair.qFile);
        if (pair.aFile) new Audio(pair.aFile);
      });
    });
    Object.values(teleportLines).forEach(list => {
      list.forEach(line => {
        if (line.file) new Audio(line.file);
      });
    });
  }
  preloadVoices();

  let speechTimeout       = null;
  let streetSpeechTimeout = null;

  function showAvatarSpeech(text, duration = 2300) {
    speechEl.textContent = text;
    speechEl.classList.add("visible");
    clearTimeout(speechTimeout);
    speechTimeout = setTimeout(() => {
      speechEl.classList.remove("visible");
    }, duration);
  }

  function showStreetSpeech(text, duration = 2300) {
    streetSpeechEl.textContent = text;
    streetSpeechEl.classList.add("visible");
    clearTimeout(streetSpeechTimeout);
    streetSpeechTimeout = setTimeout(() => {
      streetSpeechEl.classList.remove("visible");
    }, duration);
  }

  function playVoice(file) {
    if (!file) return;
    voiceAudio.pause();
    voiceAudio.currentTime = 0;
    voiceAudio.src = file;
    voiceAudio.play().catch(() => {});
  }

  function speakAvatarLine(text, file, duration) {
    showAvatarSpeech(text, duration || 2200);
    playVoice(file);
  }

  function speakStreetLine(text, file, duration) {
    showStreetSpeech(text, duration || 2200);
    playVoice(file);
  }

  const GREETING_COOLDOWN = 6000;
  let lastGreetingAt = 0;

  function triggerGreeting() {
    const now = Date.now();
    if (now - lastGreetingAt < GREETING_COOLDOWN) return;
    const list = dialogues[currentGender] || dialogues.male;
    if (!list.length) return;
    const pair = list[Math.floor(Math.random() * list.length)];
    lastGreetingAt = now;
    speakAvatarLine(pair.q, pair.qFile, 1600);
    if (pair.a && pair.aFile) {
      setTimeout(() => {
        speakStreetLine(pair.a, pair.aFile, 2000);
      }, 1400);
    }
  }

  function onWalkStart() {
    triggerGreeting();
  }

  function buildVideoList(street) {
    const vids = [];
    if (Array.isArray(street.videos) && street.videos.length) {
      street.videos.forEach(v => { if (v && v.url) vids.push(v.url); });
    }
    if (!vids.length && street.videoUrl) vids.push(street.videoUrl);
    return vids;
  }

  function preloadNextStreetVideo(fromIndex) {
    const base = STREETS[fromIndex];
    if (!base) return;
    const next = nearestStreetIndex();
    if (next === -1 || !STREETS[next]) return;
    const s = STREETS[next];
    const vids = buildVideoList(s);
    if (!vids.length) return;
    const url = vids[0];

    const link = document.createElement("link");
    link.rel = "preload";
    link.as = "video";
    link.href = url;
    document.head.appendChild(link);

  }

  function loadStreet(street) {
    const nameEl = document.getElementById("streetName");
    const locEl  = document.getElementById("streetLocation");

    nameEl.textContent = street.name || "Untitled Street";
    locEl.textContent =
      (street.city || "") +
      (street.city && street.country ? ", " : "") +
      (street.country || "");

    currentVideos = buildVideoList(street);
    currentVideoIndex = 0;

    if (isFirstStreetLoad) {
      videoLoading.style.display = "flex";
      video.style.opacity = "0";
    }

    const url = currentVideos[0] || "";
    if (vsrc.src !== url) {
      vsrc.src = url;
      video.load();
    }
    video.currentTime = 0;
    video.pause();
  }

  function loadStreetByIndex(i) {
    if (i < 0 || i >= STREETS.length) return;
    currentIndex = i;
    loadStreet(STREETS[i]);
    updateMapMarkerHighlight();

    if (fullMap && STREETS[i]) {
      const s = STREETS[i];
      fullMap.flyTo({
        center: [parseFloat(s.lng), parseFloat(s.lat)],
        zoom: 12,
        speed: 0.9
      });
    }

    preloadNextStreetVideo(i);
  }

  function playForward() {
    reversePlaying = false;
    video.playbackRate = setVideoSlow.checked ? 0.5 : 1;
    video.play().catch(() => {});
  }

  function playReverse() {
    reversePlaying = true;
    video.pause();
    function frameBack() {
      if (!reversePlaying) return;
      const step = setVideoSlow.checked ? 0.008 : 0.016;
      video.currentTime -= step;
      if (video.currentTime <= 0.02) {
        video.currentTime = video.duration || 0;
      }
      requestAnimationFrame(frameBack);
    }
    requestAnimationFrame(frameBack);
  }

  function setAvatarState() {
    const state = currentDir === 0 ? "idle" : "walk";
    const srcSet = avatarSources[currentGender] || avatarSources.male;
    const src = srcSet[state];
    if (src && avatar.src !== src) avatar.src = src;
  }

  function updateFootsteps() {
    if (currentDir !== 0) {
      if (footstepAudio.paused) {
        footstepAudio.play().catch(() => {});
      }
    } else {
      footstepAudio.pause();
      footstepAudio.currentTime = 0;
    }
  }

  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  function nearestStreetIndex() {
    const base = STREETS[currentIndex];
    if (!base) return -1;
    let best = -1;
    let bestDist = Infinity;
    const baseLat = parseFloat(base.lat);
    const baseLng = parseFloat(base.lng);

    STREETS.forEach((s, i) => {
      if (i === currentIndex) return;
      const d = haversine(
        baseLat,
        baseLng,
        parseFloat(s.lat),
        parseFloat(s.lng)
      );
      if (!Number.isNaN(d) && d < bestDist) {
        bestDist = d;
        best = i;
      }
    });
    return best;
  }

  async function teleportNearest() {
    const next = nearestStreetIndex();
    if (next === -1) return;

    const list = teleportLines[currentGender] || teleportLines.male;
    if (list && list.length) {
      const line = list[Math.floor(Math.random() * list.length)];
      speakAvatarLine(line.text, line.file, 2200);
    }

    fadeLayer.style.opacity = "1";
    await new Promise(r => setTimeout(r, 350));
    loadStreetByIndex(next);
    fadeLayer.style.opacity = "0";
  }

  video.addEventListener("ended", () => {
    if (currentVideos.length > 1 && currentVideoIndex < currentVideos.length - 1) {
      currentVideoIndex++;
      const nextUrl = currentVideos[currentVideoIndex] || "";
      vsrc.src = nextUrl;
      video.load();
      video.currentTime = 0;
      if (currentDir === 1) playForward();
      return;
    }
    reversePlaying = false;
    currentDir = 0;
    video.pause();
    setAvatarState();
    updateFootsteps();
    teleportNearest();
  });

  // hide first-load overlay when the first video is ready or fails
  video.addEventListener("loadeddata", () => {
    video.style.opacity = "1";
    if (isFirstStreetLoad) {
      videoLoading.style.display = "none";
      isFirstStreetLoad = false;
    }
  });
  video.addEventListener("error", () => {
    if (isFirstStreetLoad) {
      videoLoading.style.display = "none";
      isFirstStreetLoad = false;
    }
  });

  window.addEventListener("keydown", e => {
    const k = e.key.toLowerCase();
    if (k === "arrowleft" || k === "a") {
      yawTarget -= 10;
    } else if (k === "arrowright" || k === "d") {
      yawTarget += 10;
    } else if (k === "arrowup" || k === "w") {
      const wasStopped = currentDir === 0;
      currentDir = 1;
      playForward();
      setAvatarState();
      updateFootsteps();
      if (wasStopped) onWalkStart();
    } else if (k === "arrowdown" || k === "s") {
      currentDir = -1;
      playReverse();
      setAvatarState();
      updateFootsteps();
    } else if (k === "q") {
      strafe = -1;
    } else if (k === "e") {
      strafe = 1;
    }
  });

  window.addEventListener("keyup", e => {
    const k = e.key.toLowerCase();
    if (["arrowup", "w", "arrowdown", "s"].includes(k)) {
      currentDir = 0;
      reversePlaying = false;
      video.pause();
      setAvatarState();
      updateFootsteps();
    }
    if (k === "q" || k === "e") {
      strafe = 0;
    }
  });

  document.querySelectorAll(".gender-buttons button").forEach(btn => {
    btn.addEventListener("click", () => {
      document
        .querySelectorAll(".gender-buttons button")
        .forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentGender = btn.dataset.gender;
      setAvatarState();
    });
  });

  function joyMove(ev) {
    const rect = joystickBase.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;
    const dx = ev.clientX - cx;
    const dy = ev.clientY - cy;
    const r  = rect.width / 2;

    const nx = dx / r;
    const ny = dy / r;

    joystickKnob.style.transform =
      "translate(" + nx * 30 + "px, " + ny * 30 + "px)";

    const prevDir = currentDir;

    if (Math.abs(ny) > 0.2) currentDir = ny < 0 ? 1 : -1;
    else currentDir = 0;

    if (Math.abs(nx) > 0.2) strafe = nx > 0 ? 1 : -1;
    else strafe = 0;

    if (currentDir === 1) {
      playForward();
      if (prevDir === 0) onWalkStart();
    } else if (currentDir === -1) {
      playReverse();
    } else {
      reversePlaying = false;
      video.pause();
    }
    setAvatarState();
    updateFootsteps();
  }

  joystickBase.addEventListener("pointerdown", e => {
    joyActive = true;
    joystickBase.setPointerCapture(e.pointerId);
    joyMove(e);
  });
  joystickBase.addEventListener("pointermove", e => {
    if (joyActive) joyMove(e);
  });
  function resetJoystick() {
    joyActive = false;
    joystickKnob.style.transform = "translate(0,0)";
    currentDir = 0;
    strafe = 0;
    reversePlaying = false;
    video.pause();
    setAvatarState();
    updateFootsteps();
  }
  joystickBase.addEventListener("pointerup", resetJoystick);
  joystickBase.addEventListener("pointercancel", resetJoystick);

  settingsBtn.addEventListener("click", () => {
    settingsPanel.classList.toggle("open");
  });

  setVideoMuted.addEventListener("change", () => {
    video.muted = setVideoMuted.checked;
  });
  setVideoSlow.addEventListener("change", () => {
    if (!video.paused && !reversePlaying) {
      video.playbackRate = setVideoSlow.checked ? 0.5 : 1;
    }
  });

  function applyAvatarVisibility() {
    const hide = setHideAvatar.checked || setWalkNoAvatar.checked;
    avatar.style.display = hide ? "none" : "block";
    shadowEl.style.display = hide ? "none" : "block";
  }
  setHideAvatar.addEventListener("change", () => {
    if (setHideAvatar.checked) setWalkNoAvatar.checked = false;
    applyAvatarVisibility();
  });
  setWalkNoAvatar.addEventListener("change", () => {
    if (setWalkNoAvatar.checked) setHideAvatar.checked = false;
    applyAvatarVisibility();
  });

  setNightMode.addEventListener("change", () => {
    nightOverlay.style.opacity = setNightMode.checked ? "1" : "0";
  });

  video.muted = true;

  function tick() {
    yawCurrent += (yawTarget - yawCurrent) * 0.18;
    avatar.orientation = "0deg 0deg " + yawCurrent + "deg";

    if (currentDir !== 0) {
      headBob += bobDirection * 0.25;
      if (headBob > 2 || headBob < -2) bobDirection *= -1;
    } else {
      headBob *= 0.85;
    }

    if (strafe !== 0) {
      strafeOffset += strafe * 4;
      if (strafeOffset > STRAFE_MAX)  strafeOffset = STRAFE_MAX;
      if (strafeOffset < -STRAFE_MAX) strafeOffset = -STRAFE_MAX;
    } else {
      strafeOffset *= 0.9;
    }

    video.style.transform  = "translateY(" + headBob + "px)";
    avatar.style.transform = "translate(calc(-50% + " + strafeOffset + "px), -15px)";

    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  function updateMapMarkerHighlight() {
    markerEls.forEach(({ el, index }) => {
      if (index === currentIndex) {
        el.classList.add("map-marker-selected");
      } else {
        el.classList.remove("map-marker-selected");
      }
    });
  }

  function loadMap() {
    if (fullMapReady) return;

    fullMap = new maplibregl.Map({
      container: "fullMapContainer",
      style: "https://api.maptiler.com/maps/streets/style.json?key=PqdU3M5vnOQK0dDQnkIq",
      center: [0, 20],
      zoom: 2,
      pitch: 45,
      bearing: -20
    });

    fullMap.addControl(new maplibregl.NavigationControl());

    STREETS.forEach((s, i) => {
      if (!s.lat || !s.lng) return;

      const el = document.createElement("div");
      el.style.width = "18px";
      el.style.height = "18px";
      el.style.borderRadius = "50%";
      el.style.background = "#3b82f6";
      el.style.border = "2px solid white";
      el.style.cursor = "pointer";

      const popup = new maplibregl.Popup({ offset: 16 }).setHTML(
        `<div style="font-size:12px;color:#0f172a;">
          <strong>${s.name || "Street"}</strong><br/>
          <span>${s.city || ""}${s.country ? ", " + s.country : ""}</span>
        </div>`
      );

      const marker = new maplibregl.Marker({ element: el })
        .setLngLat([parseFloat(s.lng), parseFloat(s.lat)])
        .setPopup(popup)
        .addTo(fullMap);

      markerEls.push({ index: i, el, marker });

      el.addEventListener("click", () => {
        currentIndex = i;
        loadStreetByIndex(i);
        updateMapMarkerHighlight();

        const coords = marker.getLngLat();
        fullMap.flyTo({
          center: [coords.lng, coords.lat],
          zoom: 13,
          speed: 0.9
        });

        marker.togglePopup();
        document.getElementById("fullMapOverlay").style.display = "none";
      });
    });

    if (currentIndex !== -1 && STREETS[currentIndex]) {
      const st = STREETS[currentIndex];
      fullMap.flyTo({
        center: [parseFloat(st.lng), parseFloat(st.lat)],
        zoom: 8,
        speed: 0.9
      });
    }

    fullMapReady = true;
  }

  document.getElementById("miniMap").onclick = () => {
    document.getElementById("fullMapOverlay").style.display = "flex";
    loadMap();
  };
  document.getElementById("closeMapBtn").onclick = () => {
    document.getElementById("fullMapOverlay").style.display = "none";
  };

  if (SELECTED) {
    const idx = STREETS.findIndex(s => s._id === SELECTED._id);
    loadStreetByIndex(idx !== -1 ? idx : 0);
  } else if (Array.isArray(STREETS) && STREETS.length > 0) {
    loadStreetByIndex(0);
  }

  const popupCard = document.getElementById("streetPopup");
  const popupTitle = document.getElementById("popupTitle");
  const popupCity = document.getElementById("popupCity");
  const popupCategory = document.getElementById("popupCategory");
  const popupDescription = document.getElementById("popupDescription");
  const popupClose = document.getElementById("popupClose");
  const streetNameEl = document.getElementById("streetName");

  streetNameEl.onclick = () => {
    const name = streetNameEl.textContent;
    const st = STREETS.find(s => s.name === name);
    if (!st) return;

    popupTitle.textContent = st.name;
    popupCity.textContent = `ðŸ“ ${st.city || ""}${st.country ? ", " + st.country : ""}`;
    popupCategory.textContent = st.category ? `ðŸ· Category: ${st.category}` : "ðŸ· No category";
    popupDescription.textContent = st.description || "No description added.";

    popupCard.style.display = "flex";
  };

  popupClose.onclick = () => popupCard.style.display = "none";
  popupCard.onclick = e => {
    if (e.target === popupCard) popupCard.style.display = "none";
  };
</script>
</body>
</html>
