<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Virtual Street Walk ‚Äì Avatar Demo | ABTO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />

  <!-- MODEL-VIEWER -->
  <script type="module" src="{{ url_for('static', filename='js/model-viewer.min.js') }}"></script>

  <!-- MAPLIBRE -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/maplibre-gl.css') }}">
  <script src="{{ url_for('static', filename='js/maplibre-gl.js') }}"></script>

  <style>
    :root{
      --bg-page:#020617;
      --bg-deep:#000;
      --text-main:#e5e7eb;
      --text-muted:#9ca3af;

      --accent:#38bdf8;
      --accent-2:#22c55e;
      --danger:#fb7185;

      --glass:rgba(15,23,42,.78);
      --glass-strong:rgba(15,23,42,.92);
      --border:rgba(148,163,184,.45);
      --shadow:0 18px 45px rgba(0,0,0,.82);

      --radius-lg:18px;
      --radius-md:14px;
      --radius-pill:999px;

      --vh: 1vh;
    }

    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; height:100%; }

    body{
      background: radial-gradient(circle at top, var(--bg-page), var(--bg-deep) 80%);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text-main);
      overflow:hidden;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    /* ‚úÖ when overlays open */
    body.no-scroll{ overflow:hidden !important; }

    /* ===== Viewer root ===== */
    .viewer-panel{
      position:fixed;
      inset:0;
      width:100vw;
      height:100vh;
      height:100dvh;
      height: calc(var(--vh) * 100);
    }

    .viewer-canvas{
      position:relative;
      width:100%;
      height:100%;
      background:#000;
      overflow:hidden;
      touch-action: none;
    }

    /* ===== VIDEO ===== */
    #streetVideo{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      z-index:1;
      pointer-events:none;
      transition: transform 0.12s ease-out, opacity 0.2s ease-out;
      opacity:0;
      will-change: transform;
    }

    #walkVignette{
      position:absolute;
      inset:0;
      pointer-events:none;
      background: radial-gradient(circle at center, transparent 55%, rgba(0,0,0,.35) 85%);
      z-index:3;
      opacity:0;
      transition:opacity .25s ease-out;
    }

    #nightOverlay{
      position:absolute;
      inset:0;
      background: radial-gradient(circle at top, rgba(15,23,42,.4), rgba(0,0,0,.9));
      mix-blend-mode:multiply;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease-out;
      z-index:2;
    }

    /* ===== MINI MAP ===== */
    .mini-map{
      position:absolute;
      top:16px; left:16px;
      width:104px; height:104px;
      border-radius:999px;
      overflow:hidden;
      background:#020617;
      border:2px solid rgba(148,163,184,.6);
      box-shadow:0 12px 30px rgba(0,0,0,.75);
      cursor:pointer;
      z-index:80;
    }
    .mini-map img{ width:100%; height:100%; object-fit:cover; }

    /* ===== TOP-LEFT DOCK ===== */
    .left-dock{
      position:absolute;
      top:132px; left:16px;
      display:grid;
      gap:10px;
      z-index:120;
    }
    .icon-btn{
      width:42px; height:42px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--glass-strong);
      color:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      transition: transform .15s ease;
    }
    .icon-btn:hover{ transform: translateY(-1px); }
    .icon-btn:active{ transform: translateY(0) scale(.98); }

    /* ===== STREET INFO ===== */
    .street-info{
      position:absolute;
      top:64px; right:16px;
      background: rgba(15,23,42,.70);
      border:1px solid rgba(148,163,184,.40);
      padding:8px 14px;
      border-radius:12px;
      z-index:90;
      max-width:240px;
      font-size:12px;
      box-shadow:0 14px 30px rgba(0,0,0,.6);
      backdrop-filter: blur(10px);
    }
    .street-info h2{
      margin:0;
      font-size:14px;
      line-height:1.2;
      cursor:pointer;
    }
    .street-info p{ margin:4px 0 0; color:var(--text-muted); }

    @media (max-width:520px){
      .street-info{ right:10px; max-width:200px; }
    }

    /* ===== BRAND PILL ===== */
    .brand-pill{
      position:absolute;
      left:16px; bottom:22px;
      padding:7px 14px;
      border-radius:999px;
      background: rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.55);
      box-shadow:0 14px 30px rgba(0,0,0,.85);
      font-size:11px;
      color:#e5e7eb;
      display:flex;
      align-items:center;
      gap:8px;
      z-index:120;
      backdrop-filter: blur(10px);
    }
    .brand-pill .abto-tag{
      padding:2px 8px;
      border-radius:999px;
      background: rgba(56,189,248,.18);
      border:1px solid rgba(56,189,248,.7);
      font-weight:650;
      letter-spacing:.03em;
      text-transform:uppercase;
      font-size:10px;
      color:#7dd3fc;
    }

    /* ===== TOP-RIGHT DOCK ===== */
    .top-right-dock{
      position:absolute;
      top:16px; right:16px;
      display:flex;
      align-items:center;
      gap:10px;
      z-index:140;
    }

    .gender-buttons{
      display:inline-flex;
      gap:6px;
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:var(--radius-pill);
      padding:6px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .gender-buttons button{
      padding:7px 12px;
      font-size:11px;
      border-radius:var(--radius-pill);
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.25);
      color:#fff;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    .gender-buttons button:hover{ transform: translateY(-1px); }
    .gender-buttons .active{
      background: rgba(29,78,216,.85);
      border-color: rgba(59,130,246,.95);
    }

    .dock-btn{
      height:40px;
      border-radius: var(--radius-pill);
      border:1px solid var(--border);
      background: var(--glass-strong);
      color:#e5e7eb;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:0 12px;
      transition: transform .15s ease, opacity .15s ease, border-color .15s ease;
      white-space:nowrap;
    }
    .dock-btn:hover{ transform: translateY(-1px); }
    .dock-btn:active{ transform: translateY(0) scale(.98); }

    .dock-icon{ width:18px; height:18px; display:inline-block; }
    .dock-label{ font-size:11px; color: rgba(226,232,240,.92); }

    .autowalk-btn{
      border:1px solid rgba(56,189,248,.55);
      background: linear-gradient(135deg, rgba(56,189,248,.18), rgba(15,23,42,.92));
      position:relative;
      overflow:hidden;
    }
    .autowalk-btn::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(56,189,248,.22), transparent 55%);
      opacity:.7;
      pointer-events:none;
      transform: rotate(12deg);
    }
    .autowalk-btn .dot{
      width:8px; height:8px;
      border-radius:50%;
      background: rgba(148,163,184,.8);
      transition: background .15s ease, box-shadow .15s ease, transform .15s ease;
      z-index:1;
    }
    .autowalk-btn.on{
      border-color: rgba(34,197,94,.7);
      background: linear-gradient(135deg, rgba(34,197,94,.20), rgba(15,23,42,.92));
    }
    .autowalk-btn.on .dot{
      background: rgba(34,197,94,.98);
      box-shadow: 0 0 18px rgba(34,197,94,.55);
      transform: scale(1.05);
      animation: dotPulse 1.2s infinite ease-in-out;
    }
    @keyframes dotPulse{
      0%,100%{ transform: scale(1.0); opacity:1; }
      50%{ transform: scale(1.35); opacity:.75; }
    }

    /* ===== JOYSTICK ===== */
    #joystickBase{
      position:absolute;
      bottom:20px; right:20px;
      width:96px; height:96px;
      border-radius:50%;
      background: radial-gradient(circle at center, rgba(15,23,42,.35) 0%, rgba(15,23,42,.25) 45%, transparent 70%);
      border:1px solid rgba(148,163,184,.55);
      box-shadow:0 8px 24px rgba(0,0,0,.5);
      display:flex;
      justify-content:center;
      align-items:center;
      backdrop-filter: blur(6px);
      touch-action:none;
      z-index:130;
      opacity:.55;
      transition: opacity .18s ease-out, transform .18s ease-out;
    }
    #joystickBase.joy-active{ opacity:.9; transform: scale(1.02); }
    #joystickKnob{
      width:40px; height:40px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(56,189,248,.85), rgba(15,23,42,.9));
      box-shadow: 0 0 0 3px rgba(56,189,248,.25), 0 8px 18px rgba(0,0,0,.65);
      touch-action:none;
    }

    @media (max-width:768px){
      #joystickBase{ right:16px; bottom: 14px; }
      body.is-fs #joystickBase{ bottom: max(14px, env(safe-area-inset-bottom)); }
    }

    /* ===== AVATAR ===== */
    #avatarShadow{
      position:absolute;
      bottom:20px;
      left:50%;
      transform: translateX(-50%);
      width:200px; height:45px;
      background: radial-gradient(circle, rgba(0,0,0,.45), transparent);
      filter: blur(12px);
      z-index:7;
      transition: transform .12s ease-out, opacity .18s ease-out;
      pointer-events:none;
    }
    #avatarWrapper{
      position:absolute;
      bottom:-15px;
      left:50%;
      transform: translateX(-50%);
      width:220px;
      height:440px;
      z-index:10;
      pointer-events:none;
      transition: opacity .18s ease-out;
    }
    #avatarMV{ width:100%; height:100%; display:block; }

    /* ===== SPEECH ===== */
    #avatarSpeech, #streetSpeech{
      font-size:12px;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease-out, transform .2s ease-out;
      box-shadow:0 18px 45px rgba(0,0,0,.8);
      border:1px solid rgba(148,163,184,.7);
    }
    #avatarSpeech{
      position:absolute;
      bottom:410px;
      left:50%;
      transform: translateX(-50%) translateY(6px);
      max-width:280px;
      padding:7px 12px;
      background: rgba(15,23,42,.96);
      border-radius:999px;
      color:#e5e7eb;
      z-index:150;
    }
    #streetSpeech{
      position:absolute;
      bottom:420px;
      right:40px;
      max-width:260px;
      padding:7px 12px;
      background: rgba(30,41,59,.95);
      border-radius:12px;
      color:#f1f5f9;
      z-index:150;
      transform: translateY(6px);
    }
    #avatarSpeech.visible{ opacity:1; transform: translateX(-50%) translateY(-4px); }
    #streetSpeech.visible{ opacity:1; transform: translateY(-4px); }

    /* ===== LOADING ===== */
    #videoLoading{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.9);
      z-index:6;
      pointer-events:none;
    }
    #videoLoadingSpinner{
      width:36px; height:36px;
      border-radius:50%;
      border:3px solid rgba(148,163,184,.4);
      border-top-color: var(--accent);
      animation: spin .7s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* ===== START HINT ===== */
    #startHint{
      position:absolute;
      inset:auto 0 82px 0;
      display:flex;
      justify-content:center;
      z-index:160;
      transition: opacity .25s ease-out;
    }

    /* ===== ORIENTATION GATE ===== */
    .orientation-gate{
      position:fixed;
      inset:0;
      background: radial-gradient(circle at top, var(--bg-page), var(--bg-deep) 80%);
      display:none;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:40px 24px;
      z-index:500;
    }
    .orientation-inner{ max-width:340px; }
    .orientation-icon{
      font-size:46px;
      margin-bottom:18px;
      display:inline-block;
      animation: rotateHint 1.8s ease-in-out infinite;
    }
    .orientation-title{ font-size:18px; font-weight:600; margin-bottom:8px; }
    .orientation-text{ font-size:14px; color:#9ca3af; }
    @keyframes rotateHint{
      0%,100%{ transform: rotate(0deg); }
      50%{ transform: rotate(90deg); }
    }
    @media (max-width:768px) and (orientation: portrait){
      .orientation-gate{ display:flex; }
    }

    /* ===== ERROR BANNER ===== */
    .error-banner{
      position:fixed;
      top:16px; left:50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,.96);
      border-radius:999px;
      border:1px solid rgba(248,113,113,.7);
      color:#fecaca;
      padding:8px 14px;
      font-size:12px;
      display:none;
      align-items:center;
      gap:10px;
      z-index:700;
      box-shadow:0 18px 45px rgba(0,0,0,.85);
      backdrop-filter: blur(12px);
      transition: opacity .2s ease-out, transform .2s ease-out;
    }
    .error-banner-visible{ display:inline-flex; }
    .error-dot{
      width:8px; height:8px;
      border-radius:50%;
      background:#f97316;
      box-shadow:0 0 12px #f97316;
      flex-shrink:0;
    }
    .error-banner button{
      border:none;
      background:transparent;
      color:#9ca3af;
      cursor:pointer;
      font-size:14px;
      padding-left:6px;
    }

    /* ===== SETTINGS PANEL ===== */
    #settingsPanel{
      position:absolute;
      left:72px;
      top:132px;
      width:270px;
      max-width:80vw;
      background: rgba(15,23,42,.96);
      border-radius:16px;
      border:1px solid rgba(148,163,184,.6);
      box-shadow:0 18px 45px rgba(0,0,0,.9);
      padding:10px 12px 12px;
      z-index:250;
      transform: translateY(10px);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease-out, transform .18s ease-out;
      font-size:12px;
      backdrop-filter: blur(12px);
    }
    #settingsPanel.open{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
    }
    .settings-section{
      margin-top:8px;
      padding-top:6px;
      border-top:1px solid rgba(30,64,175,.5);
    }
    .settings-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:6px;
      gap:8px;
      font-size:11px;
      color: rgba(226,232,240,.92);
    }

    /* =========================================================
       ‚úÖ STREETS DRAWER
    ========================================================= */
    #streetsDrawerOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      z-index:400;
      pointer-events:auto;
      touch-action: auto !important;
    }
    body.is-fs #streetsDrawerOverlay{
      position:absolute;
      inset:0;
    }

    #streetsDrawer{
      position:absolute;
      top:0; left:0;
      height:100%;
      width:min(380px, 92vw);
      background: rgba(2,6,23,.92);
      border-right:1px solid rgba(148,163,184,.25);
      box-shadow:40px 0 90px rgba(0,0,0,.75);
      padding:14px 14px 12px;

      display:flex;
      flex-direction:column;
      gap:10px;

      min-height:0;
      touch-action: auto !important;
    }

    .drawer-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:6px;
      border-bottom:1px solid rgba(148,163,184,.18);
      flex: 0 0 auto;
    }
    .drawer-title{ font-size:13px; font-weight:650; letter-spacing:.02em; }
    .drawer-close{
      width:36px; height:36px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background: rgba(15,23,42,.65);
      color:#e5e7eb;
      cursor:pointer;
    }
    .drawer-search{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.28);
      background: rgba(15,23,42,.6);
      color:#e5e7eb;
      padding:10px 12px;
      outline:none;
      font-size:12px;
      flex: 0 0 auto;
    }

    .drawer-list{
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto !important;
      overflow-x: hidden;
      padding-right:6px;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y !important;
      scrollbar-gutter: stable;
      will-change: scroll-position;
    }

    .street-item{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(15,23,42,.45);
      cursor:pointer;
      margin-bottom:10px;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .street-item:hover{
      transform: translateY(-1px);
      border-color: rgba(56,189,248,.38);
      background: rgba(15,23,42,.62);
    }
    .street-item .name{ font-size:12px; font-weight:650; }
    .street-item .meta{ font-size:11px; color: rgba(148,163,184,.92); }
    .street-item.active{
      border-color: rgba(56,189,248,.65);
      background: rgba(56,189,248,.10);
    }

    /* ===== FULL MAP OVERLAY ===== */
    #fullMapOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.75);
      backdrop-filter: blur(6px);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:380;
      padding:20px;
      pointer-events:auto;
      touch-action: auto;
    }
    #fullMapContainer{
      width:90%;
      height:80%;
      background:#0b1120;
      border-radius: var(--radius-lg);
      border:1px solid rgba(148,163,184,.5);
      overflow:hidden;
      box-shadow:0 25px 70px rgba(0,0,0,.9);
      touch-action: auto;
    }
    #closeMapBtn{
      position:absolute;
      top:30px; right:40px;
      width:48px; height:48px;
      background: rgba(0,0,0,.65);
      color:#fff;
      border-radius:50%;
      border:none;
      cursor:pointer;
      font-size:22px;
      z-index:500;
      backdrop-filter: blur(4px);
      box-shadow:0 10px 30px rgba(0,0,0,.8);
    }
    body.is-fs #fullMapOverlay{
      position:absolute;
      inset:0;
    }

    /* ===== POPUP CARD ===== */
    #streetPopup{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:520;
      touch-action:auto;
    }
    #streetPopupCard{
      width:90%;
      max-width:420px;
      background: rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.4);
      padding:26px;
      border-radius:18px;
      animation: popupFade .25s ease;
    }
    #streetPopupCard h2{
      margin:0 0 10px 0;
      font-size:22px;
      color: var(--accent);
    }
    #streetPopupCard p{
      margin:6px 0;
      font-size:14px;
      color: var(--text-main);
    }
    #popupClose{
      margin-top:16px;
      padding:10px 22px;
      background: var(--accent);
      border:none;
      border-radius:10px;
      color:#000;
      font-weight:800;
      cursor:pointer;
      width:100%;
    }
    @keyframes popupFade{
      from{ opacity:0; transform: translateY(16px); }
      to{ opacity:1; transform: translateY(0); }
    }
    body.is-fs #streetPopup{
      position:absolute;
      inset:0;
      touch-action:auto;
    }

    /* ===== FADE ===== */
    #fadeLayer{
      position:absolute;
      inset:0;
      background:#000;
      opacity:0;
      transition: opacity .5s;
      pointer-events:none;
      z-index:360;
    }

    /* ===== MAP MARKER ===== */
    .map-marker-selected{
      width:26px !important;
      height:26px !important;
      background: var(--accent) !important;
      border-radius:50%;
      border:3px solid #fff !important;
      box-shadow: 0 0 18px var(--accent), 0 0 32px var(--accent);
      animation: markerPulse 1.4s infinite ease-in-out;
    }
    @keyframes markerPulse{
      0%{ transform: scale(1); opacity:1; }
      50%{ transform: scale(1.3); opacity:.7; }
      100%{ transform: scale(1); opacity:1; }
    }

    /* ===== MOBILE ‚ÄúBETTER ON DESKTOP‚Äù TOAST ===== */
    #deviceToast{
      position:fixed;
      left:50%;
      bottom:24px;
      transform: translateX(-50%);
      background: rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.45);
      border-radius:14px;
      box-shadow:0 25px 70px rgba(0,0,0,.85);
      padding:10px 12px;
      z-index:800;
      display:none;
      align-items:center;
      gap:10px;
      backdrop-filter: blur(12px);
      max-width: min(560px, 92vw);
    }
    #deviceToast .t-title{ font-size:12px; font-weight:800; }
    #deviceToast .t-sub{ font-size:11px; color: rgba(148,163,184,.95); }
    #deviceToast button{
      margin-left:8px;
      width:34px;
      height:34px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.3);
      background: rgba(0,0,0,.25);
      color:#e5e7eb;
      cursor:pointer;
    }

    @media (max-width:900px){
      #avatarWrapper{ bottom:-4px; height:min(55vh, 300px); }
      #avatarShadow{ bottom:10px; width:160px; height:36px; }
    }
    @media (max-width:520px){
      .dock-label{ display:none; }
      .dock-btn{ padding: 0 10px; }
    }
  </style>
</head>

<body>
  <!-- Orientation gate -->
  <div id="orientationGate" class="orientation-gate">
    <div class="orientation-inner">
      <div class="orientation-icon">üì±</div>
      <div class="orientation-title">Rotate your phone for Walk Mode</div>
      <p class="orientation-text">
        Avatar Walk Mode is best experienced in <strong>landscape</strong>.<br>
        Please rotate your phone sideways to see the full street view.
      </p>
    </div>
  </div>

  {% set _street_error = street_error|default('') %}
  <div id="errorBanner"
       class="error-banner{% if _street_error %} error-banner-visible{% endif %}"
       data-error="{{ _street_error }}">
    <span class="error-dot"></span>
    <span>
      {% if _street_error == 'not_found' %}
        Street link is broken or no longer exists. Showing default Walk Mode instead.
      {% elif _street_error == 'unavailable' %}
        This street is unpublished or deleted. Showing default Walk Mode instead.
      {% elif _street_error %}
        Street link could not be opened. Showing default view instead.
      {% endif %}
      {% if _street_error %}
        <a href="{{ url_for('world') }}"
           style="margin-left:6px;color:#bfdbfe;text-decoration:underline;font-size:11px;">
          Back to world map
        </a>
      {% endif %}
    </span>
    <button id="errorBannerClose" aria-label="Dismiss message">‚úï</button>
  </div>

  <!-- Full map overlay -->
  <div id="fullMapOverlay">
    <div id="fullMapContainer"></div>
    <button id="closeMapBtn" aria-label="Close map">‚úï</button>
  </div>

  <!-- Streets drawer -->
  <div id="streetsDrawerOverlay" aria-hidden="true">
    <div id="streetsDrawer" role="dialog" aria-label="All streets list">
      <div class="drawer-head">
        <div class="drawer-title">All Streets</div>
        <button id="streetsDrawerClose" class="drawer-close" aria-label="Close">‚úï</button>
      </div>

      <input id="streetsSearch"
             class="drawer-search"
             placeholder="Search street / city / country..."
             autocomplete="off"
             autocapitalize="off"
             autocorrect="off"
             spellcheck="false"
             inputmode="search" />

      <div id="streetsList" class="drawer-list"></div>
    </div>
  </div>

  <div class="viewer-panel" id="viewerPanel">
    <div class="viewer-canvas" id="viewerCanvas">
      <div id="miniMap" class="mini-map" title="Open map">
        <img src="/static/img/minimap_placeholder.png" alt="">
      </div>

      <div class="top-right-dock">
        <div class="gender-buttons" aria-label="Avatar gender">
          <button class="active" data-gender="male" type="button">Male</button>
          <button data-gender="female" type="button">Female</button>
        </div>

        <button id="fullscreenBtn" class="dock-btn" aria-label="Enter full screen" title="Full screen" type="button">
          <span class="dock-icon" id="fsIcon"></span>
          <span class="dock-label" id="fsLabel">Fullscreen</span>
        </button>

        <button id="autoWalkDockBtn" class="dock-btn autowalk-btn" aria-label="Toggle auto walk" title="Auto walk" type="button">
          <span class="dot"></span>
          <span class="dock-label" id="autoWalkLabel">Auto Walk</span>
        </button>
      </div>

      <div class="street-info">
        <h2 id="streetName">Select a Street</h2>
        <p id="streetLocation">Waiting‚Ä¶</p>
      </div>

      <div class="left-dock">
        <button id="settingsBtn" class="icon-btn" aria-label="Settings" title="Settings" type="button">‚öô</button>
        <button id="streetsBtn" class="icon-btn" aria-label="All streets" title="All streets" type="button">‚ò∞</button>
      </div>

      <div class="brand-pill">
        <span class="abto-tag">ABTO</span>
        <span>A Better Travel Observer</span>
      </div>

      <video id="streetVideo" preload="metadata" playsinline disablepictureinpicture>

        <source id="videoSource" src="">
      </video>

      <div id="walkVignette"></div>

      <div id="videoLoading">
        <div id="videoLoadingSpinner"></div>
      </div>

      <div id="nightOverlay"></div>

      <div id="avatarShadow"></div>
      <div id="avatarWrapper">
        <model-viewer id="avatarMV"
          src="/static/avatars/male/idle.glb"
          autoplay
          shadow-intensity="1"
          orientation="0deg 0deg 180deg"
          disable-zoom
          disable-pan>
        </model-viewer>
      </div>

      <div id="avatarSpeech"></div>
      <div id="streetSpeech"></div>

      <div id="joystickBase" aria-label="Movement joystick">
        <div id="joystickKnob"></div>
      </div>

      <!-- ‚úÖ SETTINGS PANEL -->
      <div id="settingsPanel" aria-label="View settings">
        <h3 style="margin:0 0 6px 0;font-size:13px;">View settings</h3>

        <div class="settings-section">
          <strong style="font-size:11px;">Video</strong>
          <div class="settings-row">
            <label for="setVideoMuted">Mute video</label>
            <input type="checkbox" id="setVideoMuted">

          </div>
          <div class="settings-row">
            <label for="setVideoSlow">Slow motion</label>
            <input type="checkbox" id="setVideoSlow">
          </div>
        </div>

        <div class="settings-section">
          <strong style="font-size:11px;">Avatar</strong>
          <div class="settings-row">
            <label for="setHideAvatar">Hide avatar</label>
            <input type="checkbox" id="setHideAvatar">
          </div>
          <div class="settings-row">
            <label for="setWalkNoAvatar">Walk without avatar</label>
            <!-- ‚úÖ DEFAULT ON -->
            <input type="checkbox" id="setWalkNoAvatar" checked>
          </div>
        </div>

        <div class="settings-section">
          <strong style="font-size:11px;">Environment</strong>
          <div class="settings-row">
            <label for="setNightMode">Night view</label>
            <input type="checkbox" id="setNightMode">
          </div>
        </div>
      </div>

      <div id="streetPopup">
        <div id="streetPopupCard">
          <h2 id="popupTitle"></h2>
          <p id="popupCity"></p>
          <p id="popupCategory"></p>
          <p id="popupDescription"></p>
          <button id="popupClose" type="button">Close</button>
        </div>
      </div>

      <div id="startHint">
        <div style="display:flex;align-items:center;gap:10px;
                    background:rgba(15,23,42,0.92);
                    border-radius:999px;
                    padding:8px 14px;
                    border:1px solid rgba(148,163,184,0.55);
                    box-shadow:0 18px 45px rgba(0,0,0,0.85);
                    font-size:11px;
                    color:#e5e7eb;
                    backdrop-filter:blur(12px);">
          <span style="display:inline-flex;align-items:center;justify-content:center;
                       width:20px;height:20px;border-radius:999px;
                       background:rgba(56,189,248,0.16);
                       border:1px solid rgba(56,189,248,0.7);
                       font-size:11px;color:#7dd3fc;">
            ‚Üë
          </span>
          <span style="opacity:0.9;">
            Press <strong>W / ‚Üë</strong> or drag the joystick to start walking
          </span>
          <button id="startHintSkip"
                  type="button"
                  style="margin-left:4px;border:none;background:transparent;
                         color:#9ca3af;font-size:11px;cursor:pointer;padding:0 2px;">
            Skip
          </button>
        </div>
      </div>

      <div id="fadeLayer"></div>
    </div>
  </div>

  <div id="deviceToast" role="status" aria-live="polite">
    <div>
      <div class="t-title">Better on Laptop/Desktop</div>
      <div class="t-sub">For the best experience, try this on a larger screen.</div>
    </div>
    <button id="toastClose" aria-label="Dismiss" type="button">‚úï</button>
  </div>

  <audio id="footstepAudio" src="/static/audio/footsteps_loop.wav" loop preload="auto"></audio>
  <audio id="voiceAudio" preload="auto"></audio>

  <script id="streets-data" type="application/json">
    {{ streets | tojson | safe }}
  </script>
  <script id="selected-street-data" type="application/json">
    {{ selected_street | tojson | safe if selected_street else 'null' }}
  </script>

  <script type="module">
    const DEBUG = false;

    const $ = (id) => document.getElementById(id);

    function setViewportHeightVar(){
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function isFullscreenActive(){
      return !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
    }

    function syncFsClass(){
      document.body.classList.toggle("is-fs", isFullscreenActive());
    }

    function ensureOverlayParent(overlayEl){
      if (!overlayEl) return;
      const parent = isFullscreenActive() ? viewerPanel : document.body;
      if (overlayEl.parentElement !== parent) parent.appendChild(overlayEl);
    }

    function restoreOverlayToBody(overlayEl){
      if (!overlayEl) return;
      if (overlayEl.parentElement !== document.body) document.body.appendChild(overlayEl);
    }

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    /* =========================================================
       ‚úÖ Overlay interaction helper (for big overlays only)
    ========================================================= */
    function setCanvasTouchForOverlay(isOpen){
      if (!viewerCanvas) return;

      if (isOpen){
        viewerCanvas.dataset.prevTouchAction = viewerCanvas.style.touchAction || "";
        viewerCanvas.dataset.prevPointerEvents = viewerCanvas.style.pointerEvents || "";

        viewerCanvas.style.touchAction = "auto";
        viewerCanvas.style.pointerEvents = "none";

        document.body.classList.add("no-scroll");
      } else {
        viewerCanvas.style.touchAction = viewerCanvas.dataset.prevTouchAction || "";
        viewerCanvas.style.pointerEvents = viewerCanvas.dataset.prevPointerEvents || "";

        delete viewerCanvas.dataset.prevTouchAction;
        delete viewerCanvas.dataset.prevPointerEvents;

        document.body.classList.remove("no-scroll");
      }
    }

    let STREETS = [];
    let SELECTED = null;

    try{
      STREETS = JSON.parse($("streets-data").textContent || "[]");
      SELECTED = JSON.parse($("selected-street-data").textContent || "null");
      if (!Array.isArray(STREETS)) STREETS = [];
    }catch(e){
      STREETS = [];
      SELECTED = null;
    }

    const viewerPanel = $("viewerPanel");
    const viewerCanvas = $("viewerCanvas");

    const video = $("streetVideo");
    const vsrc = $("videoSource");
    const videoLoading = $("videoLoading");
    const walkVignette = $("walkVignette");
    const nightOverlay = $("nightOverlay");

    const avatar = $("avatarMV");
    const avatarWrapper = $("avatarWrapper");
    const shadowEl = $("avatarShadow");
    const fadeLayer = $("fadeLayer");

    const speechEl = $("avatarSpeech");
    const streetSpeechEl = $("streetSpeech");
    const voiceAudio = $("voiceAudio");
    const footstepAudio = $("footstepAudio");

    const settingsBtn = $("settingsBtn");
    const settingsPanel = $("settingsPanel");

    const setVideoMuted = $("setVideoMuted");
    const setVideoSlow = $("setVideoSlow");
    const setHideAvatar = $("setHideAvatar");
    const setWalkNoAvatar = $("setWalkNoAvatar");
    const setNightMode = $("setNightMode");

    const joystickBase = $("joystickBase");
    const joystickKnob = $("joystickKnob");

    const startHint = $("startHint");
    const startHintSkip = $("startHintSkip");

    const fullMapOverlay = $("fullMapOverlay");
    const fullMapContainer = $("fullMapContainer");
    const closeMapBtn = $("closeMapBtn");
    const orientationGate = $("orientationGate");

    const errorBanner = $("errorBanner");
    const errorBannerClose = $("errorBannerClose");

    const streetsBtn = $("streetsBtn");
    const streetsDrawerOverlay = $("streetsDrawerOverlay");
    const streetsDrawerClose = $("streetsDrawerClose");
    const streetsSearch = $("streetsSearch");
    const streetsList = $("streetsList");

    const fullscreenBtn = $("fullscreenBtn");
    const fsIcon = $("fsIcon");
    const fsLabel = $("fsLabel");

    const autoWalkDockBtn = $("autoWalkDockBtn");
    const autoWalkLabel = $("autoWalkLabel");

    const deviceToast = $("deviceToast");
    const toastClose = $("toastClose");

    const streetNameEl = $("streetName");
    const streetLocationEl = $("streetLocation");

    const popupCard = $("streetPopup");
    const popupTitle = $("popupTitle");
    const popupCity = $("popupCity");
    const popupCategory = $("popupCategory");
    const popupDescription = $("popupDescription");
    const popupClose = $("popupClose");

    let audioUnlocked = false;
    let lastFrameTime = 0;

    let markerEls = [];
    let fullMapReady = false;
    let fullMap = null;

    let hasStartedWalking = false;
    let currentIndex = -1;
    let currentVideos = [];
    let currentVideoIndex = 0;

    let currentGender = "male";
    let currentDir = 0; // -1 reverse, 0 idle, 1 forward
    let reversePlaying = false;

    let headBob = 0;
    let bobDirection = 1;
    let strafe = 0;
    let strafeOffset = 0;
    const STRAFE_MAX = 120;

    let motionMomentum = 0;
    let joyActive = false;

    let isFirstStreetLoad = true;
    let isVideoLoading = false;

    let speechTimeout = null;
    let streetSpeechTimeout = null;

    let autoWalkEnabled = false;
    let reverseRAF = 0;

    const avatarSources = {
      male: { idle: "/static/avatars/male/idle.glb", walk: "/static/avatars/male/walk.glb" },
      female: { idle: "/static/avatars/female/idle.glb", walk: "/static/avatars/female/walk.glb" }
    };

    /* =========================================================
       ‚úÖ NEW: Fake "look around" for NORMAL MP4 (drag to pan view)
       - Doesn't reveal new pixels (not true 360)
       - Adds inertia + gentle spring-to-center
       - Auto-ignores UI areas + overlays + joystick
    ========================================================= */
    let lookX = 0, lookY = 0;
    let lookVX = 0, lookVY = 0;
    let isLooking = false;
    let lookPointerId = null;
    let lastLookClientX = 0, lastLookClientY = 0;

    // tuning
    const LOOK_MAX_X = 140;     // pan left/right (px)
    const LOOK_MAX_Y = 80;      // pan up/down (px)
    const LOOK_SENS  = 0.9;     // drag sensitivity
    const LOOK_FRICTION = 0.86; // inertia decay
    const LOOK_SPRING   = 0.06; // spring to center when released
    const LOOK_ZOOM      = 1.10; // scale to hide edges

    function isAnyOverlayOpen(){
      return (
        settingsPanel.classList.contains("open") ||
        streetsDrawerOverlay.style.display === "block" ||
        fullMapOverlay.style.display === "flex" ||
        popupCard.style.display === "flex"
      );
    }

    function isOnUI(target){
      return !!target.closest(
        ".dock-btn, .icon-btn, .gender-buttons, #joystickBase, #streetsDrawer, #fullMapContainer, #closeMapBtn, .street-info, .mini-map, #settingsPanel"
      );
    }

    // pointer drag on canvas
    viewerCanvas.addEventListener("pointerdown", (e) => {
      if (isAnyOverlayOpen()) return;
      if (joyActive) return;
      if (isOnUI(e.target)) return;

      isLooking = true;
      lookPointerId = e.pointerId;
      lastLookClientX = e.clientX;
      lastLookClientY = e.clientY;
      try{ viewerCanvas.setPointerCapture(lookPointerId); }catch(_){}
    }, { passive:true });

    viewerCanvas.addEventListener("pointermove", (e) => {
      if (!isLooking || e.pointerId !== lookPointerId) return;

      const dx = e.clientX - lastLookClientX;
      const dy = e.clientY - lastLookClientY;
      lastLookClientX = e.clientX;
      lastLookClientY = e.clientY;

      lookX = clamp(lookX + dx * LOOK_SENS, -LOOK_MAX_X, LOOK_MAX_X);
      lookY = clamp(lookY + dy * LOOK_SENS, -LOOK_MAX_Y, LOOK_MAX_Y);

      lookVX = dx * 0.35;
      lookVY = dy * 0.35;
    }, { passive:true });

    function endLook(e){
      if (!isLooking) return;
      if (e && lookPointerId !== null && e.pointerId !== lookPointerId) return;

      isLooking = false;
      try{ viewerCanvas.releasePointerCapture(lookPointerId); }catch(_){}
      lookPointerId = null;
    }

    viewerCanvas.addEventListener("pointerup", endLook, { passive:true });
    viewerCanvas.addEventListener("pointercancel", endLook, { passive:true });
    viewerCanvas.addEventListener("pointerleave", endLook, { passive:true });

    // double tap/click to center
    let lastTap = 0;
    viewerCanvas.addEventListener("pointerdown", (e) => {
      if (isAnyOverlayOpen()) return;
      if (isOnUI(e.target)) return;

      const now = Date.now();
      if (now - lastTap < 280){
        lookX = 0; lookY = 0; lookVX = 0; lookVY = 0;
      }
      lastTap = now;
    }, { passive:true });

    /* =========================================================
       ‚úÖ NEW: force-avatar-visible window (for teleport / gender line)
       (Greeting is disabled below)
    ========================================================= */
    let forceAvatarVisibleUntil = 0;
    function revealAvatarTemporarily(ms=2200){
      forceAvatarVisibleUntil = Math.max(forceAvatarVisibleUntil, Date.now() + ms);
      applySettings();
      setTimeout(() => applySettings(), ms + 20);
    }
    function isForceAvatarVisible(){
      return Date.now() < forceAvatarVisibleUntil;
    }

    setViewportHeightVar();
    syncFsClass();

    window.addEventListener("resize", setViewportHeightVar);
    window.addEventListener("orientationchange", setViewportHeightVar);

    document.addEventListener("fullscreenchange", () => {
      setViewportHeightVar();
      syncFsClass();
      if (streetsDrawerOverlay?.style.display === "block") ensureOverlayParent(streetsDrawerOverlay);
      if (fullMapOverlay?.style.display === "flex") ensureOverlayParent(fullMapOverlay);
      if (popupCard?.style.display === "flex") ensureOverlayParent(popupCard);
    });

    document.addEventListener("webkitfullscreenchange", () => {
      setViewportHeightVar();
      syncFsClass();
      if (streetsDrawerOverlay?.style.display === "block") ensureOverlayParent(streetsDrawerOverlay);
      if (fullMapOverlay?.style.display === "flex") ensureOverlayParent(fullMapOverlay);
      if (popupCard?.style.display === "flex") ensureOverlayParent(popupCard);
    });

    function unlockAudio(){
      if (audioUnlocked) return;
      [footstepAudio, voiceAudio].forEach(a => {
        try{
          a.muted = false;
          a.play().then(() => {
            a.pause();
            a.currentTime = 0;
          }).catch(()=>{});
        }catch(_){}
      });
      audioUnlocked = true;
    }

    window.addEventListener("pointerdown", unlockAudio, { once:true });
    window.addEventListener("keydown", unlockAudio, { once:true });

    /* ‚úÖ Greetings removed/disabled (no annoying start speech) */
    function triggerGreeting(){
      return; // greetings are OFF
    }

    const teleportLines = {
      male: [
        { text:"Teleporting to the next street.", file:"/static/audio/teleport/male_tp_1.mp3" },
        { text:"Jumping to another street!", file:"/static/audio/teleport/male_tp_2.mp3" }
      ],
      female: [
        { text:"Teleporting to the next street.", file:"/static/audio/teleport/female_tp_1.mp3" },
        { text:"Jumping to another cute street!", file:"/static/audio/teleport/female_tp_2.mp3" }
      ]
    };

    function showAvatarSpeech(text, duration=2300){
      speechEl.textContent = text;
      speechEl.classList.add("visible");
      clearTimeout(speechTimeout);
      speechTimeout = setTimeout(() => speechEl.classList.remove("visible"), duration);
    }

    function showStreetSpeech(text, duration=2300){
      streetSpeechEl.textContent = text;
      streetSpeechEl.classList.add("visible");
      clearTimeout(streetSpeechTimeout);
      streetSpeechTimeout = setTimeout(() => streetSpeechEl.classList.remove("visible"), duration);
    }

    function playVoice(file){
      if (!file || !audioUnlocked) return;
      try{
        voiceAudio.pause();
        voiceAudio.currentTime = 0;
        voiceAudio.src = file;
        voiceAudio.play().catch(()=>{});
      }catch(_){}
    }

    function hideStartHint(){
      if (hasStartedWalking) return;
      hasStartedWalking = true;
      startHint.style.opacity = "0";
      startHint.style.pointerEvents = "none";
      setTimeout(() => { startHint.style.display = "none"; }, 220);
    }
    if (startHintSkip) startHintSkip.addEventListener("click", hideStartHint);

    function onWalkStart(){
      hideStartHint();
      // ‚úÖ no greeting call here
    }

    function hardResetVideo(){
      cancelReverseLoop();
      try{
        video.pause();
        video.removeAttribute("src");
        vsrc.src = "";
        video.load();
        video.currentTime = 0;
      }catch(_){}
    }

    function buildVideoList(street){
      const vids = [];
      if (Array.isArray(street?.videos) && street.videos.length){
        street.videos.forEach(v => { if (v?.url) vids.push(v.url); });
      }
      if (!vids.length && street?.videoUrl) vids.push(street.videoUrl);
      return vids;
    }

    function setAvatarState(){
      const state = (currentDir === 0) ? "idle" : "walk";
      const srcSet = avatarSources[currentGender] || avatarSources.male;
      const src = srcSet[state];
      if (src && avatar.getAttribute("src") !== src) avatar.setAttribute("src", src);
    }

    function updateFootsteps(){
      if (currentDir !== 0 && audioUnlocked){
        if (footstepAudio.paused) footstepAudio.play().catch(()=>{});
      } else {
        footstepAudio.pause();
        footstepAudio.currentTime = 0;
      }
    }

    function playForward(){
      cancelReverseLoop();
      reversePlaying = false;
      motionMomentum = Math.min(motionMomentum + 0.15, 1);

      if (!audioUnlocked) return;
      video.playbackRate = setVideoSlow.checked ? 0.5 : 1;
      video.play().catch(()=>{});
    }

    function cancelReverseLoop(){
      reversePlaying = false;
      if (reverseRAF) cancelAnimationFrame(reverseRAF);
      reverseRAF = 0;
    }

    function playReverse(){
      if (!audioUnlocked) return;
      cancelReverseLoop();
      reversePlaying = true;
      video.pause();

      const step = () => {
        if (!reversePlaying) return;

        const delta = setVideoSlow.checked ? 0.008 : 0.016;
        const dur = Number.isFinite(video.duration) ? video.duration : 0;

        if (!dur || dur < 0.05){
          reverseRAF = requestAnimationFrame(step);
          return;
        }

        video.currentTime = (video.currentTime - delta);
        if (video.currentTime <= 0.02) video.currentTime = dur - 0.02;

        reverseRAF = requestAnimationFrame(step);
      };

      reverseRAF = requestAnimationFrame(step);
    }

    async function loadStreet(street){
      if (!street || !street.name){
        await teleportNearest();
        return;
      }

      $("streetName").textContent = street.name || "Untitled Street";
      $("streetLocation").textContent =
        (street.city || "") + (street.city && street.country ? ", " : "") + (street.country || "");

      currentVideos = buildVideoList(street);
      currentVideoIndex = 0;

      if (!currentVideos.length){
        await teleportNearest();
        return;
      }

      if (isVideoLoading) return;
      isVideoLoading = true;

      if (isFirstStreetLoad){
        videoLoading.style.display = "flex";
        video.style.opacity = "0";
      }

      const url = currentVideos[0];
      hardResetVideo();
      vsrc.src = url;
      video.load();

      const onReady = () => {
        isVideoLoading = false;
        video.style.opacity = "1";
        if (isFirstStreetLoad){
          videoLoading.style.display = "none";
          isFirstStreetLoad = false;
        }
        if (currentDir === 1) playForward();
        else if (currentDir === -1) playReverse();
      };

      const onErr = async () => {
        isVideoLoading = false;
        if (isFirstStreetLoad) videoLoading.style.display = "none";
        await teleportNearest();
      };

      video.addEventListener("loadeddata", onReady, { once:true });
      video.addEventListener("error", onErr, { once:true });
    }

    function loadStreetByIndex(i){
      if (!Number.isFinite(i) || i < 0 || i >= STREETS.length) return;
      currentIndex = i;

      loadStreet(STREETS[i]);
      updateMapMarkerHighlight();
      renderStreetsList(streetsSearch.value || "");

      if (fullMap && STREETS[i]){
        const s = STREETS[i];
        const lng = parseFloat(s.lng), lat = parseFloat(s.lat);
        if (Number.isFinite(lng) && Number.isFinite(lat)){
          fullMap.flyTo({ center:[lng, lat], zoom:12, speed:0.9 });
        }
      }
    }

    function haversine(lat1, lon1, lat2, lon2){
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat/2)**2 +
        Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
      return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function nearestStreetIndex(){
      const base = STREETS[currentIndex];
      if (!base || STREETS.length < 2) return (STREETS.length ? 0 : -1);

      const baseLat = parseFloat(base.lat);
      const baseLng = parseFloat(base.lng);

      let best = -1;
      let bestDist = Infinity;

      STREETS.forEach((s, i) => {
        if (i === currentIndex) return;
        const lat = parseFloat(s.lat);
        const lng = parseFloat(s.lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
        const d = haversine(baseLat, baseLng, lat, lng);
        if (!Number.isNaN(d) && d < bestDist){
          bestDist = d;
          best = i;
        }
      });

      if (best === -1 || !Number.isFinite(bestDist) || bestDist > 0.8){
        return (currentIndex + 1) % STREETS.length;
      }
      return best;
    }

    async function teleportNearest(){
      const next = nearestStreetIndex();
      if (next === -1) return;

      const list = teleportLines[currentGender] || teleportLines.male;
      if (list?.length){
        const line = list[Math.floor(Math.random()*list.length)];

        // ‚úÖ Avatar visible during teleport line
        revealAvatarTemporarily(2600);

        showAvatarSpeech(line.text, 2200);
        playVoice(line.file);
      }

      fadeLayer.style.opacity = "1";
      await sleep(350);
      loadStreetByIndex(next);
      fadeLayer.style.opacity = "0";
    }

    video.addEventListener("ended", async () => {
      if (currentVideos.length > 1 && currentVideoIndex < currentVideos.length - 1){
        currentVideoIndex++;
        const nextUrl = currentVideos[currentVideoIndex] || "";
        hardResetVideo();
        vsrc.src = nextUrl;
        video.load();
        video.currentTime = 0;
        if (currentDir === 1) playForward();
        return;
      }

      cancelReverseLoop();
      currentDir = 0;
      video.pause();
      setAvatarState();
      updateFootsteps();
      applySettings();
      await teleportNearest();
    });

    // ‚úÖ small enhancement: applySettings tick throttled properly
    let nextSettingsTick = 0;

    function tick(t=0){
      if (t - lastFrameTime < 16){
        requestAnimationFrame(tick);
        return;
      }
      lastFrameTime = t;

      if (document.hidden){
        video.pause();
        footstepAudio.pause();
        requestAnimationFrame(tick);
        return;
      }

      motionMomentum *= 0.92;
      if (motionMomentum < 0.02) motionMomentum = 0;

      if (currentDir !== 0){
        headBob += bobDirection * 0.25 * motionMomentum;
        if (headBob > 2 || headBob < -2) bobDirection *= -1;
      } else {
        headBob *= 0.85 * (motionMomentum || 0.2);
      }

      if (strafe !== 0){
        strafeOffset += strafe * 4;
        strafeOffset = clamp(strafeOffset, -STRAFE_MAX, STRAFE_MAX);
      } else {
        strafeOffset *= 0.9;
      }

      // ‚úÖ Look-around inertia + spring to center
      if (!isLooking){
        lookVX *= LOOK_FRICTION;
        lookVY *= LOOK_FRICTION;

        lookVX += (-lookX) * LOOK_SPRING;
        lookVY += (-lookY) * LOOK_SPRING;

        lookX = clamp(lookX + lookVX, -LOOK_MAX_X, LOOK_MAX_X);
        lookY = clamp(lookY + lookVY, -LOOK_MAX_Y, LOOK_MAX_Y);
      }

      const time = Date.now();
      const swayX = Math.sin(time * 0.002) * 2;
      const swayY = Math.cos(time * 0.0015) * 1.5;
      const walkIntensity = Math.abs(currentDir) > 0 ? motionMomentum : 0.25;

      // ‚úÖ Combine: movement sway + strafe + look-around
      const baseX = (strafeOffset*0.25 + swayX*walkIntensity);
      const baseY = (headBob*1.4 + swayY*walkIntensity);

      const finalX = baseX + lookX;
      const finalY = baseY + lookY;

      video.style.transform = `translate(${finalX}px, ${finalY}px) scale(${LOOK_ZOOM})`;

      avatarWrapper.style.transform = `translate(calc(-50% + ${strafeOffset}px), 0px)`;

      const shadowScale = 1 + Math.abs(headBob) * 0.04;
      shadowEl.style.transform = `translateX(-50%) scale(${shadowScale})`;

      walkVignette.style.opacity = walkIntensity > 0.1 ? walkIntensity * 0.7 : 0;

      footstepAudio.volume = Math.min(0.9, Math.abs(currentDir) * 0.7 + Math.abs(strafe) * 0.3);

      // ‚úÖ re-apply settings occasionally to handle force-visible window ending
      if (time >= nextSettingsTick){
        nextSettingsTick = time + 400;
        applySettings();
      }

      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    function setAutoWalk(on){
      autoWalkEnabled = on;

      if (autoWalkEnabled){
        currentDir = 1;
        playForward();
        setAvatarState();
        updateFootsteps();
        onWalkStart();

        autoWalkDockBtn.classList.add("on");
        autoWalkLabel.textContent = "Auto Walk: ON";
      } else {
        currentDir = 0;
        motionMomentum = 0.8;
        cancelReverseLoop();
        video.pause();
        setAvatarState();
        updateFootsteps();
        applySettings();

        autoWalkDockBtn.classList.remove("on");
        autoWalkLabel.textContent = "Auto Walk";
      }
    }

    function cancelAutoWalkIfUserMoves(){
      if (!autoWalkEnabled) return;
      setAutoWalk(false);
    }

    autoWalkDockBtn.addEventListener("click", () => {
      if (!audioUnlocked) unlockAudio();
      setAutoWalk(!autoWalkEnabled);
      applySettings();
    });

    /* =========================================================
       ‚úÖ Streets drawer
    ========================================================= */
    let lastFocusBeforeDrawer = null;

    function openStreetsDrawer() {
      lastFocusBeforeDrawer = document.activeElement;
      document.activeElement?.blur?.();

      ensureOverlayParent(streetsDrawerOverlay);
      streetsDrawerOverlay.style.display = "block";
      streetsDrawerOverlay.setAttribute("aria-hidden", "false");

      setCanvasTouchForOverlay(true);

      streetsSearch.value = "";
      renderStreetsList("");

      setTimeout(() => streetsSearch?.focus?.({ preventScroll:true }), 0);
    }

    function closeStreetsDrawer() {
      document.activeElement?.blur?.();

      streetsDrawerOverlay.style.display = "none";
      streetsDrawerOverlay.setAttribute("aria-hidden", "true");
      restoreOverlayToBody(streetsDrawerOverlay);

      setCanvasTouchForOverlay(false);

      if (lastFocusBeforeDrawer && document.contains(lastFocusBeforeDrawer)) {
        lastFocusBeforeDrawer.focus({ preventScroll: true });
      } else {
        streetsBtn?.focus({ preventScroll: true });
      }
    }

    streetsBtn.addEventListener("click", openStreetsDrawer);
    streetsDrawerClose.addEventListener("click", closeStreetsDrawer);

    streetsDrawerOverlay.addEventListener("pointerdown", (e) => {
      if (e.target === streetsDrawerOverlay) closeStreetsDrawer();
    }, { passive: true });

    $("streetsDrawer").addEventListener("pointerdown", (e) => e.stopPropagation(), { passive: true });

    streetsSearch.addEventListener("input", () => {
      renderStreetsList(streetsSearch.value || "");
    });

    function renderStreetsList(query) {
      const q = (query || "").trim().toLowerCase();

      const rows = [];
      STREETS.forEach((s, i) => {
        const name = (s?.name || "").toLowerCase();
        const city = (s?.city || "").toLowerCase();
        const country = (s?.country || "").toLowerCase();
        if (q && !(name.includes(q) || city.includes(q) || country.includes(q))) return;
        rows.push({ s, i });
      });

      streetsList.innerHTML = rows.map(({ s, i }) => {
        const active = (i === currentIndex) ? "active" : "";
        const meta = `${s.city || ""}${s.country ? ", " + s.country : ""}`.trim();
        return `
          <div class="street-item ${active}" data-index="${i}">
            <div class="name">${escapeHtml(s.name || "Street")}</div>
            <div class="meta">üìç ${escapeHtml(meta || "Unknown location")}</div>
          </div>
        `;
      }).join("");

      streetsList.querySelectorAll(".street-item").forEach(el => {
        el.addEventListener("click", () => {
          const i = parseInt(el.dataset.index, 10);
          if (!Number.isNaN(i)) {
            closeStreetsDrawer();
            loadStreetByIndex(i);
          }
        });
      });
    }

    /* =========================================================
       Popup card
    ========================================================= */
    streetNameEl.addEventListener("click", () => {
      const name = streetNameEl.textContent || "";
      const st = STREETS.find(s => (s?.name || "") === name);
      if (!st) return;

      popupTitle.textContent = st.name || "Street";
      popupCity.textContent = `üìç ${st.city || ""}${st.country ? ", " + s.country : ""}`; // (kept for safety below)
      // fix the tiny typo above (s undefined) -> use st:
      popupCity.textContent = `üìç ${st.city || ""}${st.country ? ", " + st.country : ""}`;
      popupCategory.textContent = st.category ? `üè∑ Category: ${st.category}` : "üè∑ No category";
      popupDescription.textContent = st.description || "No description added.";

      ensureOverlayParent(popupCard);
      popupCard.style.display = "flex";
      setCanvasTouchForOverlay(true);
    });

    popupClose.addEventListener("click", () => {
      popupCard.style.display = "none";
      restoreOverlayToBody(popupCard);
      setCanvasTouchForOverlay(false);
    });
    popupCard.addEventListener("click", (e) => {
      if (e.target === popupCard) {
        popupCard.style.display = "none";
        restoreOverlayToBody(popupCard);
        setCanvasTouchForOverlay(false);
      }
    });

    function updateOrientationGate() {
      const isMobile = window.innerWidth <= 768;
      const isPortrait = window.innerHeight >= window.innerWidth;
      orientationGate.style.display = (isMobile && isPortrait) ? "flex" : "none";
    }
    updateOrientationGate();
    window.addEventListener("resize", updateOrientationGate);
    window.addEventListener("orientationchange", updateOrientationGate);

    /* =========================================================
       Fullscreen
    ========================================================= */
    const ICON_ENTER = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M16 3h3a2 2 0 0 1 2 2v3"/>
        <path d="M8 21H5a2 2 0 0 1-2-2v-3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/>
      </svg>`;
    const ICON_EXIT = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M9 3H5a2 2 0 0 0-2 2v4"/><path d="M15 3h4a2 2 0 0 1 2 2v4"/>
        <path d="M3 15v4a2 2 0 0 0 2 2h4"/><path d="M21 15v4a2 2 0 0 1-2 2h-4"/>
      </svg>`;

    function fsElement() {
      return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement || null;
    }
    function canFullscreen() {
      const el = viewerPanel || viewerCanvas || document.documentElement;
      return !!(el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen);
    }
    async function requestFullscreenOn(el) {
      try {
        if (el.requestFullscreen) return await el.requestFullscreen({ navigationUI: "hide" });
        if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
        if (el.msRequestFullscreen) return el.msRequestFullscreen();
      } catch (err) { if (DEBUG) console.log("Fullscreen error:", err); }
    }
    async function exitFullscreen() {
      try {
        if (document.exitFullscreen) return await document.exitFullscreen();
        if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
        if (document.msExitFullscreen) return document.msExitFullscreen();
      } catch (err) { if (DEBUG) console.log("Exit fullscreen error:", err); }
    }

    function updateFullscreenButton() {
      if (!fullscreenBtn) return;

      if (!canFullscreen()) {
        fullscreenBtn.style.opacity = "0.45";
        fullscreenBtn.style.pointerEvents = "none";
        fsIcon.innerHTML = ICON_ENTER;
        fsLabel.textContent = "No FS";
        return;
      }

      const active = !!fsElement();
      fsIcon.innerHTML = active ? ICON_EXIT : ICON_ENTER;
      fsLabel.textContent = active ? "Exit" : "Fullscreen";
      fullscreenBtn.style.opacity = "1";
      fullscreenBtn.style.pointerEvents = "auto";
    }

    updateFullscreenButton();
    document.addEventListener("fullscreenchange", () => { updateFullscreenButton(); syncFsClass(); });
    document.addEventListener("webkitfullscreenchange", () => { updateFullscreenButton(); syncFsClass(); });

    fullscreenBtn.addEventListener("click", async (e) => {
      e.preventDefault();

      if (settingsPanel.classList.contains("open")) settingsPanel.classList.remove("open");
      if (streetsDrawerOverlay.style.display === "block") closeStreetsDrawer();
      if (popupCard.style.display === "flex") {
        popupCard.style.display = "none";
        restoreOverlayToBody(popupCard);
        setCanvasTouchForOverlay(false);
      }
      if (fullMapOverlay.style.display === "flex") {
        fullMapOverlay.style.display = "none";
        restoreOverlayToBody(fullMapOverlay);
        setCanvasTouchForOverlay(false);
      }

      const active = !!fsElement();
      if (!active) {
        const target = viewerPanel || viewerCanvas || document.documentElement;
        await requestFullscreenOn(target);
      } else {
        await exitFullscreen();
      }

      updateFullscreenButton();
      setViewportHeightVar();
      syncFsClass();
      setTimeout(() => { if (fullMap) fullMap.resize(); }, 220);
    });

    /* =========================================================
       Map overlay
    ========================================================= */
    function updateMapMarkerHighlight() {
      markerEls.forEach(({ el, index }) => {
        el.classList.toggle("map-marker-selected", index === currentIndex);
      });
    }

    function loadMap() {
      if (fullMapReady) return;
      if (typeof maplibregl === "undefined") return;

      fullMap = new maplibregl.Map({
        container: "fullMapContainer",
        style: "{{ map_style_url or 'https://api.maptiler.com/maps/streets/style.json?key=PqdU3M5vnOQK0dDQnkIq' }}",
        center: [0, 20],
        zoom: 2,
        pitch: 45,
        bearing: -20
      });

      fullMap.addControl(new maplibregl.NavigationControl());

      STREETS.forEach((s, i) => {
        const lat = parseFloat(s?.lat);
        const lng = parseFloat(s?.lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

        const el = document.createElement("div");
        Object.assign(el.style, {
          width: "18px",
          height: "18px",
          borderRadius: "50%",
          background: "#3b82f6",
          border: "2px solid white",
          cursor: "pointer"
        });

        const popup = new maplibregl.Popup({ offset: 16 }).setHTML(
          `<div style="font-size:12px;color:#0f172a;">
            <strong>${escapeHtml(s.name || "Street")}</strong><br/>
            <span>${escapeHtml((s.city || "") + (s.country ? ", " + s.country : ""))}</span>
          </div>`
        );

        const marker = new maplibregl.Marker({ element: el })
          .setLngLat([lng, lat])
          .setPopup(popup)
          .addTo(fullMap);

        markerEls.push({ index: i, el, marker });

        el.addEventListener("click", () => {
          loadStreetByIndex(i);
          updateMapMarkerHighlight();

          const coords = marker.getLngLat();
          fullMap.flyTo({ center: [coords.lng, coords.lat], zoom: 13, speed: 0.9 });

          popup.addTo(fullMap);

          fullMapOverlay.style.display = "none";
          restoreOverlayToBody(fullMapOverlay);
          setCanvasTouchForOverlay(false);
        });
      });

      if (currentIndex !== -1 && STREETS[currentIndex]) {
        const st = STREETS[currentIndex];
        const lat = parseFloat(st.lat), lng = parseFloat(st.lng);
        if (Number.isFinite(lat) && Number.isFinite(lng)) {
          fullMap.flyTo({ center: [lng, lat], zoom: 8, speed: 0.9 });
        }
      }

      fullMapReady = true;
    }

    function openMapOverlay() {
      ensureOverlayParent(fullMapOverlay);
      fullMapOverlay.style.display = "flex";
      setCanvasTouchForOverlay(true);
      loadMap();
      setTimeout(() => { if (fullMap) fullMap.resize(); }, 120);
    }

    $("miniMap").addEventListener("click", openMapOverlay);

    closeMapBtn.addEventListener("click", () => {
      fullMapOverlay.style.display = "none";
      restoreOverlayToBody(fullMapOverlay);
      setCanvasTouchForOverlay(false);
    });

    fullMapOverlay.addEventListener("click", (e) => {
      if (e.target === fullMapOverlay) {
        fullMapOverlay.style.display = "none";
        restoreOverlayToBody(fullMapOverlay);
        setCanvasTouchForOverlay(false);
      }
    });

    /* toast */
    function showDeviceToastOnce() {
      const isSmall = window.innerWidth < 980;
      const already = localStorage.getItem("abto_device_toast_dismissed") === "1";
      if (!isSmall || already) return;
      deviceToast.style.display = "flex";
    }
    showDeviceToastOnce();

    toastClose.addEventListener("click", () => {
      deviceToast.style.display = "none";
      localStorage.setItem("abto_device_toast_dismissed", "1");
    });

    /* error banner */
    if (errorBanner && errorBanner.dataset.error) {
      if (errorBannerClose) {
        errorBannerClose.addEventListener("click", () => {
          errorBanner.style.opacity = "0";
          errorBanner.style.pointerEvents = "none";
          setTimeout(() => { errorBanner.style.display = "none"; }, 220);
        });
      }
      setTimeout(() => {
        errorBanner.style.opacity = "0";
        errorBanner.style.pointerEvents = "none";
        setTimeout(() => { errorBanner.style.display = "none"; }, 220);
      }, 7000);
    }

    /* =========================================================
       ‚úÖ SETTINGS: open/close + apply
    ========================================================= */
    function closeSettingsPanel(){ settingsPanel.classList.remove("open"); }
    function toggleSettingsPanel(){ settingsPanel.classList.toggle("open"); }

    settingsBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();

      if (streetsDrawerOverlay?.style.display === "block") closeStreetsDrawer();
      if (fullMapOverlay?.style.display === "flex") {
        fullMapOverlay.style.display = "none";
        restoreOverlayToBody(fullMapOverlay);
        setCanvasTouchForOverlay(false);
      }
      if (popupCard?.style.display === "flex") {
        popupCard.style.display = "none";
        restoreOverlayToBody(popupCard);
        setCanvasTouchForOverlay(false);
      }

      toggleSettingsPanel();
    });

    document.addEventListener("pointerdown", (e) => {
      if (!settingsPanel.classList.contains("open")) return;
      const insidePanel = settingsPanel.contains(e.target);
      const insideBtn = settingsBtn.contains(e.target);
      if (!insidePanel && !insideBtn) closeSettingsPanel();
    }, { passive:true });

    function applySettings(){
      video.muted = !!setVideoMuted.checked;

      if (!reversePlaying && !video.paused){
        video.playbackRate = setVideoSlow.checked ? 0.5 : 1;
      }

      nightOverlay.style.opacity = setNightMode.checked ? "1" : "0";

      const hideAll = !!setHideAvatar.checked;
      avatarWrapper.style.display = hideAll ? "none" : "block";
      shadowEl.style.display = hideAll ? "none" : "block";

      if (hideAll) return;

      const walkingNow = (currentDir !== 0);
      const wantHideWhileWalk = !!setWalkNoAvatar.checked;
      const forceVisible = isForceAvatarVisible();

      if (wantHideWhileWalk && walkingNow && !forceVisible){
        avatarWrapper.style.opacity = "0";
        shadowEl.style.opacity = "0";
      } else {
        avatarWrapper.style.opacity = "1";
        shadowEl.style.opacity = "1";
      }
    }

    [setVideoMuted, setVideoSlow, setHideAvatar, setWalkNoAvatar, setNightMode].forEach(el=>{
      el?.addEventListener("change", applySettings);
    });

    /* =========================================================
       ‚úÖ GENDER SWITCH (kept)
    ========================================================= */
    const genderBtns = document.querySelectorAll(".gender-buttons button");
    function setGender(g){
      currentGender = (g === "female") ? "female" : "male";
      genderBtns.forEach(b => b.classList.toggle("active", b.dataset.gender === currentGender));
      setAvatarState();

      revealAvatarTemporarily(1600);
      showAvatarSpeech(currentGender === "female" ? "Switched to female avatar." : "Switched to male avatar.", 1400);
    }
    genderBtns.forEach(btn=>{
      btn.addEventListener("click", () => setGender(btn.dataset.gender));
    });

    /* =========================================================
       ‚úÖ JOYSTICK
    ========================================================= */
    const JOY_RADIUS = 34;
    let joyPointerId = null;

    function setMoveFromJoystick(nx, ny){
      const prevDir = currentDir;

      const dead = 0.18;
      const absX = Math.abs(nx);
      const absY = Math.abs(ny);

      strafe = (absX > dead) ? nx : 0;

      if (absY > dead) currentDir = (ny < 0) ? 1 : -1;
      else currentDir = 0;

      if (currentDir !== 0 || strafe !== 0) cancelAutoWalkIfUserMoves();

      if (currentDir !== prevDir){
        if (currentDir === 1) playForward();
        else if (currentDir === -1) playReverse();
        else { cancelReverseLoop(); video.pause(); }

        setAvatarState();
        updateFootsteps();
        applySettings();

        if (currentDir !== 0) onWalkStart();
      }

      if (currentDir !== 0 || strafe !== 0){
        motionMomentum = Math.min(motionMomentum + 0.12, 1);
      }
    }

    function resetJoystick(){
      joyActive = false;
      joystickBase.classList.remove("joy-active");
      joystickKnob.style.transform = `translate(0px, 0px)`;

      strafe = 0;
      currentDir = 0;
      motionMomentum = 0.6;

      cancelReverseLoop();
      video.pause();
      setAvatarState();
      updateFootsteps();
      applySettings();
    }

    joystickBase?.addEventListener("pointerdown", (e) => {
      e.preventDefault();
      unlockAudio();

      // ‚úÖ prevent look-drag while joystick is used
      if (isLooking) endLook({ pointerId: lookPointerId });

      joyPointerId = e.pointerId;
      joystickBase.setPointerCapture(joyPointerId);

      joyActive = true;
      joystickBase.classList.add("joy-active");
    });

    joystickBase?.addEventListener("pointermove", (e) => {
      if (!joyActive || e.pointerId !== joyPointerId) return;

      const rect = joystickBase.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;

      let dx = e.clientX - cx;
      let dy = e.clientY - cy;

      const dist = Math.hypot(dx, dy);
      if (dist > JOY_RADIUS){
        dx = dx * (JOY_RADIUS / dist);
        dy = dy * (JOY_RADIUS / dist);
      }

      joystickKnob.style.transform = `translate(${dx}px, ${dy}px)`;

      const nx = dx / JOY_RADIUS;
      const ny = dy / JOY_RADIUS;

      setMoveFromJoystick(nx, ny);
    });

    function endJoy(e){
      if (!joyActive) return;
      if (e && joyPointerId !== null && e.pointerId !== joyPointerId) return;

      try{ joystickBase.releasePointerCapture(joyPointerId); }catch(_){}
      joyPointerId = null;
      resetJoystick();
    }

    joystickBase?.addEventListener("pointerup", endJoy);
    joystickBase?.addEventListener("pointercancel", endJoy);
    joystickBase?.addEventListener("pointerleave", endJoy);

    /* Keyboard WASD */
    const keys = new Set();
    function applyKeys(){
      const overlayOpen =
        settingsPanel.classList.contains("open") ||
        streetsDrawerOverlay.style.display === "block" ||
        fullMapOverlay.style.display === "flex" ||
        popupCard.style.display === "flex";

      if (overlayOpen) return;

      let nx = 0, ny = 0;
      if (keys.has("w") || keys.has("arrowup")) ny -= 1;
      if (keys.has("s") || keys.has("arrowdown")) ny += 1;
      if (keys.has("a") || keys.has("arrowleft")) nx -= 1;
      if (keys.has("d") || keys.has("arrowright")) nx += 1;

      const len = Math.hypot(nx, ny);
      if (len > 1){ nx /= len; ny /= len; }

      setMoveFromJoystick(nx, ny);

      if (nx === 0 && ny === 0){
        strafe = 0;
        if (currentDir !== 0){
          currentDir = 0;
          cancelReverseLoop();
          video.pause();
          setAvatarState();
          updateFootsteps();
          applySettings();
        }
      }
    }

    window.addEventListener("keydown", (e) => {
      const k = (e.key || "").toLowerCase();
      if (["w","a","s","d","arrowup","arrowdown","arrowleft","arrowright"].includes(k)){
        e.preventDefault();
        unlockAudio();
        keys.add(k);
        applyKeys();
        if (["w","s","arrowup","arrowdown"].includes(k)) onWalkStart();
      }
    });

    window.addEventListener("keyup", (e) => {
      const k = (e.key || "").toLowerCase();
      if (keys.has(k)){
        keys.delete(k);
        applyKeys();
      }
    });

    /* =========================================================
       ‚úÖ defaults / start
    ========================================================= */
    setGender(currentGender);
    setWalkNoAvatar.checked = true;

    applySettings();
    renderStreetsList("");

    if (SELECTED) {
      const idx = STREETS.findIndex(s => s?._id === SELECTED?._id);
      loadStreetByIndex(idx !== -1 ? idx : 0);
    } else if (Array.isArray(STREETS) && STREETS.length > 0) {
      loadStreetByIndex(0);
    }
  </script>
</body>
</html>
