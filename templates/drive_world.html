<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Drive Mode ‚Äì Virtual Street Drive (Engine B Enhanced)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
:root{
  --bg:#020617;--glass:rgba(15,23,42,0.82);--soft:rgba(15,23,42,0.7);
  --border:rgba(148,163,184,0.45);--text:#e5e7eb;--muted:#9ca3af;--radius:14px;
  --accent:#38bdf8;--accent-glow:0 0 12px rgba(56,189,248,0.4);
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:linear-gradient(135deg,#000,#020617);font-family:system-ui,-apple-system,sans-serif;color:var(--text);overflow:hidden}
.viewer-panel{position:relative;width:100%;height:100vh}
.viewer-canvas{position:relative;width:100%;height:100%;background:#000}

/* Title HUD */
.top-street{
  position:absolute;top:12px;left:50%;transform:translateX(-50%);
  padding:10px 20px;border-radius:24px;background:var(--glass);
  border:1px solid var(--border);backdrop-filter:blur(16px);font-size:14px;
  font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,0.5);z-index:20;
  white-space:nowrap;max-width:75%;overflow:hidden;text-align:center;
  box-shadow:0 8px 32px rgba(0,0,0,0.3);
}

/* Mini map */
.mini-map{position:absolute;top:80px;left:20px;width:96px;height:96px;
  border-radius:50%;border:2px solid var(--border);object-fit:cover;
  cursor:pointer;z-index:20;box-shadow:0 8px 24px rgba(0,0,0,0.4);
  transition:transform 0.2s ease,box-shadow 0.2s ease}
.mini-map:hover{transform:scale(1.05);box-shadow:0 12px 32px rgba(56,189,248,0.3)}
.mini-btn{position:absolute;top:178px;left:20px;padding:8px 16px;
  font-size:11px;border-radius:20px;background:var(--glass);
  border:1px solid var(--border);cursor:pointer;font-weight:600;
  backdrop-filter:blur(12px);transition:all 0.2s ease}
.mini-btn:hover{background:var(--accent);border-color:var(--accent);box-shadow:var(--accent-glow)}

/* Street info */
.street-info{
  position:absolute;bottom:28px;left:20px;padding:12px 16px;
  background:var(--glass);border-radius:var(--radius);font-size:12px;
  border:1px solid var(--border);backdrop-filter:blur(12px);
  box-shadow:0 8px 32px rgba(0,0,0,0.3);font-weight:500}

/* Video */
#streetVideo{
  position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
  transition:transform .2s cubic-bezier(0.4,0,0.2,1),filter .4s ease;
  z-index:1;will-change:transform,filter}

/* Joystick */
#joystickBase{
  position:absolute;bottom:28px;right:24px;width:100px;height:100px;
  border-radius:50%;border:2px solid var(--border);background:var(--glass);
  display:flex;align-items:center;justify-content:center;backdrop-filter:blur(12px);
  touch-action:none;user-select:none;z-index:25;box-shadow:0 12px 40px rgba(0,0,0,0.4);
  transition:box-shadow 0.2s ease}
#joystickBase:active{box-shadow:0 8px 24px rgba(0,0,0,0.6)}
#joystickKnob{width:48px;height:48px;background:linear-gradient(135deg,var(--accent),#1e40af);
  border-radius:50%;box-shadow:0 4px 16px rgba(56,189,248,0.4);transition:all 0.15s ease}

/* Settings */
.settings-anchor{position:absolute;right:24px;bottom:140px;z-index:30}
.settings-fab{width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#1e293b,#334155);
  border:2px solid var(--border);color:var(--text);font-size:22px;cursor:pointer;
  box-shadow:0 8px 24px rgba(0,0,0,0.4);transition:all 0.2s ease}
.settings-fab:hover{transform:scale(1.05);box-shadow:0 12px 32px rgba(56,189,248,0.3)}
.settings-pop{
  position:absolute;right:0;bottom:70px;min-width:220px;background:linear-gradient(135deg,#0f172a,#1e293b);
  border:1px solid var(--border);display:none;padding:16px;border-radius:18px;
  box-shadow:0 20px 60px rgba(0,0,0,0.5);backdrop-filter:blur(20px)}
.settings-pop.open{display:block;animation:slideUp 0.2s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.settings-row{display:flex;justify-content:space-between;align-items:center;font-size:12px;
  margin-bottom:12px;padding:8px 0;border-bottom:1px solid rgba(148,163,184,0.1)}
.settings-row:last-child{border-bottom:none;margin-bottom:0}
.btn-chip{padding:6px 14px;border-radius:20px;border:1px solid var(--border);
  cursor:pointer;font-size:11px;font-weight:500;transition:all 0.2s ease;min-width:50px;text-align:center}
.btn-chip.active{background:linear-gradient(135deg,var(--accent),#0ea5e9);border-color:var(--accent);
  box-shadow:0 0 12px rgba(56,189,248,0.4);color:#fff}
.chip-select{padding:6px 12px;border-radius:20px;border:1px solid var(--border);
  background:var(--glass);color:var(--text);font-size:11px;cursor:pointer}

/* Full Map */
#fullMapOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(12px);
  display:none;align-items:center;justify-content:center;z-index:40}
#fullMapContainer{width:92%;height:85%;background:linear-gradient(135deg,#0b1120,#1e293b);
  border-radius:20px;border:1px solid var(--border);box-shadow:0 0 60px rgba(0,0,0,0.8);
  overflow:hidden;position:relative}
#closeMapBtn{position:absolute;top:24px;right:24px;width:48px;height:48px;
  border-radius:50%;background:linear-gradient(135deg,#1e293b,#334155);color:#fff;
  border:2px solid var(--border);font-size:20px;cursor:pointer;transition:all 0.2s ease;
  box-shadow:0 8px 24px rgba(0,0,0,0.4)}
#closeMapBtn:hover{transform:scale(1.1);box-shadow:var(--accent-glow)}

/* Fade */
#fadeLayer{position:absolute;inset:0;background:linear-gradient(135deg,#000,#1e293b);opacity:0;
  transition:opacity .4s cubic-bezier(0.4,0,0.2,1);z-index:15}

/* Progress bar */
.progress-container{position:absolute;top:60px;left:50%;transform:translateX(-50%);
  width:300px;height:4px;background:var(--soft);border-radius:2px;overflow:hidden;z-index:20;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);display:none}
#progressBar{height:100%;background:linear-gradient(90deg,var(--accent),#60a5fa);
  border-radius:2px;width:0%;transition:width 0.1s ease;box-shadow:0 0 12px var(--accent)}
</style>
</head>

<body>
<!-- FULL MAP -->
<div id="fullMapOverlay">
  <div id="fullMapContainer"></div>
  <button id="closeMapBtn" title="Close Map">‚úï</button>
</div>

<div class="viewer-panel">
  <div class="viewer-canvas">
    <div class="top-street"><span id="hudStreetName">Select a Drive</span></div>

    <div class="progress-container" id="progressContainer">
      <div id="progressBar"></div>
    </div>

    <img id="miniMapStatic" class="mini-map"
         src="{{ url_for('static', filename='img/minimap_placeholder.png') }}"
         title="Click for Full Map" />
    <button id="btnShowMap" class="mini-btn" title="Full Map">üó∫Ô∏è Full Map</button>

    <div class="street-info"><span id="streetSmallLabel">Ready to drive</span></div>

    <video id="streetVideo" preload="metadata" muted playsinline>
      <source id="videoSource" src="">
    </video>

    <div id="joystickBase" title="Drag to drive">
      <div id="joystickKnob"></div>
    </div>

    <div class="settings-anchor">
      <button id="settingsToggle" class="settings-fab" title="Settings">‚öô</button>
      <div id="settingsPop" class="settings-pop">
        <div class="settings-row">
          <span>Auto Drive</span>
          <button id="btnAutoDrive" class="btn-chip">Off</button>
        </div>
        <div class="settings-row">
          <span>Speed</span>
          <select id="speedSelect" class="chip-select">
            <option value="0.5">0.5√ó</option>
            <option value="0.75">0.75√ó</option>
            <option value="1" selected>1√ó</option>
            <option value="1.25">1.25√ó</option>
            <option value="1.5">1.5√ó</option>
            <option value="2">2√ó</option>
            <option value="3">3√ó</option>
          </select>
        </div>
        <div class="settings-row">
          <span>Camera Shake</span>
          <button id="btnShake" class="btn-chip">Off</button>
        </div>
        <div class="settings-row">
          <span>Night Mode</span>
          <button id="btnDayNight" class="btn-chip">Off</button>
        </div>
        <div class="settings-row">
          <span>Engine Volume</span>
          <input type="range" id="engineVolume" min="0" max="1" step="0.1" value="0.55" class="chip-select">
        </div>
      </div>
    </div>

    <div id="fadeLayer"></div>
  </div>
</div>

<!-- DATA -->
<script id="streets-data" type="application/json">{{ streets | tojson | safe }}</script>
<script id="selected-street-data" type="application/json">{{ selected_street | tojson | safe if selected_street else 'null' }}</script>

<script>
/* ---------------------------------------------------------------------
   CORE VARS
------------------------------------------------------------------------*/
const STREETS  = JSON.parse(document.getElementById("streets-data").textContent || "[]");
const SELECTED = JSON.parse(document.getElementById("selected-street-data").textContent || "null");

const video             = document.getElementById("streetVideo");
const vsrc              = document.getElementById("videoSource");
const progressContainer = document.getElementById("progressContainer");
const progressBar       = document.getElementById("progressBar");

let walkSpeed = 1;
let currentStreetIndex = -1;
let currentVideos = [];
let currentVideoIndex = 0;

let keyDir=0, joyDir=0, autoDir=0, currentDir=0;
let reversePlaying=false, autoDrive=false;
let cameraShake=false, nightFilter=false;
let headBob=0, bobDir=1;
let engineVolume = 0.55;

/* ---------------------------------------------------------------------
   AUDIO ENGINE
------------------------------------------------------------------------*/
const engine = new Audio("/static/audio/engine.mp3");
engine.loop = true;
engine.volume = engineVolume;

const revBurst = new Audio("/static/audio/engine_rev.mp3");
revBurst.volume = 0.9;

const wind = new Audio("/static/audio/wind.mp3");
wind.loop = true;
wind.volume = 0;

const reverseTone = new Audio("/static/audio/reverse.mp3");
reverseTone.loop = true;
reverseTone.volume = 0;

const tireScreech = new Audio("/static/audio/tires.mp3");
tireScreech.volume = 0.7;

Promise.all([
  engine.play().catch(()=>{}),
  wind.play().catch(()=>{}),
  reverseTone.play().catch(()=>{})
]);

function updateEngineSound(){
  const speed = walkSpeed * Math.abs(currentDir);
  engine.playbackRate = Math.max(0.8, 1 + speed * 0.45);
  engine.volume       = currentDir === 0 ? 0.25 : Math.min(0.75, engineVolume * (speed * 0.8 + 0.2));
  wind.volume         = Math.max(0, (engine.playbackRate - 1) * 0.6);
  reverseTone.volume  = currentDir === -1 ? Math.min(0.7, engineVolume * 0.8) : 0;
}
function revEffect(){ revBurst.currentTime=0; revBurst.play().catch(()=>{}); }
function screechEffect(){ tireScreech.currentTime=0; tireScreech.play().catch(()=>{}); }

/* ---------------------------------------------------------------------
   PROGRESS BAR
------------------------------------------------------------------------*/
function updateProgress(){
  if(video.duration){
    const progress = (video.currentTime / video.duration) * 100;
    progressBar.style.width = progress + "%";
  }
}

/* ---------------------------------------------------------------------
   MAP SYSTEM
------------------------------------------------------------------------*/
let fullMap, fullMapReady=false;

function ensureFullMap(){
  if(fullMapReady) return;

  fullMap = new maplibregl.Map({
    container:"fullMapContainer",
    style:"https://demotiles.maplibre.org/style.json",
    center:[0,20], zoom:2.5,
    attributionControl:false
  });
  fullMap.addControl(new maplibregl.NavigationControl({visualizePitch:true}));

  STREETS.forEach((s,i)=>{
    if(s.lat && s.lng){
      const marker = new maplibregl.Marker({color:'#38bdf8'})
        .setLngLat([s.lng,s.lat]).addTo(fullMap);

      const popup = new maplibregl.Popup({closeButton:false})
        .setText(s.name || ("Street " + (i+1)));

      const el = marker.getElement();
      el.style.cursor='pointer';
      el.onmouseenter = ()=>marker.setPopup(popup);
      el.onmouseleave = ()=>marker.removePopup();
      el.onclick = ()=>{ loadStreetByIndex(i); hideFullMap(); };
    }
  });

  fullMapReady=true;
}
function showFullMap(){ fullMapOverlay.style.display="flex"; ensureFullMap(); fullMap.resize(); }
function hideFullMap(){ fullMapOverlay.style.display="none"; }

/* ---------------------------------------------------------------------
   LOAD STREET
------------------------------------------------------------------------*/
function loadStreet(street){
  hudStreetName.textContent = street.name || "Virtual Drive";
  streetSmallLabel.textContent = `${street.city || ""} ${street.country || ""}`;

  currentVideos = (street.videos || []).map(v=>v.url).filter(Boolean);
  currentVideoIndex = 0;

  const minimapUrl = street.minimap || "{{ url_for('static', filename='img/minimap_placeholder.png') }}";
  miniMapStatic.src = minimapUrl;

  vsrc.src = currentVideos[0] || "";
  video.load();

  progressContainer.style.display = currentVideos.length > 0 ? "block" : "none";
}
function loadStreetByIndex(i){
  if(i<0 || i>=STREETS.length) return;
  currentStreetIndex=i;
  fadeLayer.style.opacity=1;
  setTimeout(()=>{
    loadStreet(STREETS[i]);
    fadeLayer.style.opacity=0;
  },300);
}

/* ---------------------------------------------------------------------
   PLAYBACK ENGINE
------------------------------------------------------------------------*/
function safePlay(){
  if(video.paused && !reversePlaying){
    video.play().catch(()=>{});
  }
}
function safePause(){
  if(!video.paused && !reversePlaying){
    video.pause();
  }
}
function playForward(){
  if(reversePlaying){ reversePlaying=false; reverseTone.pause(); }
  video.playbackRate = walkSpeed;
  safePlay();
  revEffect();
}
function playReverse(){
  reversePlaying=true;
  safePause();
  reverseTone.currentTime=0;
  reverseTone.play();

  (function step(){
    if(!reversePlaying) return;
    const stepTime = 0.02 * walkSpeed;
    video.currentTime = Math.max(0, video.currentTime - stepTime);
    if(video.currentTime <= 0.01){
      reversePlaying=false;
      safePause();
      return;
    }
    requestAnimationFrame(step);
  })();
}
function recomputeDirection(){
  const newDir = keyDir || joyDir || autoDir;
  if(newDir === currentDir) return;

  if(currentDir !== 0 && newDir !== 0 && newDir !== currentDir){
    screechEffect();
  }

  currentDir = newDir;
  if(newDir === 1)      playForward();
  else if(newDir === -1)playReverse();
  else { safePause(); reversePlaying=false; }

  updateEngineSound();
}

/* ---------------------------------------------------------------------
   KEYBOARD
------------------------------------------------------------------------*/
const keys = {w:0,s:0};
window.addEventListener("keydown",e=>{
  const k=e.key.toLowerCase();
  if(k==="w" && !keys.w){ keys.w=1; keyDir=1; recomputeDirection(); }
  if(k==="s" && !keys.s){ keys.s=1; keyDir=-1; recomputeDirection(); }
  if(k===" "){
    e.preventDefault();
    autoDrive=!autoDrive;
    updateAutoDriveUI();
  }
});
window.addEventListener("keyup",e=>{
  const k=e.key.toLowerCase();
  if(k==="w"){ keys.w=0; if(!keys.s) keyDir=0; recomputeDirection(); }
  if(k==="s"){ keys.s=0; if(!keys.w) keyDir=0; recomputeDirection(); }
});

/* ---------------------------------------------------------------------
   JOYSTICK
------------------------------------------------------------------------*/
function setJoy(ev){
  const r=joystickBase.getBoundingClientRect();
  const dy=(ev.clientY-(r.top+r.height/2))/(r.height/2);
  const clamped = Math.max(-1,Math.min(1,dy));
  joyDir = Math.abs(clamped)>0.15 ? (clamped<0?1:-1) : 0;
  joystickKnob.style.transform = `translateY(${clamped*35}px) scale(${1+Math.abs(clamped)*0.1})`;
  recomputeDirection();
}
joystickBase.onpointerdown=e=>{
  e.preventDefault();
  joystickBase.setPointerCapture(e.pointerId);
  setJoy(e);
};
joystickBase.onpointermove=e=>{
  if(e.buttons!==0) setJoy(e);
};
joystickBase.onpointerup=joystickBase.onpointercancel=()=>{
  joyDir=0;
  joystickKnob.style.transform="translate(0,0) scale(1)";
  recomputeDirection();
};

/* ---------------------------------------------------------------------
   SETTINGS
------------------------------------------------------------------------*/
settingsToggle.onclick=()=>settingsPop.classList.toggle("open");

function updateAutoDriveUI(){
  autoDir = autoDrive ? 1 : 0;
  btnAutoDrive.classList.toggle("active", autoDrive);
  btnAutoDrive.textContent = autoDrive ? "On" : "Off";
  recomputeDirection();
}
btnAutoDrive.onclick=()=>{ autoDrive=!autoDrive; updateAutoDriveUI(); };

speedSelect.onchange=()=>{
  walkSpeed=parseFloat(speedSelect.value);
  if(!video.paused && !reversePlaying){ video.playbackRate=walkSpeed; }
  updateEngineSound();
};
btnShake.onclick=()=>{
  cameraShake=!cameraShake;
  btnShake.classList.toggle("active",cameraShake);
  btnShake.textContent = cameraShake ? "On" : "Off";
};
btnDayNight.onclick=()=>{
  nightFilter=!nightFilter;
  btnDayNight.classList.toggle("active",nightFilter);
  btnDayNight.textContent = nightFilter ? "On" : "Off";
  video.style.filter = nightFilter
    ? "brightness(0.52) contrast(1.25) saturate(0.85) hue-rotate(-15deg)"
    : "none";
};
engineVolume.oninput=e=>{
  engineVolume=parseFloat(e.target.value);
  updateEngineSound();
};

/* ---------------------------------------------------------------------
   CAMERA SHAKE
------------------------------------------------------------------------*/
let shakeIntensity=0;
(function tick(){
  if(currentDir!==0 && cameraShake){
    shakeIntensity = Math.min(shakeIntensity + 0.3*walkSpeed,3.5);
    headBob += bobDir*0.3*walkSpeed*(shakeIntensity/3);
    if(Math.abs(headBob)>shakeIntensity) bobDir*=-1;
  }else{
    shakeIntensity*=0.92;
    headBob*=0.88;
  }
  video.style.transform = `translateY(${headBob.toFixed(1)}px) scale(${1+shakeIntensity*0.002})`;
  requestAnimationFrame(tick);
})();

/* ---------------------------------------------------------------------
   VIDEO EVENTS
------------------------------------------------------------------------*/
video.addEventListener("timeupdate",updateProgress);
video.onloadedmetadata=()=>{
  progressContainer.style.display = currentVideos.length>0 ? "block" : "none";
};
video.onended=()=>{
  if(currentVideos.length>1 && currentVideoIndex<currentVideos.length-1){
    currentVideoIndex++;
    vsrc.src=currentVideos[currentVideoIndex];
    video.load();
    safePlay();
    return;
  }
  safePause();
  currentDir=0;
  updateEngineSound();
};

/* ---------------------------------------------------------------------
   TOUCH SWIPE
------------------------------------------------------------------------*/
let touchStartY=0;
video.addEventListener("touchstart",e=>{
  touchStartY=e.touches[0].clientY;
},{passive:true});
video.addEventListener("touchmove",e=>{
  const dy=e.touches[0].clientY-touchStartY;
  if(Math.abs(dy)>30){
    keyDir = dy<0?1:-1;
    recomputeDirection();
    touchStartY=e.touches[0].clientY;
  }
},{passive:true});
video.addEventListener("touchend",()=>{
  setTimeout(()=>{ keyDir=0; recomputeDirection(); },100);
});

/* ---------------------------------------------------------------------
   INIT
------------------------------------------------------------------------*/
document.addEventListener("DOMContentLoaded",()=>{
  if(SELECTED){
    const idx = STREETS.findIndex(s=>s._id===SELECTED._id);
    loadStreetByIndex(idx>=0?idx:0);
  }else if(STREETS.length>0){
    loadStreetByIndex(0);
  }
});
btnShowMap.onclick = showFullMap;
miniMapStatic.onclick = showFullMap;
closeMapBtn.onclick = hideFullMap;
</script>
</body>
</html>
