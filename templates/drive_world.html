<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Drive Mode ‚Äì Virtual Street Drive (MapTiler HD)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="{{ url_for('static', filename='css/maplibre-gl.css') }}">
<script src="{{ url_for('static', filename='js/maplibre-gl.js') }}"></script>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root{
  --bg:#020617;--glass:rgba(15,23,42,0.82);--soft:rgba(15,23,42,0.7);
  --border:rgba(148,163,184,0.45);--text:#e5e7eb;
  --accent:#38bdf8;
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  background:linear-gradient(135deg,#000,#020617);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--text);overflow:hidden;
}
.viewer-panel{position:relative;width:100%;height:100vh}
.viewer-canvas{
  position:relative;width:100%;height:100%;background:#000;
}

/* bottom soft gradient so HUD & dash pop on bright roads */
.viewer-canvas::after{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(to top, rgba(0,0,0,.45), transparent 35%);
  pointer-events:none;
  z-index:2;
}

/* Mode pill */
.mode-pill{
  position:absolute;top:16px;left:20px;
  padding:8px 14px;border-radius:999px;
  background:var(--soft);border:1px solid var(--border);
  font-size:11px;letter-spacing:.12em;text-transform:uppercase;
  color:var(--text);z-index:21;opacity:.9;
}

/* Title HUD */
.top-street{
  position:absolute;
  top:18px;
  left:50%;
  transform:translateX(-50%);
  padding:10px 22px;
  border-radius:24px;
  background:var(--glass);
  border:1px solid var(--border);
  backdrop-filter:blur(16px);
  font-size:14px;
  font-weight:700;
  z-index:20;
  text-align:center;
}

/* Mini map */
.mini-map{
  position:absolute;top:80px;left:20px;width:96px;height:96px;
  border-radius:50%;border:2px solid var(--border);object-fit:cover;
  cursor:pointer;z-index:20
}
.mini-btn{
  position:absolute;top:178px;left:20px;padding:8px 16px;
  font-size:11px;border-radius:20px;background:var(--glass);
  border:1px solid var(--border);cursor:pointer;font-weight:600;z-index:20;
  color:var(--text);
}

/* Street info */
.street-info{
  position:absolute;bottom:28px;left:20px;padding:12px 16px;
  background:var(--glass);border-radius:14px;font-size:12px;
  border:1px solid var(--border);z-index:20;
}

/* Controls hint */
.controls-hint{
  position:absolute;bottom:26px;left:50%;transform:translateX(-50%);
  padding:10px 16px;border-radius:999px;
  background:var(--soft);border:1px solid var(--border);
  font-size:11px;color:var(--text);letter-spacing:.08em;
  text-transform:uppercase;display:flex;align-items:center;gap:10px;
  z-index:22;opacity:.94;backdrop-filter:blur(12px);
  transition:opacity .4s ease,transform .4s ease;
  font-weight:600;
  box-shadow:0 12px 30px rgba(15,23,42,.9);
}
.controls-hint span{white-space:nowrap}
.controls-hint.hide{
  opacity:0;transform:translate(-50%,12px);pointer-events:none;
}

/* Video */
#streetVideo{
  position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
  transition:filter .4s ease, opacity .2s ease;z-index:1
}

/* Dashboard overlay (cockpit) with tilt support */
#driveDashOverlay{
  position:absolute;
  left:50%;
  bottom:-120px;
  transform:translateX(-50%) rotate(0deg); /* base state */
  width:70%;
  max-width:900px;
  object-fit:contain;
  pointer-events:none;
  z-index:10;
  transition:transform 0.15s ease-out;
}
/* Mobile tweak for bike overlay */
@media (max-width: 908px){
  #driveDashOverlay{
    bottom:-20px;
    width:100%;
  }
}

/* First street loading overlay */
#videoLoading{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.9);z-index:5;pointer-events:none;
}
#videoLoadingSpinner{
  width:36px;height:36px;border-radius:50%;
  border:3px solid rgba(148,163,184,0.4);
  border-top-color:#38bdf8;
  animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Joystick */
#joystickBase{
  position:absolute;bottom:28px;right:24px;width:100px;height:100px;
  border-radius:50%;border:2px solid var(--border);background:var(--glass);
  display:flex;align-items:center;justify-content:center;touch-action:none;z-index:25
}
#joystickKnob{width:48px;height:48px;background:var(--accent);border-radius:50%}

/* Settings */
.settings-anchor{position:absolute;right:24px;bottom:140px;z-index:30}
.settings-fab{
  width:52px;height:52px;border-radius:50%;background:#1e293b;
  border:2px solid var(--border);color:#fff;font-size:22px;cursor:pointer
}
.settings-pop{
  position:absolute;right:0;bottom:70px;min-width:220px;
  background:#0f172a;border:1px solid var(--border);
  display:none;padding:16px;border-radius:18px;
  box-shadow:0 16px 40px rgba(15,23,42,0.9);
}
.settings-pop.open{display:block}
.settings-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 0;font-size:12px;color:var(--text);
}
.btn-chip{
  padding:6px 14px;border-radius:20px;border:1px solid var(--border);
  cursor:pointer;background:transparent;color:var(--text);
}
.btn-chip.active{background:var(--accent);color:#000;border-color:var(--accent);}
.settings-pop select,
.settings-pop input[type="range"]{
  background:#020617;border-radius:10px;border:1px solid var(--border);
  color:var(--text);padding:4px 8px;font-size:12px;outline:none;
}

/* FULL MAP OVERLAY */
#fullMapOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.85);
  display:none;align-items:center;justify-content:center;z-index:50
}
#fullMapContainer{
  width:90%;height:85%;background:#0b1120;border-radius:20px;overflow:hidden;
  border:1px solid var(--border)
}
#closeMapBtn{
  position:absolute;top:20px;right:20px;padding:10px 16px;
  border-radius:10px;border:none;background:#1e293b;color:#fff;
  font-size:18px;cursor:pointer;z-index:100
}
#fullMapContainer *{box-sizing:border-box}
#fullMapContainer canvas{
  width:100%!important;height:100%!important;display:block;
}
.map-header{
  position:absolute;top:20px;left:20px;
  padding:8px 14px;border-radius:999px;
  background:var(--glass);border:1px solid var(--border);
  font-size:11px;color:var(--text);letter-spacing:.06em;
  text-transform:uppercase;max-width:60%;z-index:90;
}

/* MOBILE JOYSTICK POSITION */
@media (max-width: 768px) {
  #joystickBase{
    bottom:140px!important;right:16px;width:90px;height:90px;
  }
  #joystickKnob{width:44px;height:44px}
  .settings-anchor{right:16px;bottom:240px}
  .street-info{
    bottom:20px;left:16px;max-width:65%;
  }
  .controls-hint{
    bottom:110px;
    font-size:10px;
    padding:8px 12px;
  }
}

/* STREET POPUP */
#streetPopup{
  position:fixed;inset:0;background:rgba(0,0,0,0.65);
  backdrop-filter:blur(6px);display:none;align-items:center;
  justify-content:center;z-index:200;
}
#streetPopupCard{
  width:90%;max-width:420px;background:rgba(15,23,42,0.92);
  border:1px solid rgba(148,163,184,0.4);padding:26px;border-radius:18px;
  animation:popupFade .3s ease;
}
#streetPopupCard h2{
  margin:0 0 10px 0;font-size:22px;color:var(--accent)
}
#streetPopupCard p{
  margin:6px 0;font-size:14px;color:var(--text)
}
#popupClose{
  margin-top:16px;padding:10px 22px;background:var(--accent);
  border:none;border-radius:10px;color:#000;font-weight:700;
  cursor:pointer;width:100%;
}
@keyframes popupFade{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:translateY(0)}
}

/* Markers */
.map-marker{
  width:16px;height:16px;border-radius:50%;
  background:#2563eb;border:2px solid #fff;
  box-shadow:0 0 8px rgba(37,99,235,0.7);
}
.map-marker-selected{
  width:22px;height:22px;background:#38bdf8;
  box-shadow:0 0 18px rgba(56,189,248,0.9);
}
</style>
</head>

<body>

<!-- FULL MAP -->
<div id="fullMapOverlay">
  <div id="mapHeader" class="map-header"></div>
  <div id="fullMapContainer"></div>
  <button id="closeMapBtn">‚úï</button>
</div>

<div class="viewer-panel" id="viewerRoot">
  <div class="viewer-canvas">

    <div class="mode-pill">ABTO ‚Ä¢ DRIVE MODE</div>
    <div class="top-street"><span id="hudStreetName">Select a Drive</span></div>
    <div id="controlsHint" class="controls-hint"></div>

    <img id="miniMapStatic" class="mini-map" src="{{ url_for('static', filename='img/minimap_placeholder.png') }}" alt="Open map">
    <button id="btnShowMap" class="mini-btn">Full Map</button>

    <div class="street-info"><span id="streetSmallLabel">Ready to drive</span></div>

    <!-- Video background -->
    <video id="streetVideo" preload="metadata" muted playsinline>
      <source id="videoSource" src="">
    </video>

    <!-- Dashboard cockpit overlay -->
    <img
      id="driveDashOverlay"
      src="{{ url_for('static', filename='img/dash.png') }}"
      alt="Drive cockpit overlay"
    />

    <!-- first street loading overlay -->
    <div id="videoLoading">
      <div id="videoLoadingSpinner"></div>
    </div>

    <div id="joystickBase"><div id="joystickKnob"></div></div>

    <div class="settings-anchor">
      <button id="settingsToggle" class="settings-fab">‚öô</button>
      <div id="settingsPop" class="settings-pop">
        <div class="settings-row">
          <span>Auto Drive</span>
          <button id="btnAutoDrive" class="btn-chip">Off</button>
        </div>
        <div class="settings-row">
          <span>Speed</span>
          <select id="speedSelect">
            <option value="0.75">0.75√ó</option>
            <option value="1" selected>1√ó</option>
            <option value="1.5">1.5√ó</option>
            <option value="2">2√ó</option>
          </select>
        </div>
        <div class="settings-row">
          <span>Night Filter</span>
          <button id="btnDayNight" class="btn-chip">Off</button>
        </div>
        <div class="settings-row">
          <span>Engine Volume</span>
          <input type="range" id="engineVolume" min="0" max="1" step="0.1" value="0.55">
        </div>
      </div>
    </div>

    <!-- STREET DESCRIPTION POPUP -->
    <div id="streetPopup">
      <div id="streetPopupCard">
        <h2 id="popupTitle"></h2>
        <p id="popupCity"></p>
        <p id="popupCategory"></p>
        <p id="popupDescription"></p>
        <button id="popupClose">Close</button>
      </div>
    </div>

  </div>
</div>

<script id="streets-data" type="application/json">{{ streets | tojson | safe }}</script>
<script id="selected-street-data" type="application/json">{{ selected_street | tojson | safe if selected_street else 'null' }}</script>

<script>
/* ========== BASIC REFERENCES ========== */
const STREETS  = JSON.parse(document.getElementById("streets-data").textContent || "[]");
const SELECTED = JSON.parse(document.getElementById("selected-street-data").textContent || "null");

const viewerRoot       = document.getElementById("viewerRoot");
const video            = document.getElementById("streetVideo");
const vSource          = document.getElementById("videoSource");
const hudStreetName    = document.getElementById("hudStreetName");
const streetSmallLabel = document.getElementById("streetSmallLabel");
const joystickBase     = document.getElementById("joystickBase");
const joystickKnob     = document.getElementById("joystickKnob");
const videoLoading     = document.getElementById("videoLoading");
const fullMapOverlay   = document.getElementById("fullMapOverlay");
const fullMapContainer = document.getElementById("fullMapContainer");
const closeMapBtn      = document.getElementById("closeMapBtn");
const dashOverlay      = document.getElementById("driveDashOverlay");
const mapHeader        = document.getElementById("mapHeader");

/* Tilt state for overlay */
let tiltAngle = 0;
const MAX_TILT = 7;      // degrees
const TILT_STEP = 2.5;

/* State */
let currentIndex   = 0;
let fullMapReady   = false;
let fullMap        = null;
let markerEls      = [];

let walkSpeed      = 1;
let currentDir     = 0;
let keyDir = 0, joyDir = 0, autoDir = 0;
let autoDrive      = false;
let nightFilter    = false;
let engineVol      = 0.55;

let currentVideos      = [];
let currentVideoIndex  = 0;
let isFirstStreetLoad  = true;

let reverseRaf = null;

/* ========== CONTROLS HINT ========== */
function initControlsHint(){
  const hintEl = document.getElementById("controlsHint");
  if (!hintEl) return;
  const isTouch = ("ontouchstart" in window) || (navigator.maxTouchPoints > 0);
  if (isTouch){
    hintEl.innerHTML = `
      <span>DRAG JOYSTICK TO DRIVE</span>
      <span>‚Ä¢</span>
      <span>TAP MAP TO CHANGE STREET</span>
    `;
  } else {
    hintEl.innerHTML = `
      <span>W / ‚Üë DRIVE</span>
      <span>‚Ä¢</span>
      <span>S / ‚Üì REVERSE</span>
      <span>‚Ä¢</span>
      <span>‚Üê ‚Üí LEAN</span>
    `;
  }
  setTimeout(() => hintEl.classList.add("hide"), 9000);
}

/* ========== ENGINE AUDIO (LIGHT) ========== */
const engine = new Audio("/static/audio/engine.mp3");
engine.loop   = true;
engine.volume = engineVol;
engine.play().catch(()=>{}); // will be retried on user interaction

function updateEngineSound(){
  const sp = walkSpeed * Math.abs(currentDir);
  engine.playbackRate = 1 + sp * 0.4;
  engine.volume       = currentDir ? engineVol : 0.25;
}

/* ========== HLS HANDLING (SIMPLE) ========== */
let hlsInstance = null;

function destroyHls(){
  if (hlsInstance){
    hlsInstance.destroy();
    hlsInstance = null;
  }
}

function playVideoSource(url){
  destroyHls();
  if (!url){
    video.removeAttribute("src");
    vSource.removeAttribute("src");
    video.load();
    return;
  }

  const isHls = url.includes(".m3u8");
  video.pause();
  video.currentTime = 0;
  video.style.opacity = 0.01;

  if (isHls && video.canPlayType("application/vnd.apple.mpegurl")){
    video.src = url;
    video.load();
  } else if (isHls && window.Hls && Hls.isSupported()){
    hlsInstance = new Hls({ maxBufferLength: 10, maxMaxBufferLength: 30 });
    hlsInstance.loadSource(url);
    hlsInstance.attachMedia(video);
  } else {
    video.src = url;
    video.load();
  }

  video.pause();
}

/* ========== STREET VIDEO LIST ========== */
function buildVideoList(st){
  const list = [];
  if (Array.isArray(st.videos)){
    st.videos.forEach(v => { if (v && v.url) list.push(v.url); });
  }
  if (!list.length && st.videoUrl) list.push(st.videoUrl);
  return list;
}

/* ========== LOAD STREET ========== */
function loadStreet(st){
  if (!st) return;

  hudStreetName.textContent = st.name || "Drive";

  if (st.city || st.country){
    const parts = [];
    if (st.city) parts.push(st.city);
    if (st.country) parts.push(st.country);
    streetSmallLabel.textContent = parts.join(", ");
  } else {
    streetSmallLabel.textContent = "Press W / joystick up to start driving";
  }

  currentVideos     = buildVideoList(st);
  currentVideoIndex = 0;

  if (isFirstStreetLoad){
    videoLoading.style.display = "flex";
    video.style.opacity = 0;
  }

  if (currentVideos.length){
    playVideoSource(currentVideos[0]);
  } else {
    playVideoSource(null);
  }
}

function loadStreetByIndex(i){
  if (!STREETS.length) return;
  if (i < 0 || i >= STREETS.length) i = 0;
  currentIndex = i;
  loadStreet(STREETS[i]);
  focusOnCurrentStreet();
}

/* ========== DRIVE / CONTROLS ========== */
function safePause(){
  if (!video.paused) video.pause();
}

function cancelReverse(){
  if (reverseRaf){
    cancelAnimationFrame(reverseRaf);
    reverseRaf = null;
  }
}

function startReverse(){
  cancelReverse();
  const loop = () => {
    if (currentDir !== -1){
      reverseRaf = null;
      return;
    }
    if (video.readyState >= 2){
      if (video.currentTime <= 0){
        reverseRaf = null;
        return;
      }
      video.pause();
      video.currentTime = Math.max(0, video.currentTime - 0.04); // scrub backwards
    }
    reverseRaf = requestAnimationFrame(loop);
  };
  reverseRaf = requestAnimationFrame(loop);
}

/* start forward only when data ready */
function playForward(){
  const start = () => {
    video.playbackRate = walkSpeed;
    video.play().catch(()=>{});
  };
  if (video.readyState >= 2){
    start();
  } else {
    video.addEventListener("loadeddata", start, { once:true });
  }
}

function playReverse(){
  startReverse();
}

function recomputeDirection(){
  const newDir = keyDir || joyDir || autoDir;
  if (newDir === currentDir) return;
  currentDir = newDir;

  if (newDir === 1){
    cancelReverse();
    playForward();
  } else if (newDir === -1){
    playReverse();
  } else {
    cancelReverse();
    safePause();
  }

  updateEngineSound();
}

/* Keyboard */
window.addEventListener("keydown", e => {
  const k = e.key;

  // Close map with Esc
  if (k === "Escape" && fullMapOverlay.style.display === "flex"){
    fullMapOverlay.style.display = "none";
    return;
  }

  // ensure engine tries to play on first user gesture
  if (engine.paused){
    engine.play().catch(()=>{});
  }

  // forward / reverse
  if (k === "w" || k === "ArrowUp"){ keyDir = 1;  recomputeDirection(); }
  if (k === "s" || k === "ArrowDown"){ keyDir = -1; recomputeDirection(); }

  // lean left/right
  if (k === "ArrowLeft"){
    tiltAngle = Math.max(-MAX_TILT, tiltAngle - TILT_STEP);
    dashOverlay.style.transform = `translateX(-50%) rotate(${tiltAngle}deg)`;
  }
  if (k === "ArrowRight"){
    tiltAngle = Math.min(MAX_TILT, tiltAngle + TILT_STEP);
    dashOverlay.style.transform = `translateX(-50%) rotate(${tiltAngle}deg)`;
  }
});

window.addEventListener("keyup", e => {
  const k = e.key;
  if (["w","s","ArrowUp","ArrowDown"].includes(k)){
    keyDir = 0; recomputeDirection();
  }

  // release lean back to center
  if (k === "ArrowLeft" || k === "ArrowRight"){
    tiltAngle = 0;
    dashOverlay.style.transform = "translateX(-50%) rotate(0deg)";
  }
});

/* Joystick */
joystickBase.onpointerdown = e => {
  joystickBase.setPointerCapture(e.pointerId);
  if (engine.paused){
    engine.play().catch(()=>{});
  }
  moveJoy(e);
};
joystickBase.onpointermove = e => {
  if (e.buttons) moveJoy(e);
};
joystickBase.onpointerup = () => {
  joyDir = 0;
  joystickKnob.style.transform = "translateY(0)";
  recomputeDirection();
};

function moveJoy(e){
  const r  = joystickBase.getBoundingClientRect();
  const dy = (e.clientY - (r.top + r.height/2)) / (r.height/2);
  const c  = Math.max(-1, Math.min(1, dy));
  joyDir   = Math.abs(c) > 0.2 ? (c < 0 ? 1 : -1) : 0;
  joystickKnob.style.transform = `translateY(${c * 35}px)`;
  recomputeDirection();
}

/* Settings */
const settingsToggle = document.getElementById("settingsToggle");
const settingsPop    = document.getElementById("settingsPop");
const btnAutoDrive   = document.getElementById("btnAutoDrive");
const speedSelect    = document.getElementById("speedSelect");
const btnDayNight    = document.getElementById("btnDayNight");
const engineVolume   = document.getElementById("engineVolume");

settingsToggle.onclick = () => settingsPop.classList.toggle("open");

btnAutoDrive.onclick = () => {
  autoDrive = !autoDrive;
  autoDir   = autoDrive ? 1 : 0;
  btnAutoDrive.classList.toggle("active", autoDrive);
  btnAutoDrive.textContent = autoDrive ? "On" : "Off";
  recomputeDirection();
};

speedSelect.onchange = () => {
  walkSpeed = parseFloat(speedSelect.value) || 1;
  video.playbackRate = walkSpeed;
  updateEngineSound();
};

btnDayNight.onclick = () => {
  nightFilter = !nightFilter;
  btnDayNight.classList.toggle("active", nightFilter);
  video.style.filter = nightFilter ? "brightness(0.55) contrast(1.2)" : "none";
};

engineVolume.oninput = e => {
  engineVol = parseFloat(e.target.value) || 0;
  updateEngineSound();
};

/* ========== MAPLIBRE (LAZY) ========== */
function loadMap(){
  if (!STREETS.length) return;
  if (!fullMapReady){
    fullMap = new maplibregl.Map({
      container: "fullMapContainer",
      style: "https://demotiles.maplibre.org/style.json",
      center: [0,20],
      zoom: 2,
      renderWorldCopies:false
    });
    fullMap.addControl(new maplibregl.NavigationControl());
    fullMap.on("load", () => {
      addStreetMarkers();
      focusOnCurrentStreet();
    });
    fullMapReady = true;
  } else {
    focusOnCurrentStreet();
  }
}

function addStreetMarkers(){
  markerEls = [];
  STREETS.forEach((s,i) => {
    const lat = Number(s.lat), lng = Number(s.lng);
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

    const el = document.createElement("div");
    el.className = "map-marker";
    if (i === currentIndex) el.classList.add("map-marker-selected");

    new maplibregl.Marker({ element: el })
      .setLngLat([lng,lat])
      .addTo(fullMap);

    el.addEventListener("click", () => {
      currentIndex = i;
      loadStreetByIndex(i);
      focusOnCurrentStreet();
      fullMapOverlay.style.display = "none";
    });

    markerEls.push({ index:i, el });
  });
}

function focusOnCurrentStreet(){
  if (!fullMap || !STREETS.length) return;
  const st = STREETS[currentIndex];
  if (!st) return;
  const lat = Number(st.lat), lng = Number(st.lng);
  if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

  fullMap.flyTo({ center:[lng,lat], zoom:8, speed:0.9 });

  markerEls.forEach(m => {
    if (m.index === currentIndex) m.el.classList.add("map-marker-selected");
    else m.el.classList.remove("map-marker-selected");
  });

  if (mapHeader){
    let loc = "";
    if (st.city || st.country){
      loc = " ‚Äî " + [st.city, st.country].filter(Boolean).join(", ");
    }
    mapHeader.textContent = `Now driving: ${st.name || "Unknown"}${loc}`;
  }
}

/* Map overlay open/close */
document.getElementById("miniMapStatic").onclick = () => {
  fullMapOverlay.style.display = "flex";
  loadMap();
};
document.getElementById("btnShowMap").onclick = () => {
  fullMapOverlay.style.display = "flex";
  loadMap();
};
closeMapBtn.onclick = () => {
  fullMapOverlay.style.display = "none";
};

/* ========== INIT ========== */
document.addEventListener("DOMContentLoaded", () => {
  initControlsHint();
  if (!STREETS.length) return;
  if (SELECTED){
    const idx = STREETS.findIndex(s => s._id === SELECTED._id);
    loadStreetByIndex(idx >= 0 ? idx : 0);
  } else {
    loadStreetByIndex(0);
  }
});

/* ========== AUTO TELEPORT ON END ========== */
video.addEventListener("ended", () => {
  // If multiple clips per street, play next
  if (currentVideos.length > 1 && currentVideoIndex < currentVideos.length - 1){
    currentVideoIndex++;
    playVideoSource(currentVideos[currentVideoIndex]);
    return;
  }

  if (!STREETS.length) return;

  let next = currentIndex + 1;
  if (next >= STREETS.length) next = 0;

  if (viewerRoot){
    viewerRoot.style.transition = "opacity 0.6s";
    viewerRoot.style.opacity    = 0;
  }

  setTimeout(() => {
    loadStreetByIndex(next);
    if (viewerRoot){
      setTimeout(() => { viewerRoot.style.opacity = 1; }, 150);
    }
  }, 500);
});

/* ========== LOADED / ERROR OVERLAY HIDE ========== */
video.addEventListener("loadeddata", () => {
  video.style.opacity = 1;
  if (isFirstStreetLoad){
    videoLoading.style.display = "none";
    isFirstStreetLoad = false;
  }
});
video.addEventListener("error", () => {
  if (isFirstStreetLoad){
    videoLoading.style.display = "none";
    isFirstStreetLoad = false;
  }
});

/* ========== POPUP ========== */
const popup            = document.getElementById("streetPopup");
const popupTitle       = document.getElementById("popupTitle");
const popupCity        = document.getElementById("popupCity");
const popupCategory    = document.getElementById("popupCategory");
const popupDescription = document.getElementById("popupDescription");
const popupClose       = document.getElementById("popupClose");

document.querySelector(".top-street").onclick = () => {
  const name = hudStreetName.textContent;
  const st   = STREETS.find(s => s.name === name) || STREETS[currentIndex];
  if (!st) return;

  popupTitle.textContent = st.name || "Street";
  popupCity.textContent  = (st.city || st.country)
    ? `üìç ${[st.city, st.country].filter(Boolean).join(", ")}`
    : "üìç Location not specified";

  popupCategory.textContent = st.category ? `üè∑ Category: ${st.category}` : "";
  popupDescription.textContent = st.description || "No description added.";
  popup.style.display = "flex";
};
popupClose.onclick = () => popup.style.display = "none";
popup.onclick = e => { if (e.target === popup) popup.style.display = "none"; };
</script>
</body>
</html>
