<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Drive Mode – Virtual Street Drive (MapTiler HD)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- MAPTILER / MAPLIBRE -->
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<style>
:root{
  --bg:#020617;--glass:rgba(15,23,42,0.82);--soft:rgba(15,23,42,0.7);
  --border:rgba(148,163,184,0.45);--text:#e5e7eb;
  --accent:#38bdf8;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:linear-gradient(135deg,#000,#020617);font-family:system-ui;color:var(--text);overflow:hidden}
.viewer-panel{position:relative;width:100%;height:100vh}
.viewer-canvas{position:relative;width:100%;height:100%;background:#000}

/* Title HUD */
.top-street{
  position:absolute;top:12px;left:50%;transform:translateX(-50%);
  padding:10px 20px;border-radius:24px;background:var(--glass);
  border:1px solid var(--border);backdrop-filter:blur(16px);
  font-size:14px;font-weight:700;z-index:20;text-align:center;
}

/* Mini map */
.mini-map{position:absolute;top:80px;left:20px;width:96px;height:96px;
  border-radius:50%;border:2px solid var(--border);object-fit:cover;cursor:pointer;z-index:20}
.mini-btn{position:absolute;top:178px;left:20px;padding:8px 16px;
  font-size:11px;border-radius:20px;background:var(--glass);
  border:1px solid var(--border);cursor:pointer;font-weight:600;z-index:20}

/* Street info */
.street-info{
  position:absolute;bottom:28px;left:20px;padding:12px 16px;
  background:var(--glass);border-radius:14px;font-size:12px;border:1px solid var(--border)
}

/* Video */
#streetVideo{
  position:absolute;inset:0;width:100%;height:100%;object-fit:cover;
  transition:filter .4s ease;z-index:1
}

/* Joystick */
#joystickBase{
  position:absolute;bottom:28px;right:24px;width:100px;height:100px;
  border-radius:50%;border:2px solid var(--border);background:var(--glass);
  display:flex;align-items:center;justify-content:center;touch-action:none;z-index:25
}
#joystickKnob{width:48px;height:48px;background:var(--accent);border-radius:50%}

/* Settings */
.settings-anchor{position:absolute;right:24px;bottom:140px;z-index:30}
.settings-fab{width:52px;height:52px;border-radius:50%;background:#1e293b;
  border:2px solid var(--border);color:#fff;font-size:22px;cursor:pointer}
.settings-pop{
  position:absolute;right:0;bottom:70px;min-width:220px;
  background:#0f172a;border:1px solid var(--border);
  display:none;padding:16px;border-radius:18px
}
.settings-pop.open{display:block}
.settings-row{display:flex;justify-content:space-between;padding:8px 0}
.btn-chip{padding:6px 14px;border-radius:20px;border:1px solid var(--border);cursor:pointer}
.btn-chip.active{background:var(--accent);color:#fff}



/* FULL MAP OVERLAY */
#fullMapOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.85);
  display:none;align-items:center;justify-content:center;z-index:50
}
#fullMapContainer{
  width:90%;height:85%;background:#0b1120;border-radius:20px;overflow:hidden;
  border:1px solid var(--border)
}
#closeMapBtn{
  position:absolute;top:20px;right:20px;padding:10px 16px;
  border-radius:10px;border:none;background:#1e293b;color:#fff;
  font-size:18px;cursor:pointer;z-index:100
}
  /* Fix MapLibre Resize Issue */
#fullMapContainer * {
  box-sizing: border-box;
}

#fullMapContainer canvas {
  width: 100% !important;
  height: 100% !important;
  display: block;
}

</style>
</head>

<body>

<!-- FULL MAP -->
<div id="fullMapOverlay">
  <div id="fullMapContainer"></div>
  <button id="closeMapBtn">✕</button>
</div>

<div class="viewer-panel">
  <div class="viewer-canvas">

    <div class="top-street"><span id="hudStreetName">Select a Drive</span></div>

    

    <img id="miniMapStatic" class="mini-map" src="{{ url_for('static', filename='img/minimap_placeholder.png') }}">
    <button id="btnShowMap" class="mini-btn">Full Map</button>

    <div class="street-info"><span id="streetSmallLabel">Ready to drive</span></div>

    <video id="streetVideo" preload="metadata" muted playsinline>
      <source id="videoSource" src="">
    </video>

    <div id="joystickBase"><div id="joystickKnob"></div></div>

    <div class="settings-anchor">
      <button id="settingsToggle" class="settings-fab">⚙</button>
      <div id="settingsPop" class="settings-pop">
        <div class="settings-row">
          <span>Auto Drive</span>
          <button id="btnAutoDrive" class="btn-chip">Off</button>
        </div>

        <div class="settings-row">
          <span>Speed</span>
          <select id="speedSelect">
            <option value="0.75">0.75×</option>
            <option value="1" selected>1×</option>
            <option value="1.5">1.5×</option>
            <option value="2">2×</option>
          </select>
        </div>

        <div class="settings-row">
          <span>Night Mode</span>
          <button id="btnDayNight" class="btn-chip">Off</button>
        </div>

        <div class="settings-row">
          <span>Engine Volume</span>
          <input type="range" id="engineVolume" min="0" max="1" step="0.1" value="0.55">
        </div>

      </div>
    </div>

  </div>
</div>

<!-- DATA -->
<script id="streets-data" type="application/json">{{ streets | tojson | safe }}</script>
<script id="selected-street-data" type="application/json">{{ selected_street | tojson | safe if selected_street else 'null' }}</script>

<script>
/* =========================================================
   VARIABLES
========================================================= */
const fullMapOverlay = document.getElementById("fullMapOverlay");
const fullMapContainer = document.getElementById("fullMapContainer");
const closeMapBtn = document.getElementById("closeMapBtn");

const STREETS = JSON.parse(document.getElementById("streets-data").textContent || "[]");
const SELECTED = JSON.parse(document.getElementById("selected-street-data").textContent || "null");

const video = document.getElementById("streetVideo");
const vsrc  = document.getElementById("videoSource");

let walkSpeed = 1;
let currentDir = 0;
let keyDir=0, joyDir=0, autoDir=0;
let autoDrive=false;
let nightFilter=false;
let engineVol=0.55;
let currentVideos=[], currentVideoIndex=0;

/* =========================================================
   AUDIO ENGINE
========================================================= */
const engine = new Audio("/static/audio/engine.mp3");
engine.loop = true;
engine.volume = engineVol;
engine.play().catch(()=>{});

function updateEngineSound(){
  const sp = walkSpeed * Math.abs(currentDir);
  engine.playbackRate = 1 + sp * 0.4;
  engine.volume = currentDir ? engineVol : 0.3;
}


/* =========================================================
   LOAD STREET
========================================================= */
function loadStreet(st){
  hudStreetName.textContent = st.name;
  streetSmallLabel.textContent = st.city;

  currentVideos = st.videos.map(v=>v.url);
  currentVideoIndex = 0;

  vsrc.src = currentVideos[0];
  video.load();
  
}

function loadStreetByIndex(i){
  loadStreet(STREETS[i]);
}

/* =========================================================
   DRIVE ENGINE
========================================================= */
function safePlay(){ if(video.paused) video.play().catch(()=>{}); }
function safePause(){ if(!video.paused) video.pause(); }

function playForward(){
  video.playbackRate = walkSpeed;
  safePlay();
}
function playReverse(){ safePause(); }

function recomputeDirection(){
  const newDir = keyDir || joyDir || autoDir;
  currentDir = newDir;

  if(newDir === 1) playForward();
  else if(newDir === -1) playReverse();
  else safePause();

  updateEngineSound();
}

/* KEYBOARD */
window.onkeydown = e=>{
  if(e.key==="w"){ keyDir=1; recomputeDirection(); }
  if(e.key==="s"){ keyDir=-1; recomputeDirection(); }
};
window.onkeyup = e=>{
  if(["w","s"].includes(e.key)) keyDir=0;
  recomputeDirection();
};

/* JOYSTICK */
joystickBase.onpointerdown = e=>{
  joystickBase.setPointerCapture(e.pointerId);
  moveJoy(e);
};
joystickBase.onpointermove = e=>{ if(e.buttons) moveJoy(e); };
joystickBase.onpointerup = ()=>{ joyDir=0; joystickKnob.style.transform="translateY(0)"; recomputeDirection(); };

function moveJoy(e){
  const r=joystickBase.getBoundingClientRect();
  const dy=(e.clientY-(r.top+r.height/2))/(r.height/2);
  const c=Math.max(-1,Math.min(1,dy));
  joyDir = Math.abs(c)>0.2 ? (c<0?1:-1) : 0;
  joystickKnob.style.transform=`translateY(${c*35}px)`;
  recomputeDirection();
}

/* SETTINGS */
settingsToggle.onclick = ()=> settingsPop.classList.toggle("open");

btnAutoDrive.onclick = ()=>{
  autoDrive=!autoDrive;
  autoDir = autoDrive?1:0;
  btnAutoDrive.classList.toggle("active",autoDrive);
  btnAutoDrive.textContent = autoDrive?"On":"Off";
  recomputeDirection();
};

speedSelect.onchange = ()=>{
  walkSpeed = parseFloat(speedSelect.value);
  video.playbackRate = walkSpeed;
  updateEngineSound();
};

btnDayNight.onclick = ()=>{
  nightFilter=!nightFilter;
  btnDayNight.classList.toggle("active",nightFilter);
  video.style.filter = nightFilter ? "brightness(0.55) contrast(1.2)" : "none";
};

engineVolume.oninput = e=>{
  engineVol = parseFloat(e.target.value);
  updateEngineSound();
};

/* =========================================================
   MAPTILER HD MAP
========================================================= */
let fullMap = null;
const MAP_KEY = "PqdU3M5vnOQK0dDQnkIq";

function initFullMap(){
  if(fullMap) return;

  fullMap = new maplibregl.Map({
    container: "fullMapContainer",
    style: `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAP_KEY}`,
    center: [55.2708, 25.2048], // Dubai center
    zoom: 2.5,
    attributionControl: false
  });

  fullMap.addControl(new maplibregl.NavigationControl());

  STREETS.forEach((s,i)=>{
    if(s.lat && s.lng){
      new maplibregl.Marker({color:"#38bdf8"})
        .setLngLat([s.lng,s.lat])
        .addTo(fullMap)
        .getElement().onclick = ()=>{ loadStreetByIndex(i); hideFull(); };
    }
  });
}

function showFull(){
  fullMapOverlay.style.display="flex";
  initFullMap();
  setTimeout(()=> fullMap.resize(), 100);
}
function hideFull(){ fullMapOverlay.style.display="none"; }

btnShowMap.onclick = showFull;
miniMapStatic.onclick = showFull;
closeMapBtn.onclick = hideFull;

/* =========================================================
   INIT
========================================================= */
document.addEventListener("DOMContentLoaded",()=>{
  if(SELECTED){
    const idx = STREETS.findIndex(s=>s._id === SELECTED._id);
    loadStreetByIndex(idx >= 0 ? idx : 0);
  } else if(STREETS.length){
    loadStreetByIndex(0);
  }
});

</script>

</body>
</html>

