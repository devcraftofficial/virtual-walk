<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Drive Mode ‚Äì Virtual Street Drive | ABTO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#020617" />

  <!-- MAPLIBRE -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/maplibre-gl.css') }}">
  <script src="{{ url_for('static', filename='js/maplibre-gl.js') }}"></script>

  <!-- HLS (optional for .m3u8) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <!-- Postcard capture -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg-page:#020617;
      --bg-deep:#000;
      --text-main:#e5e7eb;
      --text-muted:#9ca3af;

      --accent:#38bdf8;
      --accent-2:#22c55e;
      --danger:#fb7185;

      --glass:rgba(15,23,42,.78);
      --glass-strong:rgba(15,23,42,.92);
      --border:rgba(148,163,184,.45);
      --shadow:0 18px 45px rgba(0,0,0,.82);

      --radius-lg:18px;
      --radius-md:14px;
      --radius-pill:999px;

      --vh: 1vh;
    }

    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; height:100%; }

    body{
      background: radial-gradient(circle at top, var(--bg-page), var(--bg-deep) 80%);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text-main);
      overflow:hidden;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    body.no-scroll{ overflow:hidden !important; }

    .viewer-panel{
      position:fixed;
      inset:0;
      width:100vw;
      height:100vh;
      height:100dvh;
      height: calc(var(--vh) * 100);
    }
    .viewer-canvas{
      position:relative;
      width:100%;
      height:100%;
      background:#000;
      overflow:hidden;
      touch-action:none;
    }

    /* ===== VIDEO ===== */
    #streetVideo{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      z-index:1;
      pointer-events:none;
      opacity:0;
      transition: transform .12s ease-out, opacity .22s ease-out, filter .22s ease-out;
    }

    #driveVignette{
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle at center, transparent 56%, rgba(0,0,0,.42) 86%),
        linear-gradient(to top, rgba(0,0,0,.55), transparent 42%);
      z-index:3;
      opacity:.0;
      transition: opacity .22s ease-out;
    }

    #nightOverlay{
      position:absolute;
      inset:0;
      background: radial-gradient(circle at top, rgba(15,23,42,.35), rgba(0,0,0,.9));
      mix-blend-mode:multiply;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease-out;
      z-index:2;
    }

    #rainOverlay{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:2;
      opacity:0;
      mix-blend-mode:screen;
      background-image:
        linear-gradient(120deg, rgba(148,163,184,.26) 1px, transparent 1px),
        linear-gradient(-120deg, rgba(148,163,184,.20) 1px, transparent 1px);
      background-size:2px 34px, 2px 28px;
      transition:opacity .35s ease-out;
    }

    /* ===== MINI MAP ===== */
    .mini-map{
      position:absolute;
      top:16px; left:16px;
      width:104px; height:104px;
      border-radius:999px;
      overflow:hidden;
      background:#020617;
      border:2px solid rgba(148,163,184,.6);
      box-shadow:0 12px 30px rgba(0,0,0,.75);
      cursor:pointer;
      z-index:90;
    }
    .mini-map img{ width:100%; height:100%; object-fit:cover; }

    /* ===== LEFT DOCK ===== */
    .left-dock{
      position:absolute;
      top:132px; left:16px;
      display:grid;
      gap:10px;
      z-index:140;
    }
    .icon-btn{
      width:42px; height:42px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--glass-strong);
      color:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      transition: transform .15s ease;
    }
    .icon-btn:hover{ transform: translateY(-1px); }
    .icon-btn:active{ transform: translateY(0) scale(.98); }

    /* ===== STREET INFO (top center) ===== */
    .street-hud{
      position:absolute;
      top:16px;
      left:300px;
      transform: translateX(-50%);
      background: rgba(15,23,42,.78);
      border:1px solid rgba(148,163,184,.40);
      padding:10px 16px;
      border-radius:999px;
      z-index:120;
      max-width:min(560px, 86vw);
      box-shadow:0 14px 30px rgba(0,0,0,.65);
      backdrop-filter: blur(12px);
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
    }
    .street-hud .mode{
      font-size:10px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color: rgba(226,232,240,.92);
      opacity:.9;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
      flex:0 0 auto;
    }
    .street-hud .name{
      font-size:13px;
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .street-hud .loc{
      font-size:11px;
      color: var(--text-muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.95;
    }
    .street-hud .tags{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:2px;
    }
    .street-tag-pill{
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.9);
      font-size:9px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(226,232,240,.9);
      white-space:nowrap;
    }

    @media (max-width: 768px){
      .street-hud{
        left:16px;
        transform:none;
        max-width: calc(100vw - 32px - 150px);
      }
      .street-hud .tags{
        display:none;
      }
    }

    /* ===== BRAND PILL ===== */
    .brand-pill{
      position:absolute;
      left:16px; bottom:22px;
      padding:7px 14px;
      border-radius:999px;
      background: rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.55);
      box-shadow:0 14px 30px rgba(0,0,0,.85);
      font-size:11px;
      color:#e5e7eb;
      display:flex;
      align-items:center;
      gap:8px;
      z-index:150;
      backdrop-filter: blur(10px);
    }
    .brand-pill .abto-tag{
      padding:2px 8px;
      border-radius:999px;
      background: rgba(56,189,248,.18);
      border:1px solid rgba(56,189,248,.7);
      font-weight:650;
      letter-spacing:.03em;
      text-transform:uppercase;
      font-size:10px;
      color:#7dd3fc;
    }

    /* JOURNEY PILL */
    #journeyPill{
      position:absolute;
      left:16px;
      bottom:56px;
      padding:7px 14px;
      border-radius:999px;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(56,189,248,.55);
      box-shadow:0 14px 30px rgba(0,0,0,.9);
      font-size:11px;
      color:#e5e7eb;
      display:none;
      align-items:flex-start;
      gap:8px;
      z-index:151;
      backdrop-filter:blur(12px);
      max-width:min(420px, 60vw);
    }
    .journey-label{
      text-transform:uppercase;
      letter-spacing:.12em;
      font-size:10px;
      color:rgba(148,163,184,.98);
      white-space:nowrap;
    }
    .journey-main{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    #journeyRoute{
      font-size:12px;
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #journeyMeta{
      font-size:11px;
      color:rgba(148,163,184,.98);
    }
    @media (max-width:768px){
      #journeyPill{
        left:16px;
        bottom:60px;
        max-width:calc(100vw - 32px);
      }
    }

    /* ===== TOP-RIGHT DOCK ===== */
    .top-right-dock{
      position:absolute;
      top:16px; right:16px;
      display:flex;
      align-items:center;
      gap:10px;
      z-index:160;
    }

    .dock-btn{
      height:40px;
      border-radius: var(--radius-pill);
      border:1px solid var(--border);
      background: var(--glass-strong);
      color:#e5e7eb;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:0 12px;
      transition: transform .15s ease, opacity .15s ease, border-color .15s ease;
      white-space:nowrap;
    }
    .dock-btn:hover{ transform: translateY(-1px); }
    .dock-btn:active{ transform: translateY(0) scale(.98); }

    .dock-icon{ width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center; }
    .dock-icon svg{ width:18px; height:18px; display:block; }
    .dock-label{ font-size:11px; color: rgba(226,232,240,.92); }

    .autodrive-btn{
      border:1px solid rgba(56,189,248,.55);
      background: linear-gradient(135deg, rgba(56,189,248,.18), rgba(15,23,42,.92));
      position:relative;
      overflow:hidden;
    }
    .autodrive-btn::after{
      content:"";
      position:absolute;
      inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(56,189,248,.22), transparent 55%);
      opacity:.7;
      pointer-events:none;
      transform: rotate(12deg);
    }
    .autodrive-btn .dot{
      width:8px; height:8px;
      border-radius:50%;
      background: rgba(148,163,184,.8);
      transition: background .15s ease, box-shadow .15s ease, transform .15s ease;
      z-index:1;
    }
    .autodrive-btn.on{
      border-color: rgba(34,197,94,.7);
      background: linear-gradient(135deg, rgba(34,197,94,.20), rgba(15,23,42,.92));
    }
    .autodrive-btn.on .dot{
      background: rgba(34,197,94,.98);
      box-shadow: 0 0 18px rgba(34,197,94,.55);
      transform: scale(1.05);
      animation: dotPulse 1.2s infinite ease-in-out;
    }
    @keyframes dotPulse{
      0%,100{ transform: scale(1.0); opacity:1; }
      50%{ transform: scale(1.35); opacity:.75; }
    }

    /* ===== COCKPIT / DASH ===== */
    #dashOverlay{
      position:absolute;
      left:50%;
      bottom:-60px;
      transform: translateX(-50%) rotate(0deg);
      width:min(980px, 86vw);
      max-height:60vh;
      object-fit:contain;
      pointer-events:none;
      z-index:12;
      filter: drop-shadow(0 22px 55px rgba(0,0,0,.8));
      transition: transform .14s ease-out, opacity .2s ease-out;
      opacity:1;
    }
    @media (max-width:908px){
      #dashOverlay{
        bottom:-30px;
        width: 100vw;
      }
    }

    /* SPEED */
    #speedBtn{
      position:absolute;
      right:18px;
      bottom:140px;
      height:40px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      background: rgba(15,23,42,.82);
      color:#e5e7eb;
      box-shadow:0 18px 45px rgba(0,0,0,.75);
      backdrop-filter: blur(12px);
      display:flex;
      align-items:center;
      gap:8px;
      z-index:185;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, opacity .15s ease;
      white-space:nowrap;
    }
    #speedBtn:hover{ transform: translateY(-1px); border-color: rgba(56,189,248,.45); }
    #speedBtn:active{ transform: translateY(0) scale(.98); }

    .speed-ico{
      width:18px; height:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      background: rgba(56,189,248,.14);
      border:1px solid rgba(56,189,248,.55);
      font-size:11px;
      color:#7dd3fc;
      font-weight:800;
    }
    #speedBtnLabel{
      font-size:11px;
      font-weight:850;
      letter-spacing:.06em;
      opacity:.95;
      text-transform:uppercase;
    }

    #speedPop{
      position:absolute;
      right:18px;
      bottom:190px;
      width:150px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.35);
      background: rgba(15,23,42,.92);
      box-shadow:0 20px 60px rgba(0,0,0,.85);
      backdrop-filter: blur(12px);
      padding:10px;
      display:none;
      z-index:186;
    }
    .speed-opt{
      width:100%;
      padding:9px 10px;
      margin:6px 0;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(0,0,0,.18);
      color:#e5e7eb;
      font-size:11px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      text-align:left;
    }
    .speed-opt:hover{
      transform: translateY(-1px);
      border-color: rgba(56,189,248,.38);
      background: rgba(15,23,42,.62);
    }
    .speed-opt.active{
      border-color: rgba(56,189,248,.75);
      background: rgba(56,189,248,.14);
      color:#e0f2fe;
    }

    #speedBackdrop{
      position:absolute;
      inset:0;
      display:none;
      z-index:184;
      background: transparent;
    }

    /* JOYSTICK */
    #joystickBase{
      position:absolute;
      bottom:20px; right:20px;
      width:96px; height:96px;
      border-radius:50%;
      background: radial-gradient(circle at center, rgba(15,23,42,.35) 0%, rgba(15,23,42,.25) 45%, transparent 70%);
      border:1px solid rgba(148,163,184,.55);
      box-shadow:0 8px 24px rgba(0,0,0,.5);
      display:flex;
      justify-content:center;
      align-items:center;
      backdrop-filter: blur(6px);
      touch-action:none;
      z-index:180;
      opacity:.55;
      transition: opacity .18s ease-out, transform .18s ease-out;
    }
    #joystickBase.joy-active{ opacity:.9; transform: scale(1.02); }
    #joystickKnob{
      width:40px; height:40px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(56,189,248,.85), rgba(15,23,42,.9));
      box-shadow: 0 0 0 3px rgba(56,189,248,.25), 0 8px 18px rgba(0,0,0,.65);
      touch-action:none;
    }
    @media (max-width:768px){
      #joystickBase{ right:16px; bottom: 14px; }
      body.is-fs #joystickBase{ bottom: max(14px, env(safe-area-inset-bottom)); }

      #speedBtn{ right:16px; bottom: 124px; }
      #speedPop{ right:16px; bottom: 176px; }
    }

    /* LOADING */
    #videoLoading{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.9);
      z-index:6;
      pointer-events:none;
    }
    #videoLoadingSpinner{
      width:36px; height:36px;
      border-radius:50%;
      border:3px solid rgba(148,163,184,.4);
      border-top-color: var(--accent);
      animation: spin .7s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* START HINT */
    #startHint{
      position:absolute;
      inset:auto 0 84px 0;
      display:flex;
      justify-content:center;
      z-index:190;
      transition: opacity .25s ease-out;
    }

    /* SETTINGS PANEL */
    #settingsPanel{
      position:absolute;
      right:16px;
      top:64px;
      width:290px;
      max-width:86vw;
      background: rgba(15,23,42,.96);
      border-radius:16px;
      border:1px solid rgba(148,163,184,.6);
      box-shadow:0 18px 45px rgba(0,0,0,.9);
      padding:10px 12px 12px;
      z-index:260;
      transform: translateY(10px);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease-out, transform .18s ease-out;
      font-size:12px;
      backdrop-filter: blur(12px);
    }
    #settingsPanel.open{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
    }
    .settings-section{
      margin-top:8px;
      padding-top:6px;
      border-top:1px solid rgba(30,64,175,.5);
    }
    .settings-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:8px;
      gap:10px;
      font-size:11px;
      color: rgba(226,232,240,.92);
    }
    .settings-row small{ color: rgba(148,163,184,.9); }
    .settings-row select, .settings-row input[type="range"]{
      background:#020617;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.35);
      color:#e5e7eb;
      padding:6px 8px;
      font-size:12px;
      outline:none;
    }
    .settings-row input[type="range"]{ padding:0; }

    /* STREET STORY */
    #streetStory{
      position:absolute;
      left:16px;
      bottom:96px;
      z-index:170;
      display:none;
      opacity:0;
      transition:opacity .22s ease-out;
      pointer-events:none;
    }
    .street-story-pill{
      display:inline-flex;
      align-items:flex-start;
      gap:8px;
      max-width:min(360px, 70vw);
      padding:8px 12px;
      border-radius:14px;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(56,189,248,.55);
      box-shadow:0 18px 45px rgba(0,0,0,.9);
      font-size:11px;
      color:#e5e7eb;
      backdrop-filter:blur(12px);
    }
    .street-story-dot{
      width:8px; height:8px;
      border-radius:999px;
      background:rgba(56,189,248,.96);
      box-shadow:0 0 12px rgba(56,189,248,.7);
      margin-top:4px;
      flex:0 0 auto;
    }
    #streetStoryText{ line-height:1.35; }

    /* STREET MEMORY */
    #streetMemory{
      position:absolute;
      left:16px;
      bottom:140px;
      z-index:171;
      display:none;
      opacity:0;
      transition:opacity .22s ease-out;
      pointer-events:none;
    }
    .street-memory-pill{
      display:inline-flex;
      align-items:flex-start;
      gap:8px;
      max-width:min(360px, 70vw);
      padding:6px 11px;
      border-radius:14px;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(94,234,212,.7);
      box-shadow:0 18px 45px rgba(0,0,0,.9);
      font-size:11px;
      color:#e5e7eb;
      backdrop-filter:blur(12px);
    }
    .street-memory-dot{
      width:8px; height:8px;
      border-radius:999px;
      background:rgba(94,234,212,.96);
      box-shadow:0 0 12px rgba(94,234,212,.7);
      margin-top:4px;
      flex:0 0 auto;
    }
    @media (max-width:768px){
      #streetMemory{
        max-width:calc(100vw - 32px);
        bottom:150px;
      }
    }

    /* LIVE EVENTS */
    #liveEvent{
      position:absolute;
      left:16px;
      top:72px;
      z-index:175;
      display:none;
      opacity:0;
      transition:opacity .20s ease-out;
      pointer-events:none;
    }
    .live-event-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(250,204,21,.7);
      box-shadow:0 18px 45px rgba(0,0,0,.9);
      font-size:11px;
      color:#fef9c3;
      backdrop-filter:blur(12px);
    }
    .live-event-dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:#facc15;
      box-shadow:0 0 10px rgba(250,204,21,.9);
    }
    @media (max-width:768px){
      #liveEvent{
        top:60px;
        max-width:calc(100vw - 32px);
      }
    }

    /* NEXT DRIVE PREVIEW */
    #nextPreview{
      position:absolute;
      right:18px;
      bottom:18px;
      z-index:200;
      display:none;
    }
    #nextPreviewCard{
      min-width:220px;
      max-width:320px;
      background:rgba(15,23,42,.96);
      border-radius:16px;
      border:1px solid rgba(56,189,248,.55);
      box-shadow:0 24px 60px rgba(0,0,0,.9);
      padding:10px 12px 12px;
      font-size:12px;
      color:#e5e7eb;
      backdrop-filter:blur(12px);
    }
    #nextPreviewTitle{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:rgba(148,163,184,.98);
      margin-bottom:4px;
    }
    #nextPreviewStreet{
      font-size:13px;
      font-weight:800;
      margin-bottom:2px;
    }
    #nextPreviewLoc{
      font-size:11px;
      color:rgba(148,163,184,.95);
      margin-bottom:6px;
    }
    #nextPreviewCountdown{
      font-weight:700;
    }
    #nextPreviewCountdownText{
      font-size:11px;
      color:#e5e7eb;
      margin-bottom:6px;
    }
    #nextPreviewActions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }
    .next-prev-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,1);
      padding:6px 10px;
      font-size:11px;
      cursor:pointer;
      color:#e5e7eb;
    }
    .next-prev-btn.primary{
      background:linear-gradient(135deg,rgba(56,189,248,.9),rgba(34,197,94,.75));
      border-color:transparent;
      color:#001018;
    }

    /* STREETS DRAWER */
    #streetsDrawerOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      z-index:400;
      pointer-events:auto;
      touch-action:auto !important;
    }
    body.is-fs #streetsDrawerOverlay{
      position:absolute;
      inset:0;
    }
    #streetsDrawer{
      position:absolute;
      top:0; left:0;
      height:100%;
      width:min(380px, 92vw);
      background: rgba(2,6,23,.92);
      border-right:1px solid rgba(148,163,184,.25);
      box-shadow:40px 0 90px rgba(0,0,0,.75);
      padding:14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
      touch-action:auto !important;
    }
    .drawer-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding-bottom:6px;
      border-bottom:1px solid rgba(148,163,184,.18);
      flex:0 0 auto;
    }
    .drawer-title{ font-size:13px; font-weight:650; letter-spacing:.02em; }
    .drawer-close{
      width:36px; height:36px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.35);
      background: rgba(15,23,42,.65);
      color:#e5e7eb;
      cursor:pointer;
    }
    .drawer-search{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.28);
      background: rgba(15,23,42,.6);
      color:#e5e7eb;
      padding:10px 12px;
      outline:none;
      font-size:12px;
      flex:0 0 auto;
    }
    .drawer-list{
      flex:1 1 auto;
      min-height:0;
      overflow-y:auto !important;
      overflow-x:hidden;
      padding-right:6px;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y !important;
      scrollbar-gutter: stable;
    }
    .street-item{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(15,23,42,.45);
      cursor:pointer;
      margin-bottom:10px;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .street-item:hover{
      transform: translateY(-1px);
      border-color: rgba(56,189,248,.38);
      background: rgba(15,23,42,.62);
    }
    .street-item .name{ font-size:12px; font-weight:650; }
    .street-item .meta{ font-size:11px; color: rgba(148,163,184,.92); }
    .street-item.active{
      border-color: rgba(56,189,248,.65);
      background: rgba(56,189,248,.10);
    }

    /* FULL MAP */
    #fullMapOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.75);
      backdrop-filter: blur(6px);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:380;
      padding:20px;
      pointer-events:auto;
      touch-action:auto;
    }
    body.is-fs #fullMapOverlay{
      position:absolute;
      inset:0;
    }
    #fullMapContainer{
      width:90%;
      height:80%;
      background:#0b1120;
      border-radius: var(--radius-lg);
      border:1px solid rgba(148,163,184,.5);
      overflow:hidden;
      box-shadow:0 25px 70px rgba(0,0,0,.9);
      touch-action:auto;
    }
    #closeMapBtn{
      position:absolute;
      top:30px; right:40px;
      width:48px; height:48px;
      background: rgba(0,0,0,.65);
      color:#fff;
      border-radius:50%;
      border:none;
      cursor:pointer;
      font-size:22px;
      z-index:500;
      backdrop-filter: blur(4px);
      box-shadow:0 10px 30px rgba(0,0,0,.8);
    }

    /* POPUP */
    #streetPopup{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:520;
      touch-action:auto;
    }
    body.is-fs #streetPopup{
      position:absolute;
      inset:0;
      touch-action:auto;
    }
    #streetPopupCard{
      width:90%;
      max-width:420px;
      background: rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.4);
      padding:26px;
      border-radius:18px;
      animation: popupFade .25s ease;
    }
    #streetPopupCard h2{
      margin:0 0 10px 0;
      font-size:22px;
      color: var(--accent);
    }
    #streetPopupCard p{
      margin:6px 0;
      font-size:14px;
      color: var(--text-main);
    }
    #popupClose{
      margin-top:16px;
      padding:10px 22px;
      background: var(--accent);
      border:none;
      border-radius:10px;
      color:#000;
      font-weight:800;
      cursor:pointer;
      width:100%;
    }
    @keyframes popupFade{
      from{ opacity:0; transform: translateY(16px); }
      to{ opacity:1; transform: translateY(0); }
    }

    #fadeLayer{
      position:absolute;
      inset:0;
      background:#000;
      opacity:0;
      transition: opacity .5s;
      pointer-events:none;
      z-index:360;
    }

    .map-marker-selected{
      width:26px !important;
      height:26px !important;
      background: var(--accent) !important;
      border-radius:50%;
      border:3px solid #fff !important;
      box-shadow: 0 0 18px var(--accent), 0 0 32px var(--accent);
      animation: markerPulse 1.4s infinite ease-in-out;
    }
    @keyframes markerPulse{
      0%{ transform: scale(1); opacity:1; }
      50%{ transform: scale(1.3); opacity:.7; }
      100%{ transform: scale(1); opacity:1; }
    }

    /* DEVICE TOAST */
    #deviceToast{
      position:fixed;
      left:50%;
      bottom:24px;
      transform: translateX(-50%);
      background: rgba(15,23,42,.92);
      border:1px solid rgba(148,163,184,.45);
      border-radius:14px;
      box-shadow:0 25px 70px rgba(0,0,0,.85);
      padding:10px 12px;
      z-index:800;
      display:none;
      align-items:center;
      gap:10px;
      backdrop-filter: blur(12px);
      max-width: min(560px, 92vw);
    }
    #deviceToast .t-title{ font-size:12px; font-weight:800; }
    #deviceToast .t-sub{ font-size:11px; color: rgba(148,163,184,.95); }
    #deviceToast button{
      margin-left:8px;
      width:34px;
      height:34px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.3);
      background: rgba(0,0,0,.25);
      color:#e5e7eb;
      cursor:pointer;
    }

    #shareToast{
      position:fixed;
      left:50%;
      bottom:70px;
      transform:translateX(-50%);
      background:rgba(15,23,42,.96);
      border-radius:999px;
      border:1px solid rgba(56,189,248,.75);
      padding:6px 12px;
      font-size:11px;
      color:#e0f2fe;
      box-shadow:0 18px 45px rgba(0,0,0,.9);
      display:none;
      opacity:0;
      z-index:810;
      backdrop-filter:blur(12px);
      transition:opacity .2s ease-out;
    }

    /* Soft objective ‚Äì bottom-right */
    #softObjective{
      position:fixed;
      right:16px;
      bottom:120px;
      transform:none;
      z-index:190;
      display:none;
      opacity:0;
      transition:opacity .2s ease-out;
      pointer-events:none;
    }
    #softObjectiveInner{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 12px;
      border-radius:999px;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(56,189,248,.65);
      box-shadow:0 18px 45px rgba(0,0,0,.85);
      font-size:11px;
      color:#e5e7eb;
      backdrop-filter:blur(12px);
    }
    #softObjectiveInner span:first-child{
      font-size:12px;
    }
    @media (max-width:768px){
      #softObjective{
        right:16px;
        bottom:130px;
        max-width:min(260px, calc(100vw - 32px));
      }
    }

    /* Session summary */
    #sessionSummary{
      position:fixed;
      left:50%;
      bottom:24px;
      transform:translateX(-50%) translateY(10px);
      z-index:195;
      display:none;
      opacity:0;
      transition:opacity .22s ease-out, transform .22s ease-out;
      pointer-events:none;
    }
    #sessionSummary.open{
      opacity:1;
      transform:translateX(-50%) translateY(0);
      pointer-events:auto;
    }
    .session-card{
      min-width:230px;
      max-width:320px;
      padding:10px 14px 12px;
      border-radius:16px;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(148,163,184,.6);
      box-shadow:0 26px 70px rgba(0,0,0,.9);
      font-size:12px;
      color:#e5e7eb;
      backdrop-filter:blur(12px);
    }
    .session-card-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:rgba(148,163,184,.98);
      margin-bottom:4px;
    }
    .session-card-main{
      font-size:13px;
      font-weight:700;
      margin-bottom:4px;
    }
    .session-card-sub{
      font-size:11px;
      color:rgba(148,163,184,.95);
      margin-bottom:8px;
    }
    #sessionResumeLater{
      width:100%;
      border:none;
      border-radius:999px;
      padding:7px 10px;
      font-size:11px;
      font-weight:800;
      cursor:pointer;
      background:linear-gradient(135deg,rgba(56,189,248,.9),rgba(34,197,94,.75));
      color:#001018;
    }
    @media (max-width:768px){
      #sessionSummary{
        bottom:76px;
        max-width:calc(100vw - 32px);
      }
    }

    @media (max-width:520px){
      .dock-label{ display:none; }
      .dock-btn{ padding: 0 10px; }
      #settingsPanel{ top:58px; }
    }

    /* ROTATE OVERLAY */
    #rotateOverlay{
      position:fixed;
      inset:0;
      z-index:1200;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      background: radial-gradient(circle at top, rgba(2,6,23,.92), rgba(0,0,0,.96));
      backdrop-filter: blur(10px);
      touch-action:auto;
    }
    #rotateCard{
      width:min(520px, 92vw);
      border-radius:22px;
      border:1px solid rgba(148,163,184,.35);
      background: rgba(15,23,42,.78);
      box-shadow: 0 28px 90px rgba(0,0,0,.85);
      padding:18px 18px 16px;
      display:flex;
      gap:14px;
      align-items:flex-start;
    }
    .rot-icon{
      width:46px; height:46px;
      border-radius:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(56,189,248,.14);
      border:1px solid rgba(56,189,248,.55);
      flex:0 0 auto;
    }
    .rot-icon svg{ width:26px; height:26px; opacity:.95; }
    .rot-title{
      font-size:14px;
      font-weight:900;
      margin:0;
      letter-spacing:.02em;
    }
    .rot-sub{
      margin:6px 0 0 0;
      font-size:12px;
      color: rgba(148,163,184,.98);
      line-height:1.35;
    }
    .rot-pill{
      margin-top:10px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background: rgba(0,0,0,.18);
      font-size:11px;
      color: rgba(226,232,240,.92);
    }
    .rot-pill b{
      color:#e5e7eb;
      letter-spacing:.03em;
    }
    .rot-actions{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .rot-btn{
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding:10px 12px;
      font-size:12px;
      font-weight:800;
      letter-spacing:.01em;
      transition: transform .12s ease, opacity .12s ease;
    }
    .rot-btn:active{ transform: scale(.98); }
    .rot-btn.primary{
      background: linear-gradient(135deg, rgba(56,189,248,.9), rgba(34,197,94,.65));
      color:#001018;
    }
    .rot-btn.ghost{
      background: rgba(255,255,255,.06);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.25);
    }

    @media (max-width: 980px){
      body.is-portrait #rotateOverlay{ display:flex; }
      body.is-portrait .viewer-panel{ filter: blur(10px) saturate(.8); }
    }

    /* COMPACT HUD FOR MOBILE */
    @media (max-width: 900px) {
      .street-hud{
        top: 8px;
        max-width: calc(100vw - 130px);
        padding: 8px 14px;
      }

      .brand-pill{
        padding: 6px 10px;
        gap: 6px;
        font-size: 10px;
      }
      .brand-pill span:nth-child(2){
        display: none;
      }

      #journeyPill{
        font-size: 10px;
        padding: 6px 10px;
        max-width: 82vw;
      }
    }

    @media (max-width: 900px) and (max-height: 500px) {
      .brand-pill,
      #journeyPill,
      #softObjective{
        display: none !important;
      }
      #streetStory{
        display: none !important;
      }
      .top-right-dock{
        top: 8px;
      }
    }

    /* HUD AUTO-HIDE */
    body.hud-hidden .top-right-dock,
    body.hud-hidden .street-hud,
    body.hud-hidden .brand-pill,
    body.hud-hidden #journeyPill,
    body.hud-hidden #liveEvent,
    body.hud-hidden #streetStory,
    body.hud-hidden #streetMemory,
    body.hud-hidden #softObjective,
    body.hud-hidden #speedBtn,
    body.hud-hidden #speedPop,
    body.hud-hidden #sessionSummary,
    body.hud-hidden #deviceToast {
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease-out;
    }

    #hudHint{
      position:absolute;
      left:50%;
      bottom:24px;
      transform:translateX(-50%);
      font-size:10px;
      color:rgba(148,163,184,.9);
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.8);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 45px rgba(0,0,0,.85);
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease-out;
      z-index:300;
    }
    body.hud-hidden #hudHint{
      opacity:1;
    }
    @media (max-width:768px){
      #hudHint{
        bottom:max(18px, env(safe-area-inset-bottom));
      }
    }
  </style>
</head>

<body>
  <!-- Rotate overlay -->
  <div id="rotateOverlay" role="dialog" aria-modal="true" aria-label="Rotate device to landscape">
    <div id="rotateCard">
      <div class="rot-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round">
          <path d="M7 2h10a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/>
          <path d="M15 22v-2"/>
          <path d="M9 22v-2"/>
          <path d="M8 6h8"/>
          <path d="M12 12l3-3"/>
          <path d="M12 12l-3 3"/>
        </svg>
      </div>
      <div style="min-width:0;">
        <p class="rot-title">Please rotate your phone</p>
        <p class="rot-sub">
          Drive Mode works best in <b>landscape</b>. Rotate your device for a better experience.
          For the best performance and controls, try on a <b>laptop or desktop</b>.
        </p>

        <div class="rot-pill" title="Tip">
          üéÆ Tip: Use <b>W/‚Üë</b> to drive, <b>S/‚Üì</b> to reverse, <b>‚Üê/‚Üí</b> to lean
        </div>

        <div class="rot-actions">
          <button id="rotateTryAgain" class="rot-btn primary" type="button">I rotated</button>
          <button id="rotateHideHint" class="rot-btn ghost" type="button">Hide message</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Full map overlay -->
  <div id="fullMapOverlay">
    <div id="fullMapContainer"></div>
    <button id="closeMapBtn" aria-label="Close map">‚úï</button>
  </div>

  <!-- Streets drawer -->
  <div id="streetsDrawerOverlay" aria-hidden="true">
    <div id="streetsDrawer" role="dialog" aria-label="All drives list">
      <div class="drawer-head">
        <div class="drawer-title">All Drives</div>
        <button id="streetsDrawerClose" class="drawer-close" aria-label="Close">‚úï</button>
      </div>

      <input id="streetsSearch"
             class="drawer-search"
             placeholder="Search street / city / country..."
             autocomplete="off"
             autocapitalize="off"
             autocorrect="off"
             spellcheck="false"
             inputmode="search" />

      <div id="streetsList" class="drawer-list"></div>
    </div>
  </div>

  <div class="viewer-panel" id="viewerPanel">
    <div class="viewer-canvas" id="viewerCanvas">

      <!-- Mini map -->
      <div id="miniMap" class="mini-map" title="Open map">
        <img src="{{ url_for('static', filename='img/minimap_placeholder.png') }}" alt="">
      </div>

      <!-- Top center HUD -->
      <div id="streetHud" class="street-hud" title="Street details">
        <span class="mode">ABTO ‚Ä¢ DRIVE</span>
        <div style="min-width:0;display:flex;flex-direction:column;gap:2px;">
          <div id="streetName" class="name">Select a Drive</div>
          <div id="streetLocation" class="loc">Waiting‚Ä¶</div>
          <div id="streetTags" class="tags"></div>
        </div>
      </div>

      <!-- Live drive event bubble -->
      <div id="liveEvent">
        <div class="live-event-pill">
          <span class="live-event-dot"></span>
          <span id="liveEventText"></span>
        </div>
      </div>

      <!-- Left dock -->
      <div class="left-dock">
        <button id="settingsBtn" class="icon-btn" aria-label="Settings" title="Settings" type="button">‚öô</button>
        <button id="streetsBtn" class="icon-btn" aria-label="All drives" title="All drives" type="button">‚ò∞</button>
      </div>

      <!-- Top-right dock -->
      <div class="top-right-dock">
        <button id="fullscreenBtn" class="dock-btn" aria-label="Enter full screen" title="Full screen" type="button">
          <span class="dock-icon" id="fsIcon"></span>
          <span class="dock-label" id="fsLabel">Fullscreen</span>
        </button>

        <button id="autoDriveBtn" class="dock-btn autodrive-btn" aria-label="Toggle auto drive" title="Auto drive" type="button">
          <span class="dot"></span>
          <span class="dock-label" id="autoDriveLabel">Auto Drive</span>
        </button>

        <button id="shareClipBtn" class="dock-btn" aria-label="Share this moment" title="Share this moment" type="button">
          <span class="dock-icon">üîó</span>
          <span class="dock-label">Share</span>
        </button>

        <button id="postcardBtn" class="dock-btn" aria-label="Create postcard" title="Create postcard" type="button">
          <span class="dock-icon">üì∏</span>
          <span class="dock-label">Postcard</span>
        </button>
      </div>

      <!-- Brand -->
      <div class="brand-pill">
        <span class="abto-tag">ABTO</span>
        <span>A Better Travel Observer</span>
      </div>

      <!-- Journey pill -->
      <div id="journeyPill">
        <div class="journey-label">Journey</div>
        <div class="journey-main">
          <div id="journeyRoute">Not started</div>
          <div id="journeyMeta">0.0 km ¬∑ 0m 00s</div>
        </div>
      </div>

      <!-- Video -->
      <video id="streetVideo" preload="metadata" muted playsinline disablepictureinpicture>
        <source id="videoSource" src="">
      </video>

      <div id="driveVignette"></div>
      <div id="nightOverlay"></div>
      <div id="rainOverlay"></div>

      <!-- Dashboard overlay -->
      <img id="dashOverlay"
           src="{{ url_for('static', filename='img/dash.png') }}"
           alt="Drive cockpit overlay" />

      <!-- Loading -->
      <div id="videoLoading">
        <div id="videoLoadingSpinner"></div>
      </div>

      <!-- Street Story bubble -->
      <div id="streetStory">
        <div class="street-story-pill">
          <span class="street-story-dot"></span>
          <span id="streetStoryText"></span>
        </div>
      </div>

      <!-- Street Memory bubble -->
      <div id="streetMemory">
        <div class="street-memory-pill">
          <span class="street-memory-dot"></span>
          <span id="streetMemoryText"></span>
        </div>
      </div>

      <!-- Joystick -->
      <div id="joystickBase" aria-label="Drive joystick">
        <div id="joystickKnob"></div>
      </div>

      <!-- SPEED -->
      <div id="speedBackdrop" aria-hidden="true"></div>

      <button id="speedBtn" type="button" aria-label="Gear" title="Gear">
        <span class="speed-ico">G</span>
        <span id="speedBtnLabel">G2</span>
      </button>

      <div id="speedPop" aria-hidden="true">
        <button class="speed-opt" data-gear="1" data-speed="0.7" type="button">Gear 1 ¬∑ City</button>
        <button class="speed-opt active" data-gear="2" data-speed="1" type="button">Gear 2 ¬∑ Cruise</button>
        <button class="speed-opt" data-gear="3" data-speed="1.35" type="button">Gear 3 ¬∑ Fast</button>
        <button class="speed-opt" data-gear="4" data-speed="1.7" type="button">Gear 4 ¬∑ Turbo</button>
      </div>

      <!-- Settings panel -->
      <div id="settingsPanel" aria-label="Drive settings">
        <h3 style="margin:0 0 6px 0;font-size:13px;">Drive settings</h3>

        <div class="settings-section">
          <strong style="font-size:11px;">Video</strong>

          <div class="settings-row">
            <label for="setVideoMuted">Mute video</label>
            <input type="checkbox" id="setVideoMuted" checked>
          </div>

          <div class="settings-row">
            <label for="setNightMode">Night view</label>
            <input type="checkbox" id="setNightMode">
          </div>

          <div class="settings-row">
            <div style="display:flex;flex-direction:column;gap:2px;">
              <label for="setVideoSharp">Cinematic boost</label>
              <small>extra contrast + crisp</small>
            </div>
            <input type="checkbox" id="setVideoSharp" checked>
          </div>

          <div class="settings-row">
            <div style="display:flex;flex-direction:column;gap:2px;">
              <label for="cinematicMode">Cinematic mode</label>
              <small>Neo Night ¬∑ Sunset ¬∑ Rain ¬∑ Vintage</small>
            </div>
            <select id="cinematicMode">
              <option value="off">Off</option>
              <option value="neo">Neo Night</option>
              <option value="warm">Warm Sunset</option>
              <option value="rain">Rain Glass</option>
              <option value="vintage">Vintage</option>
            </select>
          </div>
        </div>

        <div class="settings-section">
          <strong style="font-size:11px;">Cockpit</strong>

          <div class="settings-row">
            <label for="setHideDash">Hide cockpit overlay</label>
            <input type="checkbox" id="setHideDash">
          </div>

          <div class="settings-row">
            <div style="display:flex;flex-direction:column;gap:2px;">
              <label for="setDashOpacity">Cockpit opacity</label>
              <small>0.30 ‚Äì 1.00</small>
            </div>
            <input type="range" id="setDashOpacity" min="0.3" max="1" step="0.05" value="1">
          </div>

          <div class="settings-row">
            <div style="display:flex;flex-direction:column;gap:2px;">
              <label for="setEngineVol">Engine volume</label>
              <small>auto reacts to speed</small>
            </div>
            <input type="range" id="setEngineVol" min="0" max="1" step="0.05" value="0.55">
          </div>
        </div>

        <div class="settings-section">
          <strong style="font-size:11px;">Driving</strong>
          <div class="settings-row">
            <div style="display:flex;flex-direction:column;gap:2px;">
              <span>Keyboard</span>
              <small>W/‚Üë forward ¬∑ S/‚Üì reverse ¬∑ ‚Üê/‚Üí lean</small>
            </div>
            <span style="opacity:.8;font-size:11px;">OK</span>
          </div>

          <div class="settings-row">
            <div style="display:flex;flex-direction:column;gap:2px;">
              <label for="driveMood">Drive mood</label>
              <small>Chill ¬∑ Explore ¬∑ Fast</small>
            </div>
            <select id="driveMood">
              <option value="explore">Explore</option>
              <option value="chill">Chill</option>
              <option value="fast">Fast</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Popup -->
      <div id="streetPopup">
        <div id="streetPopupCard">
          <h2 id="popupTitle"></h2>
          <p id="popupCity"></p>
          <p id="popupCategory"></p>
          <p id="popupDescription"></p>
          <button id="popupClose" type="button">Close</button>
        </div>
      </div>

      <!-- Start hint -->
      <div id="startHint">
        <div style="display:flex;align-items:center;gap:10px;
                    background:rgba(15,23,42,0.92);
                    border-radius:999px;
                    padding:8px 14px;
                    border:1px solid rgba(148,163,184,0.55);
                    box-shadow:0 18px 45px rgba(0,0,0,0.85);
                    font-size:11px;
                    color:#e5e7eb;
                    backdrop-filter:blur(12px);">
          <span style="display:inline-flex;align-items:center;justify-content:center;
                       width:20px;height:20px;border-radius:999px;
                       background:rgba(56,189,248,0.16);
                       border:1px solid rgba(56,189,248,0.7);
                       font-size:11px;color:#7dd3fc;">
            ‚Üë
          </span>
          <span style="opacity:0.92;">
            Press <strong>W / ‚Üë</strong> or drag the joystick to start driving
          </span>
          <button id="startHintSkip"
                  type="button"
                  style="margin-left:4px;border:none;background:transparent;
                         color:#9ca3af;font-size:11px;cursor:pointer;padding:0 2px;">
            Skip
          </button>
        </div>
      </div>

      <!-- Next drive preview -->
      <div id="nextPreview">
        <div id="nextPreviewCard">
          <div id="nextPreviewTitle">
            Next drive in <span id="nextPreviewCountdown">10</span>s
          </div>
          <div id="nextPreviewStreet">Next street</div>
          <div id="nextPreviewLoc">City, Country</div>
          <div id="nextPreviewCountdownText"></div>
          <div id="nextPreviewActions">
            <button id="nextPreviewSkip" class="next-prev-btn" type="button">Stay here</button>
            <button id="nextPreviewNow" class="next-prev-btn primary" type="button">Next drive</button>
          </div>
        </div>
      </div>

      <div id="fadeLayer"></div>

      <!-- HUD hint for auto-hide -->
      <div id="hudHint">Tap or press any key to show controls</div>
    </div>
  </div>

  <!-- device toast -->
  <div id="deviceToast" role="status" aria-live="polite">
    <div>
      <div class="t-title">Better on Laptop/Desktop</div>
      <div class="t-sub">For the best driving experience, try a larger screen.</div>
    </div>
    <button id="toastClose" aria-label="Dismiss" type="button">‚úï</button>
  </div>

  <!-- share toast -->
  <div id="shareToast">Link copied</div>

  <!-- Soft objective -->
  <div id="softObjective">
    <div id="softObjectiveInner">
      <span>‚≠ê</span>
      <span id="softObjectiveText"></span>
    </div>
  </div>

  <!-- End-of-session reflection -->
  <div id="sessionSummary">
    <div class="session-card">
      <div class="session-card-title">Today‚Äôs drive</div>
      <div class="session-card-main">
        <span id="sessionStatsStreets">0 streets</span> ‚Ä¢
        <span id="sessionStatsTime">0 min</span>
      </div>
      <div class="session-card-sub" id="sessionStatsLocation">Exploring the world</div>
      <button id="sessionResumeLater" type="button">Resume later</button>
    </div>
  </div>

  <!-- Audio -->
  <audio id="engineAudio" src="/static/audio/engine.mp3" loop preload="auto"></audio>
  <audio id="gearAudio" src="/static/audio/gear-tick.mp3" preload="auto"></audio>

  <!-- Data -->
  <script id="streets-data" type="application/json">{{ streets | tojson | safe }}</script>
  <script id="selected-street-data" type="application/json">{{ selected_street | tojson | safe if selected_street else 'null' }}</script>

  <script>
    const DEBUG = false;
    const $ = (id) => document.getElementById(id);

    function setViewportHeightVar(){
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));
    }

    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    const R_EARTH_KM = 6371;
    function haversineKm(lat1, lon1, lat2, lon2){
      if (!Number.isFinite(lat1) || !Number.isFinite(lon1) || !Number.isFinite(lat2) || !Number.isFinite(lon2)) return NaN;
      const toRad = (d) => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R_EARTH_KM * c;
    }

    function isFullscreenActive(){
      return !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
    }
    function syncFsClass(){
      document.body.classList.toggle("is-fs", isFullscreenActive());
    }
    function ensureOverlayParent(overlayEl){
      if (!overlayEl) return;
      const parent = isFullscreenActive() ? viewerPanel : document.body;
      if (overlayEl.parentElement !== parent) parent.appendChild(overlayEl);
    }
    function restoreOverlayToBody(overlayEl){
      if (!overlayEl) return;
      if (overlayEl.parentElement !== document.body) document.body.appendChild(overlayEl);
    }

    function setCanvasTouchForOverlay(isOpen){
      if (!viewerCanvas) return;
      if (isOpen){
        viewerCanvas.dataset.prevTouchAction = viewerCanvas.style.touchAction || "";
        viewerCanvas.dataset.prevPointerEvents = viewerCanvas.style.pointerEvents || "";
        viewerCanvas.style.touchAction = "auto";
        viewerCanvas.style.pointerEvents = "none";
        document.body.classList.add("no-scroll");
      } else {
        viewerCanvas.style.touchAction = viewerCanvas.dataset.prevTouchAction || "";
        viewerCanvas.style.pointerEvents = viewerCanvas.dataset.prevPointerEvents || "";
        delete viewerCanvas.dataset.prevTouchAction;
        delete viewerCanvas.dataset.prevPointerEvents;
        document.body.classList.remove("no-scroll");
      }
    }

    /* DATA */
    let STREETS = [];
    let SELECTED = null;
    try{
      STREETS = JSON.parse($("streets-data").textContent || "[]");
      SELECTED = JSON.parse($("selected-street-data").textContent || "null");
      if (!Array.isArray(STREETS)) STREETS = [];
    }catch(e){
      STREETS = [];
      SELECTED = null;
    }

    /* SHARED LINK */
    let sharedIndexFromUrl = -1;
    let sharedTimeSeconds = null;
    let sharedJumpApplied = false;

    try{
      const urlParams = new URLSearchParams(window.location.search || "");
      const iParam = urlParams.get("i");
      const tParam = urlParams.get("t");

      if (iParam !== null){
        const idxById = STREETS.findIndex(s => String(s?._id) === iParam);
        if (idxById !== -1){
          sharedIndexFromUrl = idxById;
        } else {
          const asIndex = parseInt(iParam,10);
          if (!Number.isNaN(asIndex) && asIndex >= 0 && asIndex < STREETS.length){
            sharedIndexFromUrl = asIndex;
          }
        }
      }
      if (tParam !== null){
        const t = parseFloat(tParam);
        if (Number.isFinite(t) && t >= 0) sharedTimeSeconds = t;
      }
    }catch(_){}

    /* ROUTE MEMORY */
    const ROUTE_STORAGE_KEY = "abto_drive_route_memory_v1";

    function loadRouteMemory(){
      try{
        const raw = localStorage.getItem(ROUTE_STORAGE_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return (parsed && typeof parsed === "object") ? parsed : {};
      }catch(_){ return {}; }
    }

    let routeMemory = (typeof localStorage !== "undefined") ? loadRouteMemory() : {};

    function persistRouteMemory(){
      try{ localStorage.setItem(ROUTE_STORAGE_KEY, JSON.stringify(routeMemory)); }catch(_){}
    }

    function streetKeyFor(st){
      if (!st) return null;
      if (st._id != null) return String(st._id);
      return `${st.name || ""}_${st.lat || ""}_${st.lng || ""}`;
    }

    function getRouteForStreet(st){
      const key = streetKeyFor(st);
      if (!key) return null;
      return routeMemory[key] || null;
    }

    function updateRouteForStreet(st, patch){
      const key = streetKeyFor(st);
      if (!key) return;
      const prev = routeMemory[key] || {};
      routeMemory[key] = Object.assign({ streetKey:key }, prev, patch || {});
      persistRouteMemory();
    }

    /* DOM */
    const viewerPanel = $("viewerPanel");
    const viewerCanvas = $("viewerCanvas");

    const video = $("streetVideo");
    const vsrc = $("videoSource");
    const videoLoading = $("videoLoading");
    const driveVignette = $("driveVignette");
    const nightOverlay = $("nightOverlay");
    const rainOverlay = $("rainOverlay");
    const fadeLayer = $("fadeLayer");

    const streetHud = $("streetHud");
    const streetNameEl = $("streetName");
    const streetLocationEl = $("streetLocation");
    const streetTagsEl = $("streetTags");

    const miniMap = $("miniMap");

    const settingsBtn = $("settingsBtn");
    const settingsPanel = $("settingsPanel");

    const setVideoMuted = $("setVideoMuted");
    const setNightMode = $("setNightMode");
    const setVideoSharp = $("setVideoSharp");
    const cinematicMode = $("cinematicMode");
    const setHideDash = $("setHideDash");
    const setDashOpacity = $("setDashOpacity");
    const setEngineVol = $("setEngineVol");
    const driveMood = $("driveMood");

    const dashOverlay = $("dashOverlay");

    const streetsBtn = $("streetsBtn");
    const streetsDrawerOverlay = $("streetsDrawerOverlay");
    const streetsDrawerClose = $("streetsDrawerClose");
    const streetsSearch = $("streetsSearch");
    const streetsList = $("streetsList");

    const fullMapOverlay = $("fullMapOverlay");
    const fullMapContainer = $("fullMapContainer");
    const closeMapBtn = $("closeMapBtn");

    const fullscreenBtn = $("fullscreenBtn");
    const fsIcon = $("fsIcon");
    const fsLabel = $("fsLabel");

    const autoDriveBtn = $("autoDriveBtn");
    const autoDriveLabel = $("autoDriveLabel");

    const shareClipBtn = $("shareClipBtn");
    const shareToast = $("shareToast");
    const postcardBtn = $("postcardBtn");

    const joystickBase = $("joystickBase");
    const joystickKnob = $("joystickKnob");

    const startHint = $("startHint");
    const startHintSkip = $("startHintSkip");

    const deviceToast = $("deviceToast");
    const toastClose = $("toastClose");

    const popupCard = $("streetPopup");
    const popupTitle = $("popupTitle");
    const popupCity = $("popupCity");
    const popupCategory = $("popupCategory");
    const popupDescription = $("popupDescription");
    const popupClose = $("popupClose");

    const streetStory = $("streetStory");
    const streetStoryText = $("streetStoryText");

    const streetMemory = $("streetMemory");
    const streetMemoryText = $("streetMemoryText");

    const engineAudio = $("engineAudio");
    const gearAudio = $("gearAudio");

    const liveEvent = $("liveEvent");
    const liveEventText = $("liveEventText");

    const speedBtn = $("speedBtn");
    const speedBtnLabel = $("speedBtnLabel");
    const speedPop = $("speedPop");
    const speedBackdrop = $("speedBackdrop");

    const nextPreview = $("nextPreview");
    const nextPreviewCountdown = $("nextPreviewCountdown");
    const nextPreviewStreet = $("nextPreviewStreet");
    const nextPreviewLoc = $("nextPreviewLoc");
    const nextPreviewSkip = $("nextPreviewSkip");
    const nextPreviewNow = $("nextPreviewNow");
    const nextPreviewCountdownText = $("nextPreviewCountdownText");
    const nextPreviewTitleEl = $("nextPreviewTitle");

    const journeyPill = $("journeyPill");
    const journeyRouteEl = $("journeyRoute");
    const journeyMetaEl = $("journeyMeta");

    const softObjective = $("softObjective");
    const softObjectiveText = $("softObjectiveText");

    const sessionSummary = $("sessionSummary");
    const sessionStatsStreets = $("sessionStatsStreets");
    const sessionStatsTime = $("sessionStatsTime");
    const sessionStatsLocation = $("sessionStatsLocation");
    const sessionResumeLater = $("sessionResumeLater");

    /* SPEED POPUP */
    function openSpeed(){
      if (!speedPop || !speedBackdrop) return;
      speedPop.style.display = "block";
      speedBackdrop.style.display = "block";
      speedPop.setAttribute("aria-hidden", "false");
      speedBackdrop.setAttribute("aria-hidden", "false");
    }
    function closeSpeed(){
      if (!speedPop || !speedBackdrop) return;
      speedPop.style.display = "none";
      speedBackdrop.style.display = "none";
      speedPop.setAttribute("aria-hidden", "true");
      speedBackdrop.setAttribute("aria-hidden", "true");
    }
    function isSpeedOpen(){
      return speedPop && speedPop.style.display === "block";
    }

    speedBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();

      applyPortraitLock();
      if (document.body.classList.contains("is-portrait")) return;

      isSpeedOpen() ? closeSpeed() : openSpeed();
    });

    speedBackdrop?.addEventListener("pointerdown", () => closeSpeed(), { passive:true });

    /* ROTATE OVERLAY */
    const rotateOverlay = $("rotateOverlay");
    const rotateTryAgain = $("rotateTryAgain");
    const rotateHideHint = $("rotateHideHint");

    let rotateDismissed = (localStorage.getItem("abto_drive_rotate_dismissed") === "1");

    function isSmallDevice(){
      return window.innerWidth <= 980;
    }
    function isPortrait(){
      return window.matchMedia && window.matchMedia("(orientation: portrait)").matches
        ? true
        : (window.innerHeight > window.innerWidth);
    }

    function pauseForPortraitLock(){
      try{ video.pause(); }catch(_){}
      try{ engineAudio.pause(); }catch(_){}
    }

    function closeAllOverlaysHard(){
      settingsPanel.classList.remove("open");
      closeSpeed();

      if (streetsDrawerOverlay?.style.display === "block"){
        streetsDrawerOverlay.style.display = "none";
        streetsDrawerOverlay.setAttribute("aria-hidden", "true");
        restoreOverlayToBody(streetsDrawerOverlay);
      }
      if (fullMapOverlay?.style.display === "flex"){
        fullMapOverlay.style.display = "none";
        restoreOverlayToBody(fullMapOverlay);
      }
      if (popupCard?.style.display === "flex"){
        popupCard.style.display = "none";
        restoreOverlayToBody(popupCard);
      }
      setCanvasTouchForOverlay(false);
    }

    function applyPortraitLock(){
      const shouldBlock = isSmallDevice() && isPortrait() && !rotateDismissed;

      document.body.classList.toggle("is-portrait", shouldBlock);

      if (shouldBlock){
        ensureOverlayParent(rotateOverlay);
        rotateOverlay.style.display = "flex";
        closeAllOverlaysHard();
        pauseForPortraitLock();
      } else {
        rotateOverlay.style.display = "none";
        restoreOverlayToBody(rotateOverlay);
      }
    }

    rotateTryAgain?.addEventListener("click", () => applyPortraitLock());
    rotateHideHint?.addEventListener("click", () => {
      rotateDismissed = true;
      localStorage.setItem("abto_drive_rotate_dismissed", "1");
      applyPortraitLock();
    });

    /* STATE */
    let audioUnlocked = false;

    let currentIndex = -1;
    let currentVideos = [];
    let currentVideoIndex = 0;
    let isFirstStreetLoad = true;
    let isVideoLoading = false;

    let currentDir = 0;
    let strafe = 0;
    let joyActive = false;
    let joyPointerId = null;

    let motionMomentum = 0;

    let autoDriveEnabled = false;
    let reverseRAF = 0;

    let fullMapReady = false;
    let fullMap = null;
    let markerEls = [];

    let walkSpeed = 1.0;
    let currentGear = 2;
    const GEAR_SPEEDS = { 1:0.7, 2:1.0, 3:1.35, 4:1.7 };

    let tiltAngle = 0;
    const MAX_TILT = 7;
    const TILT_STEP = 2.4;

    let hlsInstance = null;

    let pendingSeekTime = null;
    let lastRouteSaveTime = 0;

    let nextPreviewActive = false;
    let nextPreviewTimerId = null;
    let nextPreviewSeconds = 0;
    let nextPreviewTargetIndex = -1;
    let previewArmedForVideo = false;

    let storyTimer = null;

    let routeLineSource = null;

    let lastSpeedForGear = walkSpeed;
    let streetLoadedAt = 0;
    let previewCooldownMs = 6000;

    let journeyActive = false;
    let journeyDistanceKm = 0;
    let journeyTimeSec = 0;
    let journeyStartLabel = "";
    let journeyLastLabel = "";
    let sessionStreetCount = 0;
    let sessionDriveSeconds = 0;
    let sessionLastCity = "";
    let sessionLastCountry = "";
    let sessionSummaryShown = false;
    let sessionIdleTimer = null;

    let liveEventCurrent = null;
    let liveEventIntensity = 0;
    let liveEventTimeout = null;

    let engineFadeTimer = null;
    let engineIdleVolume = 0.12;

    const LAST_SESSION_KEY = "abto_drive_last_session_v1";

    /* HUD AUTO-HIDE */
    let lastUserInteraction = Date.now();
    let hudHidden = false;
    const HUD_IDLE_MS = 5000;

    function bumpInteraction(){
      lastUserInteraction = Date.now();
      if (hudHidden){
        hudHidden = false;
        document.body.classList.remove("hud-hidden");
      }
    }

    ["pointerdown","keydown","touchstart"].forEach(type=>{
      window.addEventListener(type,(e)=>{
        if (type === "keydown"){
          const k = e.key;
          if (k === "Shift" || k === "Alt" || k === "Control") return;
        }
        bumpInteraction();
      },{passive:true});
    });

    /* AUDIO UNLOCK */
    function unlockAudio(){
      if (audioUnlocked) return;

      try{
        engineAudio.muted = false;
        engineAudio.volume = parseFloat(setEngineVol.value || "0.55") || 0.55;
        engineAudio.play().then(() => {
          engineAudio.pause();
          engineAudio.currentTime = 0;
        }).catch(()=>{});
      }catch(_){}

      audioUnlocked = true;
    }
    window.addEventListener("pointerdown", unlockAudio, { once:true });
    window.addEventListener("keydown", unlockAudio, { once:true });

    /* START HINT */
    function hideStartHint(){
      if (!startHint) return;
      startHint.style.opacity = "0";
      startHint.style.pointerEvents = "none";
      setTimeout(() => { startHint.style.display = "none"; }, 220);
    }
    startHintSkip?.addEventListener("click", hideStartHint);

    /* STREET STORY */
    function hideStreetStory(){
      if (!streetStory) return;
      streetStory.style.opacity = "0";
      setTimeout(() => { streetStory.style.display = "none"; }, 220);
    }

    function showStreetStoryFor(st){
      if (!streetStory || !streetStoryText) return;
      if (!st || !st.description){
        hideStreetStory();
        return;
      }
      if (storyTimer) clearTimeout(storyTimer);

      streetStoryText.textContent = st.description;
      streetStory.style.display = "block";
      streetStory.style.opacity = "0";
      setTimeout(() => { streetStory.style.opacity = "1"; }, 16);

      storyTimer = setTimeout(hideStreetStory, 3000);
    }

    /* STREET MEMORY */
    function hideStreetMemory(){
      if (!streetMemory) return;
      streetMemory.style.opacity = "0";
      setTimeout(() => { streetMemory.style.display = "none"; }, 220);
    }

    function showStreetMemory(mem){
      if (!streetMemory || !streetMemoryText || !mem) return;
      let msg = "";
      if (mem.night){
        msg = "You drove this street at night last time üåô";
      } else if (typeof mem.speed === "number" && mem.speed > 1.15){
        msg = `You like driving fast here (${mem.speed.toFixed(1)}√ó last time) üöÄ`;
      } else if (typeof mem.time === "number" && mem.time > 60){
        msg = "You cruised here for a while last time ‚è±";
      }
      if (!msg) return;

      streetMemoryText.textContent = msg;
      streetMemory.style.display = "block";
      streetMemory.style.opacity = "0";
      setTimeout(() => { streetMemory.style.opacity = "1"; }, 16);
      setTimeout(hideStreetMemory, 3500);
    }

    /* ROUTE SNAPSHOT SAVE */
    function saveCurrentRouteSnapshot(extra){
      const st = STREETS[currentIndex];
      if (!st) return;

      const snap = {
        speed: walkSpeed,
        night: !!setNightMode.checked,
        dashOpacity: parseFloat(setDashOpacity.value || "1") || 1,
        hideDash: !!setHideDash.checked,
        lastVisitedAt: Date.now()
      };
      if (Number.isFinite(video.currentTime || 0)) snap.time = video.currentTime;
      if (extra && typeof extra === "object") Object.assign(snap, extra);
      updateRouteForStreet(st, snap);
    }

    /* JOURNEY / SESSION */
    function deriveJourneyLabel(st){
      if (!st) return "";
      if (st.city) return st.city;
      if (st.name) return st.name;
      return "Unknown";
    }

    function formatJourneyMeta(){
      const km = journeyDistanceKm;
      const d = km < 0.1 ? `${(km*1000).toFixed(0)} m` : `${km.toFixed(1)} km`;
      const m = Math.floor(journeyTimeSec / 60);
      const s = Math.floor(journeyTimeSec % 60);
      const t = `${m}m ${String(s).padStart(2,"0")}s`;
      return `${d} ¬∑ ${t}`;
    }

    function updateJourneyUi(){
      if (!journeyPill) return;
      if (!journeyActive){
        journeyPill.style.display = "none";
        return;
      }
      journeyPill.style.display = "flex";
      if (journeyRouteEl){
        if (journeyStartLabel && journeyLastLabel && journeyStartLabel !== journeyLastLabel){
          journeyRouteEl.textContent = `${journeyStartLabel} ‚Üí ${journeyLastLabel}`;
        } else if (journeyStartLabel){
          journeyRouteEl.textContent = journeyStartLabel;
        } else {
          journeyRouteEl.textContent = "Exploring";
        }
      }
      if (journeyMetaEl){
        journeyMetaEl.textContent = formatJourneyMeta();
      }
    }

    function startJourneyForStreet(st){
      if (!st) return;
      journeyActive = true;
      journeyDistanceKm = 0;
      journeyTimeSec = 0;
      journeyStartLabel = deriveJourneyLabel(st);
      journeyLastLabel = journeyStartLabel;
      sessionStreetCount = 1;
      sessionDriveSeconds = 0;
      sessionLastCity = st.city || "";
      sessionLastCountry = st.country || "";
      if (journeyPill) journeyPill.style.display = "flex";
      updateJourneyUi();
      updateSoftObjective();
    }

    function humanizeMinutes(seconds){
      const m = Math.floor(seconds/60);
      const s = Math.floor(seconds%60);
      if (m <= 0) return `${s}s`;
      if (m < 60) return `${m} min${m>1?"s":""}`;
      const h = Math.floor(m/60);
      const rm = m % 60;
      if (rm === 0) return `${h} hr${h>1?"s":""}`;
      return `${h}h ${rm}m`;
    }

    function updateSessionSummaryUi(){
      if (!sessionSummary) return;
      sessionStatsStreets.textContent = `${sessionStreetCount} street${sessionStreetCount===1?"":"s"}`;
      sessionStatsTime.textContent = humanizeMinutes(sessionDriveSeconds);
      if (sessionLastCity || sessionLastCountry){
        sessionStatsLocation.textContent = `${sessionLastCity || ""}${sessionLastCity && sessionLastCountry ? ", " : ""}${sessionLastCountry || ""}`;
      } else {
        sessionStatsLocation.textContent = "Exploring the world";
      }
    }

    function showSessionSummary(){
      if (!sessionSummary || sessionSummaryShown || sessionStreetCount === 0) return;
      sessionSummaryShown = true;
      updateSessionSummaryUi();
      sessionSummary.style.display = "flex";
      requestAnimationFrame(() => {
        sessionSummary.classList.add("open");
      });

      const payload = {
        streets: sessionStreetCount,
        seconds: sessionDriveSeconds,
        city: sessionLastCity,
        country: sessionLastCountry,
        ts: Date.now()
      };
      try{ localStorage.setItem(LAST_SESSION_KEY, JSON.stringify(payload)); }catch(_){}
    }

    function scheduleSessionSummary(){
      if (sessionSummaryShown) return;
      if (sessionIdleTimer) clearTimeout(sessionIdleTimer);
      sessionIdleTimer = setTimeout(() => {
        if (currentDir === 0) showSessionSummary();
      }, 8000);
    }

    sessionResumeLater?.addEventListener("click", () => {
      sessionSummary.classList.remove("open");
      setTimeout(() => {
        sessionSummary.style.display = "none";
      }, 220);
    });

    /* SOFT OBJECTIVE */
    function updateSoftObjective(){
      if (!softObjective || !softObjectiveText) return;
      let msg = "";
      if (sessionStreetCount === 0){
        softObjective.style.opacity = "0";
        setTimeout(()=>{ softObjective.style.display="none"; }, 180);
        return;
      }
      if (sessionStreetCount < 3){
        const left = 3 - sessionStreetCount;
        msg = `Drive ${left} more street${left>1?"s":""} to unlock Warmup badge`;
      } else if (sessionStreetCount < 6){
        const left = 6 - sessionStreetCount;
        msg = `Drive ${left} more street${left>1?"s":""} to unlock Night Rider badge`;
      } else if (sessionStreetCount < 10){
        msg = "Most people stop here ‚Äî want to continue?";
      } else {
        msg = "";
      }

      if (!msg){
        softObjective.style.opacity = "0";
        setTimeout(()=>{ softObjective.style.display="none"; }, 180);
        return;
      }
      softObjectiveText.textContent = msg;
      softObjective.style.display = "block";
      requestAnimationFrame(() => { softObjective.style.opacity = "1"; });
    }

    /* LIVE EVENTS */
    function hideLiveEvent(){
      if (!liveEvent) return;
      liveEvent.style.opacity = "0";
      setTimeout(() => {
        liveEvent.style.display = "none";
      }, 200);
      liveEventCurrent = null;
    }

    function triggerLiveEvent(kind){
      if (!liveEvent || !liveEventText) return;
      if (liveEventCurrent) return;
      liveEventCurrent = kind;

      let msg = "";
      switch(kind){
        case "traffic": msg = "Traffic slowing ahead"; break;
        case "golden": msg = "Golden hour is starting"; break;
        case "rain": msg = "Light rain on the windshield"; break;
        case "police": msg = "Flashes of police lights nearby"; break;
        default: msg = "Something is happening on this street"; break;
      }

      liveEventText.textContent = msg;
      liveEvent.style.display = "block";
      liveEvent.style.opacity = "0";
      setTimeout(() => { liveEvent.style.opacity = "1"; }, 16);

      liveEventIntensity = 0.7;

      if (liveEventTimeout) clearTimeout(liveEventTimeout);
      liveEventTimeout = setTimeout(hideLiveEvent, 3500);
    }

    /* SETTINGS APPLY */
    function applySettings(){
      video.muted = !!setVideoMuted.checked;

      const mode = cinematicMode?.value || "off";
      const sharpBoost = setVideoSharp.checked ? 1.08 : 1.0;

      let nightOn = !!setNightMode.checked;
      let filter = "none";

      if (mode === "neo"){
        nightOn = true;
        filter = `brightness(0.55) contrast(${(1.18*sharpBoost).toFixed(2)}) saturate(${(1.20*sharpBoost).toFixed(2)}) hue-rotate(-6deg)`;
      } else if (mode === "warm"){
        filter = `brightness(0.92) contrast(${(1.12*sharpBoost).toFixed(2)}) saturate(${(1.15*sharpBoost).toFixed(2)}) sepia(0.12) hue-rotate(8deg)`;
      } else if (mode === "rain"){
        nightOn = true;
        filter = `brightness(0.78) contrast(${(1.10*sharpBoost).toFixed(2)}) saturate(${(1.05*sharpBoost).toFixed(2)})`;
      } else if (mode === "vintage"){
        filter = `brightness(0.95) contrast(${(1.05*sharpBoost).toFixed(2)}) saturate(${(0.90*sharpBoost).toFixed(2)}) sepia(0.25)`;
      } else {
        filter = setNightMode.checked
          ? `brightness(0.62) contrast(${(1.12*sharpBoost).toFixed(2)})`
          : (setVideoSharp.checked ? `contrast(${(1.08*sharpBoost).toFixed(2)}) saturate(${(1.04*sharpBoost).toFixed(2)})` : "none");
      }

      video.style.filter = filter;

      nightOverlay.style.opacity = nightOn ? "1" : "0";
      if (rainOverlay){
        rainOverlay.style.opacity = (mode === "rain") ? "0.85" : "0";
      }

      const hideDash = !!setHideDash.checked;
      dashOverlay.style.opacity = hideDash ? "0" : String(parseFloat(setDashOpacity.value || "1") || 1);
      dashOverlay.style.pointerEvents = "none";

      updateEngineSound();

      if (currentIndex !== -1){
        saveCurrentRouteSnapshot();
      }
    }

    [setVideoMuted, setNightMode, setVideoSharp, setHideDash, setDashOpacity, setEngineVol, cinematicMode]
      .forEach(el => el?.addEventListener("change", applySettings));
    setDashOpacity?.addEventListener("input", applySettings);
    setEngineVol?.addEventListener("input", applySettings);

    function setViewport(){
      setViewportHeightVar();
      syncFsClass();
      applyPortraitLock();
    }
    setViewport();

    window.addEventListener("resize", setViewport);
    window.addEventListener("orientationchange", setViewport);

    document.addEventListener("fullscreenchange", () => {
      setViewport();
      if (streetsDrawerOverlay?.style.display === "block") ensureOverlayParent(streetsDrawerOverlay);
      if (fullMapOverlay?.style.display === "flex") ensureOverlayParent(fullMapOverlay);
      if (popupCard?.style.display === "flex") ensureOverlayParent(popupCard);
      if (rotateOverlay?.style.display === "flex") ensureOverlayParent(rotateOverlay);
      setTimeout(() => { if (fullMap) fullMap.resize(); }, 160);
    });

    document.addEventListener("webkitfullscreenchange", () => {
      setViewport();
      if (streetsDrawerOverlay?.style.display === "block") ensureOverlayParent(streetsDrawerOverlay);
      if (fullMapOverlay?.style.display === "flex") ensureOverlayParent(fullMapOverlay);
      if (popupCard?.style.display === "flex") ensureOverlayParent(popupCard);
      if (rotateOverlay?.style.display === "flex") ensureOverlayParent(rotateOverlay);
      setTimeout(() => { if (fullMap) fullMap.resize(); }, 160);
    });

    /* FULLSCREEN BUTTON */
    const ICON_ENTER = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M16 3h3a2 2 0 0 1 2 2v3"/>
        <path d="M8 21H5a2 2 0 0 1-2-2v-3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/>
      </svg>`;
    const ICON_EXIT = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M9 3H5a2 2 0 0 0-2 2v4"/><path d="M15 3h4a2 2 0 0 1 2 2v4"/>
        <path d="M3 15v4a2 2 0 0 0 2 2h4"/><path d="M21 15v4a2 2 0 0 1-2 2h-4"/>
      </svg>`;

    function fsElement(){
      return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement || null;
    }
    function canFullscreen(){
      const el = viewerPanel || viewerCanvas || document.documentElement;
      return !!(el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen);
    }
    async function requestFullscreenOn(el){
      try{
        if (el.requestFullscreen) return await el.requestFullscreen({ navigationUI:"hide" });
        if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
        if (el.msRequestFullscreen) return el.msRequestFullscreen();
      }catch(err){ if (DEBUG) console.log(err); }
    }
    async function exitFullscreen(){
      try{
        if (document.exitFullscreen) return await document.exitFullscreen();
        if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
        if (document.msExitFullscreen) return document.msExitFullscreen();
      }catch(err){ if (DEBUG) console.log(err); }
    }
    function updateFullscreenButton(){
      if (!fullscreenBtn) return;
      if (!canFullscreen()){
        fullscreenBtn.style.opacity = "0.45";
        fullscreenBtn.style.pointerEvents = "none";
        fsIcon.innerHTML = ICON_ENTER;
        fsLabel.textContent = "No FS";
        return;
      }
      const active = !!fsElement();
      fsIcon.innerHTML = active ? ICON_EXIT : ICON_ENTER;
      fsLabel.textContent = active ? "Exit" : "Fullscreen";
      fullscreenBtn.style.opacity = "1";
      fullscreenBtn.style.pointerEvents = "auto";
    }
    updateFullscreenButton();

    fullscreenBtn?.addEventListener("click", async (e) => {
      e.preventDefault();

      applyPortraitLock();
      if (document.body.classList.contains("is-portrait")) return;

      closeSpeed();
      settingsPanel.classList.remove("open");

      if (streetsDrawerOverlay.style.display === "block") closeStreetsDrawer();

      if (popupCard.style.display === "flex"){
        popupCard.style.display = "none";
        restoreOverlayToBody(popupCard);
        setCanvasTouchForOverlay(false);
      }
      if (fullMapOverlay.style.display === "flex"){
        fullMapOverlay.style.display = "none";
        restoreOverlayToBody(fullMapOverlay);
        setCanvasTouchForOverlay(false);
      }

      const active = !!fsElement();
      if (!active){
        const target = viewerPanel || viewerCanvas || document.documentElement;
        await requestFullscreenOn(target);
      } else {
        await exitFullscreen();
      }
      updateFullscreenButton();
      setViewport();
    });

    /* STREETS DRAWER */
    let lastFocusBeforeDrawer = null;

    function openStreetsDrawer(){
      applyPortraitLock();
      if (document.body.classList.contains("is-portrait")) return;

      closeSpeed();

      lastFocusBeforeDrawer = document.activeElement;
      document.activeElement?.blur?.();

      ensureOverlayParent(streetsDrawerOverlay);
      streetsDrawerOverlay.style.display = "block";
      streetsDrawerOverlay.setAttribute("aria-hidden", "false");
      setCanvasTouchForOverlay(true);

      streetsSearch.value = "";
      renderStreetsList("");
      setTimeout(() => streetsSearch?.focus?.({ preventScroll:true }), 0);
    }

    function closeStreetsDrawer(){
      document.activeElement?.blur?.();

      streetsDrawerOverlay.style.display = "none";
      streetsDrawerOverlay.setAttribute("aria-hidden", "true");
      restoreOverlayToBody(streetsDrawerOverlay);
      setCanvasTouchForOverlay(false);

      if (lastFocusBeforeDrawer && document.contains(lastFocusBeforeDrawer)){
        lastFocusBeforeDrawer.focus({ preventScroll:true });
      } else {
        streetsBtn?.focus({ preventScroll:true });
      }
    }

    streetsBtn?.addEventListener("click", openStreetsDrawer);
    streetsDrawerClose?.addEventListener("click", closeStreetsDrawer);

    streetsDrawerOverlay?.addEventListener("pointerdown", (e) => {
      if (e.target === streetsDrawerOverlay) closeStreetsDrawer();
    }, { passive:true });

    $("streetsDrawer")?.addEventListener("pointerdown", (e) => e.stopPropagation(), { passive:true });

    streetsSearch?.addEventListener("input", () => renderStreetsList(streetsSearch.value || ""));

    function renderStreetsList(query){
      const q = (query || "").trim().toLowerCase();
      const rows = [];
      STREETS.forEach((s,i) => {
        const name = (s?.name || "").toLowerCase();
        const city = (s?.city || "").toLowerCase();
        const country = (s?.country || "").toLowerCase();
        if (q && !(name.includes(q) || city.includes(q) || country.includes(q))) return;
        rows.push({ s,i });
      });

      streetsList.innerHTML = rows.map(({s,i}) => {
        const active = (i === currentIndex) ? "active" : "";
        const meta = `${s.city || ""}${s.country ? ", " + s.country : ""}`.trim();
        return `
          <div class="street-item ${active}" data-index="${i}">
            <div class="name">${escapeHtml(s.name || "Drive")}</div>
            <div class="meta">üìç ${escapeHtml(meta || "Unknown location")}</div>
          </div>
        `;
      }).join("");

      streetsList.querySelectorAll(".street-item").forEach(el => {
        el.addEventListener("click", () => {
          const i = parseInt(el.dataset.index, 10);
          if (!Number.isNaN(i)){
            closeStreetsDrawer();
            loadStreetByIndex(i, true);
          }
        });
      });
    }

    /* SETTINGS PANEL */
    function closeSettingsPanel(){ settingsPanel.classList.remove("open"); }
    function toggleSettingsPanel(){ settingsPanel.classList.toggle("open"); }

    settingsBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();

      applyPortraitLock();
      if (document.body.classList.contains("is-portrait")) return;

      closeSpeed();

      if (streetsDrawerOverlay.style.display === "block") closeStreetsDrawer();
      if (fullMapOverlay.style.display === "flex"){
        fullMapOverlay.style.display = "none";
        restoreOverlayToBody(fullMapOverlay);
        setCanvasTouchForOverlay(false);
      }
      if (popupCard.style.display === "flex"){
        popupCard.style.display = "none";
        restoreOverlayToBody(popupCard);
        setCanvasTouchForOverlay(false);
      }

      toggleSettingsPanel();
    });

    document.addEventListener("pointerdown", (e) => {
      if (!settingsPanel.classList.contains("open")) return;
      const insidePanel = settingsPanel.contains(e.target);
      const insideBtn = settingsBtn.contains(e.target);
      if (!insidePanel && !insideBtn) closeSettingsPanel();
    }, { passive:true });

    /* SPEED LOGIC ‚Äì GEAR STYLE */
    function speedFromGear(g){
      const gearNum = parseInt(g,10);
      if (!Number.isFinite(gearNum)) return 1.0;
      return GEAR_SPEEDS[gearNum] ?? 1.0;
    }

    function nearestGearForSpeed(v){
      const val = Number.isFinite(v) ? v : 1.0;
      let bestGear = 2;
      let bestDiff = Infinity;
      for (const [gStr, speed] of Object.entries(GEAR_SPEEDS)){
        const g = parseInt(gStr,10);
        const diff = Math.abs(speed - val);
        if (diff < bestDiff){
          bestDiff = diff;
          bestGear = g;
        }
      }
      return bestGear;
    }

    function applyGearVisual(){
      if (speedBtnLabel){
        speedBtnLabel.textContent = `G${currentGear}`;
      }
      if (!speedPop) return;
      speedPop.querySelectorAll(".speed-opt").forEach(btn => {
        const btnGear = parseInt(btn.dataset.gear || "0",10);
        btn.classList.toggle("active", btnGear === currentGear);
      });
    }

    function updateWalkSpeedFromGear(){
      walkSpeed = speedFromGear(currentGear);
      if (!video.paused && currentDir === 1){
        video.playbackRate = walkSpeed;
      }
      updateEngineSound();
    }

    function playGearTick(){
      if (!gearAudio || !audioUnlocked) return;
      try{
        gearAudio.currentTime = 0;
        gearAudio.play().catch(()=>{});
      }catch(_){}
    }

    function setGear(gear){
      const prevGear = currentGear;
      const g = clamp(parseInt(gear || currentGear,10) || 2, 1, 4);
      currentGear = g;
      updateWalkSpeedFromGear();
      applyGearVisual();
      if (currentGear !== prevGear){
        playGearTick();
        lastSpeedForGear = walkSpeed;
        if (currentIndex !== -1){
          saveCurrentRouteSnapshot();
        }
      }
    }

    function setSpeedFromValue(v){
      const num = parseFloat(v);
      if (!Number.isFinite(num)){
        setGear(currentGear);
        return;
      }
      const g = nearestGearForSpeed(num);
      setGear(g);
    }

    speedPop?.querySelectorAll(".speed-opt").forEach(btn => {
      btn.addEventListener("click", () => {
        setGear(btn.dataset.gear);
        closeSpeed();
      });
    });

    function applyDriveMood(){
      if (!driveMood) return;
      const mood = driveMood.value;
      if (mood === "chill"){
        setGear(1);
        cinematicMode.value = "warm";
        setNightMode.checked = false;
      } else if (mood === "fast"){
        setGear(4);
        cinematicMode.value = "neo";
        setNightMode.checked = false;
      } else if (mood === "explore"){
        setGear(2);
        cinematicMode.value = "off";
      } else {
        return;
      }
      applySettings();
    }
    driveMood?.addEventListener("change", applyDriveMood);

    /* VIDEO SOURCE (HLS) */
    function destroyHls(){
      if (hlsInstance){
        try{ hlsInstance.destroy(); }catch(_){}
        hlsInstance = null;
      }
    }

    function hardResetVideo(){
      cancelReverseLoop();
      destroyHls();
      try{
        video.pause();
        video.removeAttribute("src");
        vsrc.src = "";
        video.load();
        video.currentTime = 0;
      }catch(_){}
    }

    function playVideoSource(url){
      destroyHls();
      if (!url){
        try{
          video.removeAttribute("src");
          vsrc.src = "";
          video.load();
        }catch(_){}
        return;
      }

      const isHls = /\.m3u8(\?.*)?$/i.test(url);

      try{
        video.pause();
        video.currentTime = 0;
        video.style.opacity = "0.01";
      }catch(_){}

      if (isHls && video.canPlayType("application/vnd.apple.mpegurl")){
        video.src = url;
        video.load();
        return;
      }

      if (isHls && window.Hls && Hls.isSupported()){
        hlsInstance = new Hls({ maxBufferLength: 12, maxMaxBufferLength: 30 });
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        return;
      }

      video.src = url;
      video.load();
    }

    function buildVideoList(street){
      const vids = [];
      if (Array.isArray(street?.videos) && street.videos.length){
        street.videos.forEach(v => { if (v?.url) vids.push(v.url); });
      }
      if (!vids.length && street?.videoUrl) vids.push(street.videoUrl);
      return vids;
    }

    /* AUDIO ENGINE */
    function updateEngineSound(){
      if (!audioUnlocked) return;
      const baseVol = parseFloat(setEngineVol.value || "0.55") || 0.55;

      if (currentDir === 1){
        const sp = walkSpeed * 1;
        engineAudio.playbackRate = 1 + sp * 0.35;
        engineAudio.volume = baseVol;
      } else if (currentDir === -1){
        const sp = walkSpeed * 1;
        engineAudio.playbackRate = 0.9 - sp * 0.25;
        engineAudio.volume = baseVol * 0.85;
      } else {
        engineAudio.playbackRate = 1;
      }
    }

    function fadeEngineToIdle(){
      if (!audioUnlocked) return;
      const startVol = engineAudio.volume || 0;
      const endVol = engineIdleVolume;
      if (startVol <= endVol + 0.01) return;
      const duration = 1800;
      const start = performance.now();

      if (engineFadeTimer) cancelAnimationFrame(engineFadeTimer);

      const step = (now) => {
        const t = clamp((now - start)/duration, 0, 1);
        engineAudio.volume = startVol + (endVol - startVol)*t;
        if (t < 1){
          engineFadeTimer = requestAnimationFrame(step);
        } else {
          engineFadeTimer = null;
        }
      };
      engineFadeTimer = requestAnimationFrame(step);
    }

    function cancelReverseLoop(){
      if (reverseRAF) cancelAnimationFrame(reverseRAF);
      reverseRAF = 0;
    }

    function playForward(){
      cancelReverseLoop();
      motionMomentum = Math.min(motionMomentum + 0.15, 1);
      if (!audioUnlocked) return;

      const start = () => {
        video.playbackRate = walkSpeed;
        video.play().catch(()=>{});
      };
      if (video.readyState >= 2) start();
      else video.addEventListener("loadeddata", start, { once:true });
    }

    function playReverse(){
      if (!audioUnlocked) return;
      cancelReverseLoop();
      video.pause();

      const step = () => {
        if (currentDir !== -1) { reverseRAF = 0; return; }

        const delta = 0.016 * walkSpeed;
        const dur = Number.isFinite(video.duration) ? video.duration : 0;

        if (!dur || dur < 0.05){
          reverseRAF = requestAnimationFrame(step);
          return;
        }

        video.currentTime = (video.currentTime - delta);
        if (video.currentTime <= 0.02) video.currentTime = dur - 0.02;

        reverseRAF = requestAnimationFrame(step);
      };

      reverseRAF = requestAnimationFrame(step);
    }

    function setDir(nextDir){
      if (nextDir === currentDir) return;
      const prevDir = currentDir;
      currentDir = nextDir;

      if (currentDir === 1){
        playForward();
      } else if (currentDir === -1){
        playReverse();
      } else {
        cancelReverseLoop();
        video.pause();
        fadeEngineToIdle();
      }

      if (prevDir !== currentDir && currentDir !== 0){
        playGearTick();
      }

      updateEngineSound();
      applySettings();

      if (currentDir !== 0) hideStartHint();

      if (prevDir !== 0 && currentDir === 0){
        scheduleSessionSummary();
      } else if (currentDir !== 0 && sessionIdleTimer){
        clearTimeout(sessionIdleTimer);
      }
    }

    /* NEXT DRIVE PREVIEW */
    function getNextIndex(){
      if (!STREETS.length) return -1;
      let next = currentIndex + 1;
      if (next >= STREETS.length) next = 0;
      return next;
    }

    function hideNextPreview(){
      nextPreviewActive = false;
      if (nextPreviewTimerId){
        clearInterval(nextPreviewTimerId);
        nextPreviewTimerId = null;
      }
      if (nextPreview) nextPreview.style.display = "none";
    }

    function showNextPreview(){
      if (!nextPreview) return;
      nextPreviewTargetIndex = getNextIndex();
      const st = STREETS[nextPreviewTargetIndex];
      if (!st) return;

      nextPreviewStreet.textContent = st.name || "Next drive";
      nextPreviewLoc.textContent =
        ((st.city || "") + (st.country ? ", " + st.country : "")) || "Unknown location";

      const dur = Number.isFinite(video.duration) ? video.duration : 0;
      const ct  = Number.isFinite(video.currentTime) ? video.currentTime : 0;
      const remaining = Math.max(0, Math.ceil(dur - ct));

      const base = remaining > 0 && remaining < 6 ? remaining : 3;
      nextPreviewSeconds = base || 3;

      if (nextPreviewTitleEl){
        nextPreviewTitleEl.innerHTML = `Next drive in <span id="nextPreviewCountdown">${nextPreviewSeconds}</span>s`;
      }
      if (nextPreviewCountdown){
        nextPreviewCountdown.textContent = String(nextPreviewSeconds);
      }

      if (nextPreviewCountdownText){
        if (dur && dur < 25){
          nextPreviewCountdownText.textContent = "That was short. Just one more street?";
        } else {
          nextPreviewCountdownText.textContent = "Coming up next:";
        }
      }

      nextPreview.style.display = "block";
      nextPreviewActive = true;

      if (nextPreviewTimerId) clearInterval(nextPreviewTimerId);
      nextPreviewTimerId = setInterval(() => {
        if (!nextPreviewActive) return;

        nextPreviewSeconds -= 1;

        if (nextPreviewSeconds <= 0){
          hideNextPreview();

          const d = Number.isFinite(video.duration) ? video.duration : 0;
          const c = Number.isFinite(video.currentTime) ? video.currentTime : 0;
          if (d > 0 && (d - c) <= 1.0){
            teleportNext();
          }
          return;
        }

        if (nextPreviewCountdown){
          nextPreviewCountdown.textContent = String(nextPreviewSeconds);
        }
      }, 1000);
    }

    nextPreviewSkip?.addEventListener("click", () => {
      hideNextPreview();
    });

    nextPreviewNow?.addEventListener("click", () => {
      hideNextPreview();
      teleportNext();
    });

    /* STREET LOAD */
    async function loadStreet(street){
      if (!street || !street.name){
        await teleportNext();
        return;
      }

      streetNameEl.textContent = street.name || "Drive";
      streetLocationEl.textContent =
        (street.city || "") + (street.city && street.country ? ", " : "") + (street.country || "");

      if (streetTagsEl){
        const tags = Array.isArray(street.tags) ? street.tags : [];
        if (tags.length){
          streetTagsEl.innerHTML = tags.slice(0,3).map(tag =>
            `<span class="street-tag-pill">${escapeHtml(String(tag))}</span>`
          ).join("");
          streetTagsEl.style.display = "flex";
        } else {
          streetTagsEl.innerHTML = "";
          streetTagsEl.style.display = "none";
        }
      }

      currentVideos = buildVideoList(street);
      currentVideoIndex = 0;

      hideNextPreview();
      previewArmedForVideo = false;
      pendingSeekTime = null;

      const mem = getRouteForStreet(street) || {};
      const hasMem = mem && Object.keys(mem).length > 0;

      if (typeof mem.speed === "number") setSpeedFromValue(mem.speed);
      if (typeof mem.dashOpacity === "number") setDashOpacity.value = String(mem.dashOpacity);
      if (typeof mem.hideDash === "boolean") setHideDash.checked = !!mem.hideDash;
      if (typeof mem.night === "boolean") setNightMode.checked = !!mem.night;

      if (!sharedJumpApplied && sharedIndexFromUrl !== -1 && STREETS[currentIndex] === street && sharedTimeSeconds != null){
        pendingSeekTime = sharedTimeSeconds;
        sharedJumpApplied = true;
      } else if (typeof mem.time === "number"){
        pendingSeekTime = mem.time;
      }

      applySettings();
      showStreetStoryFor(street);
      if (hasMem) showStreetMemory(mem);

      if (!currentVideos.length){
        await teleportNext();
        return;
      }

      if (isVideoLoading) return;
      isVideoLoading = true;

      if (isFirstStreetLoad){
        videoLoading.style.display = "flex";
        video.style.opacity = "0";
      }

      const url = currentVideos[0];
      hardResetVideo();
      playVideoSource(url);

      const onReady = () => {
        isVideoLoading = false;
        video.style.opacity = "1";

        streetLoadedAt = Date.now();
        previewArmedForVideo = false;
        hideNextPreview();

        if (Number.isFinite(pendingSeekTime) && pendingSeekTime >= 0 && Number.isFinite(video.duration) && video.duration > 0){
          const maxT = Math.max(0, video.duration - 0.25);
          video.currentTime = clamp(pendingSeekTime, 0, maxT);
        }

        if (isFirstStreetLoad){
          videoLoading.style.display = "none";
          isFirstStreetLoad = false;
        }
        if (currentDir === 1) playForward();
        else if (currentDir === -1) playReverse();
      };

      const onErr = async () => {
        isVideoLoading = false;
        if (isFirstStreetLoad) videoLoading.style.display = "none";
        await teleportNext();
      };

      video.addEventListener("loadeddata", onReady, { once:true });
      video.addEventListener("error", onErr, { once:true });
    }

    function updateMapMarkerHighlight(){
      markerEls.forEach(({ el, index }) => {
        el.classList.toggle("map-marker-selected", index === currentIndex);
      });
    }

    function loadStreetByIndex(i, userInitiated=false){
      if (!Number.isFinite(i) || i < 0 || i >= STREETS.length) return;

      const prevIndex = currentIndex;
      const prevStreet = (prevIndex >=0 && prevIndex < STREETS.length) ? STREETS[prevIndex] : null;

      currentIndex = i;
      const street = STREETS[i];

      if (!journeyActive && street){
        startJourneyForStreet(street);
      } else if (journeyActive && prevStreet && street && prevStreet !== street){
        const distKm = haversineKm(
          parseFloat(prevStreet.lat), parseFloat(prevStreet.lng),
          parseFloat(street.lat), parseFloat(street.lng)
        );
        if (Number.isFinite(distKm)) journeyDistanceKm += distKm;
        journeyLastLabel = deriveJourneyLabel(street);
        sessionStreetCount += 1;
        updateJourneyUi();
        updateSoftObjective();
      }

      if (street){
        sessionLastCity = street.city || sessionLastCity;
        sessionLastCountry = street.country || sessionLastCountry;
      }

      if (userInitiated){
        cancelReverseLoop();
      }

      loadStreet(street);
      updateMapMarkerHighlight();
      renderStreetsList(streetsSearch.value || "");
      updateRouteLines();

      if (fullMap && street){
        const s = street;
        const lng = parseFloat(s.lng), lat = parseFloat(s.lat);
        if (Number.isFinite(lng) && Number.isFinite(lat)){
          fullMap.flyTo({ center:[lng, lat], zoom:12, speed:0.9 });
        }
      }
    }

    async function teleportNext(){
      if (!STREETS.length) return;
      let next = currentIndex + 1;
      if (next >= STREETS.length) next = 0;

      fadeLayer.style.opacity = "1";
      await sleep(320);
      loadStreetByIndex(next);
      fadeLayer.style.opacity = "0";
    }

    /* VIDEO END */
    video.addEventListener("ended", async () => {
      if (currentVideos.length > 1 && currentVideoIndex < currentVideos.length - 1){
        currentVideoIndex++;
        const nextUrl = currentVideos[currentVideoIndex] || "";
        hardResetVideo();
        playVideoSource(nextUrl);
        if (currentDir === 1) playForward();
        return;
      }

      if (nextPreviewActive){
        return;
      }

      cancelReverseLoop();
      setDir(0);
      await teleportNext();
    });

    /* DRIVE ANIMATION TICK */
    let lastFrameTime = 0;
    let headBob = 0;
    let bobDir = 1;
    let strafeOffset = 0;
    const STRAFE_MAX = 90;

    function tick(t=0){
      if (!lastFrameTime) lastFrameTime = t;
      const dtMs = t - lastFrameTime;
      if (dtMs < 16){
        requestAnimationFrame(tick);
        return;
      }
      lastFrameTime = t;
      const dtSec = dtMs / 1000;

      if (journeyActive && currentDir !== 0){
        journeyTimeSec += dtSec;
        sessionDriveSeconds += dtSec;
        updateJourneyUi();
      }

      if (document.body.classList.contains("is-portrait")){
        requestAnimationFrame(tick);
        return;
      }

      if (document.hidden){
        if (!video.paused) video.pause();
        fadeEngineToIdle();
        requestAnimationFrame(tick);
        return;
      }

      motionMomentum *= 0.92;
      if (motionMomentum < 0.02) motionMomentum = 0;

      if (currentDir !== 0){
        headBob += bobDir * 0.22 * motionMomentum;
        if (headBob > 2 || headBob < -2) bobDir *= -1;
      } else {
        headBob *= 0.82;
      }

      if (strafe !== 0){
        strafeOffset += strafe * 4;
        strafeOffset = clamp(strafeOffset, -STRAFE_MAX, STRAFE_MAX);
      } else {
        strafeOffset *= 0.88;
      }

      const timeNow = Date.now();
      const swayX = Math.sin(timeNow * 0.002) * 2;
      const swayY = Math.cos(timeNow * 0.0015) * 1.2;

      if (currentDir !== 0 && !overlayOpen() && !document.hidden && !liveEventCurrent){
        if (Math.random() < 0.002){
          const kinds = ["traffic","golden","rain","police"];
          const kind = kinds[Math.floor(Math.random()*kinds.length)];
          triggerLiveEvent(kind);
        }
      }

      if (liveEventIntensity > 0){
        liveEventIntensity *= 0.96;
        if (liveEventIntensity < 0.05) liveEventIntensity = 0;
      }

      let intensity = (Math.abs(currentDir) > 0)
        ? clamp(motionMomentum * 0.7 + (walkSpeed - 1) * 0.35, 0.12, 1.15)
        : 0.12;

      intensity = clamp(intensity * (1 + (liveEventIntensity || 0)), 0.12, 1.6);

      const scale = 1 + 0.015 * intensity;

      video.style.transform =
        `translate(${strafeOffset*0.18 + swayX*intensity}px, ${headBob*1.35 + swayY*intensity}px) scale(${scale.toFixed(3)})`;

      const tilt = clamp(tiltAngle + (strafeOffset/STRAFE_MAX)*3, -MAX_TILT, MAX_TILT);
      dashOverlay.style.transform = `translateX(-50%) rotate(${tilt}deg) translateY(${Math.abs(headBob)*0.4}px)`;

      driveVignette.style.opacity = intensity > 0.1 ? intensity * 0.75 : 0;

      /* HUD auto-hide logic */
      const idle = Date.now() - lastUserInteraction;
      if (!hudHidden && idle > HUD_IDLE_MS && !overlayOpen() && !document.body.classList.contains("is-portrait")){
        hudHidden = true;
        document.body.classList.add("hud-hidden");
      } else if (hudHidden && (idle <= HUD_IDLE_MS || overlayOpen() || document.body.classList.contains("is-portrait"))){
        hudHidden = false;
        document.body.classList.remove("hud-hidden");
      }

      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);

    /* AUTO DRIVE */
    function setAutoDrive(on){
      autoDriveEnabled = on;
      if (autoDriveEnabled){
        setDir(1);
        autoDriveBtn.classList.add("on");
        autoDriveLabel.textContent = "Auto Drive: ON";
        if (audioUnlocked) engineAudio.play().catch(()=>{});
      } else {
        setDir(0);
        motionMomentum = 0.75;
        autoDriveBtn.classList.remove("on");
        autoDriveLabel.textContent = "Auto Drive";
      }
      applySettings();
    }

    function cancelAutoDriveIfUserMoves(){
      if (!autoDriveEnabled) return;
      setAutoDrive(false);
    }

    autoDriveBtn?.addEventListener("click", () => {
      applyPortraitLock();
      if (document.body.classList.contains("is-portrait")) return;

      unlockAudio();
      if (engineAudio.paused) engineAudio.play().catch(()=>{});
      setAutoDrive(!autoDriveEnabled);
    });

    /* JOYSTICK */
    const JOY_RADIUS = 34;

    function setMoveFromJoystick(nx, ny){
      const dead = 0.18;
      const absX = Math.abs(nx);
      const absY = Math.abs(ny);

      strafe = (absX > dead) ? nx : 0;

      let nextDir = 0;
      if (absY > dead) nextDir = (ny < 0) ? 1 : -1;

      if (nextDir !== 0 || strafe !== 0) cancelAutoDriveIfUserMoves();
      setDir(nextDir);

      if (nextDir !== 0 || strafe !== 0){
        motionMomentum = Math.min(motionMomentum + 0.12, 1);
      }
    }

    function resetJoystick(){
      joyActive = false;
      joystickBase.classList.remove("joy-active");
      joystickKnob.style.transform = `translate(0px, 0px)`;
      strafe = 0;
      tiltAngle = 0;

      if (!autoDriveEnabled) setDir(0);

      motionMomentum = 0.65;
      applySettings();
    }

    joystickBase?.addEventListener("pointerdown", (e) => {
      applyPortraitLock();
      if (document.body.classList.contains("is-portrait")) return;

      closeSpeed();

      e.preventDefault();
      unlockAudio();
      if (engineAudio.paused) engineAudio.play().catch(()=>{});

      joyPointerId = e.pointerId;
      joystickBase.setPointerCapture(joyPointerId);
      joyActive = true;
      joystickBase.classList.add("joy-active");
      hideStartHint();
    });

    joystickBase?.addEventListener("pointermove", (e) => {
      if (!joyActive || e.pointerId !== joyPointerId) return;

      const rect = joystickBase.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;

      let dx = e.clientX - cx;
      let dy = e.clientY - cy;

      const dist = Math.hypot(dx, dy);
      if (dist > JOY_RADIUS){
        dx = dx * (JOY_RADIUS / dist);
        dy = dy * (JOY_RADIUS / dist);
      }

      joystickKnob.style.transform = `translate(${dx}px, ${dy}px)`;

      const nx = dx / JOY_RADIUS;
      const ny = dy / JOY_RADIUS;

      setMoveFromJoystick(nx, ny);
    });

    function endJoy(e){
      if (!joyActive) return;
      if (e && joyPointerId !== null && e.pointerId !== joyPointerId) return;

      try{ joystickBase.releasePointerCapture(joyPointerId); }catch(_){}
      joyPointerId = null;
      resetJoystick();
    }

    joystickBase?.addEventListener("pointerup", endJoy);
    joystickBase?.addEventListener("pointercancel", endJoy);
    joystickBase?.addEventListener("pointerleave", endJoy);

    /* KEYBOARD */
    const keys = new Set();

    function overlayOpen(){
      return (
        settingsPanel.classList.contains("open") ||
        streetsDrawerOverlay.style.display === "block" ||
        fullMapOverlay.style.display === "flex" ||
        popupCard.style.display === "flex" ||
        (rotateOverlay && rotateOverlay.style.display === "flex") ||
        isSpeedOpen()
      );
    }

    function applyKeys(){
      if (overlayOpen()) return;

      let dir = 0;
      if (keys.has("w") || keys.has("arrowup")) dir = 1;
      if (keys.has("s") || keys.has("arrowdown")) dir = -1;

      let lean = 0;
      if (keys.has("a") || keys.has("arrowleft")) lean -= 1;
      if (keys.has("d") || keys.has("arrowright")) lean += 1;

      if (dir !== 0 || lean !== 0) cancelAutoDriveIfUserMoves();

      strafe = lean;

      if (lean === -1) tiltAngle = clamp(tiltAngle - TILT_STEP, -MAX_TILT, MAX_TILT);
      else if (lean === 1) tiltAngle = clamp(tiltAngle + TILT_STEP, -MAX_TILT, MAX_TILT);
      else tiltAngle *= 0.85;

      setDir(dir);

      if (dir !== 0 || lean !== 0){
        motionMomentum = Math.min(motionMomentum + 0.12, 1);
        hideStartHint();
      }
    }

    window.addEventListener("keydown", (e) => {
      const k = (e.key || "").toLowerCase();

      if (k === "escape"){
        if (isSpeedOpen()){ closeSpeed(); return; }

        if (fullMapOverlay.style.display === "flex"){
          fullMapOverlay.style.display = "none";
          restoreOverlayToBody(fullMapOverlay);
          setCanvasTouchForOverlay(false);
          return;
        }
        if (streetsDrawerOverlay.style.display === "block"){
          closeStreetsDrawer();
          return;
        }
        if (popupCard.style.display === "flex"){
          popupCard.style.display = "none";
          restoreOverlayToBody(popupCard);
          setCanvasTouchForOverlay(false);
          return;
        }
        if (settingsPanel.classList.contains("open")){
          settingsPanel.classList.remove("open");
          return;
        }
      }

      if (["w","a","s","d","arrowup","arrowdown","arrowleft","arrowright"].includes(k)){
        e.preventDefault();
        closeSpeed();
        unlockAudio();
        if (engineAudio.paused) engineAudio.play().catch(()=>{});
        keys.add(k);
        applyKeys();
      }
    });

    window.addEventListener("keyup", (e) => {
      const k = (e.key || "").toLowerCase();
      if (keys.has(k)){
        keys.delete(k);
        applyKeys();
      }
      if (k === "arrowleft" || k === "arrowright" || k === "a" || k === "d"){
        tiltAngle = 0;
      }
    });

    /* POPUP */
    streetHud?.addEventListener("click", () => {
      applyPortraitLock();
      if (document.body.classList.contains("is-portrait")) return;

      closeSpeed();

      const st = STREETS[currentIndex];
      if (!st) return;

      popupTitle.textContent = st.name || "Street";
      popupCity.textContent = (st.city || st.country)
        ? `üìç ${[st.city, st.country].filter(Boolean).join(", ")}`
        : "üìç Location not specified";

      popupCategory.textContent = st.category ? `üè∑ Category: ${st.category}` : "üè∑ No category";
      popupDescription.textContent = st.description || "No description added.";

      ensureOverlayParent(popupCard);
      popupCard.style.display = "flex";
      setCanvasTouchForOverlay(true);
    });

    popupClose?.addEventListener("click", () => {
      popupCard.style.display = "none";
      restoreOverlayToBody(popupCard);
      setCanvasTouchForOverlay(false);
    });

    popupCard?.addEventListener("click", (e) => {
      if (e.target === popupCard){
        popupCard.style.display = "none";
        restoreOverlayToBody(popupCard);
        setCanvasTouchForOverlay(false);
      }
    });

    /* MAP & ROUTE LINES */
    function updateRouteLines(){
      if (!fullMap || !fullMapReady || currentIndex < 0 || currentIndex >= STREETS.length) return;
      const base = STREETS[currentIndex];
      const lat0 = parseFloat(base?.lat);
      const lng0 = parseFloat(base?.lng);
      if (!Number.isFinite(lat0) || !Number.isFinite(lng0)) return;

      const neighbors = [];
      STREETS.forEach((s, idx) => {
        if (idx === currentIndex) return;
        const lat = parseFloat(s?.lat);
        const lng = parseFloat(s?.lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
        const dLat = lat - lat0;
        const dLng = lng - lng0;
        const dist2 = dLat*dLat + dLng*dLng;
        neighbors.push({ idx, lat, lng, dist2 });
      });

      neighbors.sort((a,b) => a.dist2 - b.dist2);
      const top = neighbors.slice(0, 3);

      const features = top.map(n => ({
        type:"Feature",
        geometry:{
          type:"LineString",
          coordinates:[[lng0, lat0],[n.lng, n.lat]]
        },
        properties:{}
      }));

      const data = { type:"FeatureCollection", features };

      if (!fullMap.getSource("abto-routes")){
        fullMap.addSource("abto-routes", { type:"geojson", data });
        fullMap.addLayer({
          id:"abto-routes-line",
          type:"line",
          source:"abto-routes",
          paint:{
            "line-color":"#38bdf8",
            "line-width":2,
            "line-opacity":0.7,
            "line-dasharray":[1.5,1.5]
          }
        });
      } else {
        fullMap.getSource("abto-routes").setData(data);
      }
    }

    function loadMap(){
      if (fullMapReady) return;
      if (typeof maplibregl === "undefined") return;

      fullMap = new maplibregl.Map({
        container: "fullMapContainer",
        style: "{{ map_style_url or 'https://api.maptiler.com/maps/streets/style.json?key=PqdU3M5vnOQK0dDQnkIq' }}",
        center: [0, 20],
        zoom: 2,
        pitch: 45,
        bearing: -20
      });

      fullMap.addControl(new maplibregl.NavigationControl());

      STREETS.forEach((s,i) => {
        const lat = parseFloat(s?.lat);
        const lng = parseFloat(s?.lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

        const el = document.createElement("div");
        Object.assign(el.style, {
          width:"18px",
          height:"18px",
          borderRadius:"50%",
          background:"#3b82f6",
          border:"2px solid white",
          cursor:"pointer"
        });

        const popup = new maplibregl.Popup({ offset: 16 }).setHTML(
          `<div style="font-size:12px;color:#0f172a;">
            <strong>${escapeHtml(s.name || "Street")}</strong><br/>
            <span>${escapeHtml((s.city || "") + (s.country ? ", " + s.country : ""))}</span>
          </div>`
        );

        const marker = new maplibregl.Marker({ element: el })
          .setLngLat([lng,lat])
          .setPopup(popup)
          .addTo(fullMap);

        markerEls.push({ index:i, el, marker });

        el.addEventListener("click", () => {
          loadStreetByIndex(i, true);
          updateMapMarkerHighlight();
          const coords = marker.getLngLat();
          fullMap.flyTo({ center:[coords.lng, coords.lat], zoom:13, speed:0.9 });
          popup.addTo(fullMap);
          fullMapOverlay.style.display = "none";
          restoreOverlayToBody(fullMapOverlay);
          setCanvasTouchForOverlay(false);
        });
      });

      if (currentIndex !== -1 && STREETS[currentIndex]){
        const st = STREETS[currentIndex];
        const lat = parseFloat(st.lat), lng = parseFloat(st.lng);
        if (Number.isFinite(lat) && Number.isFinite(lng)){
          fullMap.flyTo({ center:[lng,lat], zoom:8, speed:0.9 });
        }
      }

      fullMap.on("load", () => {
        updateRouteLines();
      });

      fullMapReady = true;
    }

    function openMapOverlay(){
      applyPortraitLock();
      if (document.body.classList.contains("is-portrait")) return;

      closeSpeed();

      ensureOverlayParent(fullMapOverlay);
      fullMapOverlay.style.display = "flex";
      setCanvasTouchForOverlay(true);
      loadMap();
      setTimeout(() => { if (fullMap) fullMap.resize(); }, 120);
    }

    miniMap?.addEventListener("click", openMapOverlay);

    closeMapBtn?.addEventListener("click", () => {
      fullMapOverlay.style.display = "none";
      restoreOverlayToBody(fullMapOverlay);
      setCanvasTouchForOverlay(false);
    });

    fullMapOverlay?.addEventListener("click", (e) => {
      if (e.target === fullMapOverlay){
        fullMapOverlay.style.display = "none";
        restoreOverlayToBody(fullMapOverlay);
        setCanvasTouchForOverlay(false);
      }
    });

    /* DEVICE TOAST */
    function showDeviceToastOnce(){
      const isSmall = window.innerWidth < 980;
      const already = localStorage.getItem("abto_drive_device_toast_dismissed") === "1";
      if (!isSmall || already) return;
      deviceToast.style.display = "flex";
    }
    showDeviceToastOnce();

    toastClose?.addEventListener("click", () => {
      deviceToast.style.display = "none";
      localStorage.setItem("abto_drive_device_toast_dismissed", "1");
    });

    /* SHARE CLIP */
    function showShareToast(){
      if (!shareToast) return;
      shareToast.style.display = "block";
      requestAnimationFrame(() => {
        shareToast.style.opacity = "1";
      });
      setTimeout(() => {
        shareToast.style.opacity = "0";
        setTimeout(() => { shareToast.style.display = "none"; }, 220);
      }, 1800);
    }

    shareClipBtn?.addEventListener("click", async () => {
      const st = STREETS[currentIndex];
      if (!st) return;

      const streetKey = streetKeyFor(st);
      const t = Math.floor(video.currentTime || 0);

      try{
        const url = new URL(window.location.href);
        const params = url.searchParams;
        if (streetKey && st._id != null){
          params.set("i", String(st._id));
        } else {
          params.set("i", String(currentIndex));
        }
        params.set("t", String(t));
        url.search = params.toString();

        const shareUrl = url.toString();
        if (navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(shareUrl);
        }
        showShareToast();
      }catch(_){}
    });

    /* POSTCARD */
    postcardBtn?.addEventListener("click", async () => {
      applyPortraitLock();
      if (document.body.classList.contains("is-portrait")) return;
      if (!window.html2canvas) return;

      try{
        const canvas = await html2canvas(viewerCanvas, {
          useCORS:true,
          backgroundColor:"#020617",
          scale: window.devicePixelRatio > 1 ? 2 : 1.5
        });
        const dataUrl = canvas.toDataURL("image/png");
        const link = document.createElement("a");
        const st = STREETS[currentIndex];
        const base = st ? (st.city || st.name || "drive") : "drive";
        link.download = `ABTO_${String(base).replace(/\s+/g,"_")}.png`;
        link.href = dataUrl;
        link.click();
      }catch(err){
        if (DEBUG) console.log("postcard error", err);
      }
    });

    /* VIDEO TIMEUPDATE */
    video.addEventListener("timeupdate", () => {
      const dur = video.duration;
      const ct = video.currentTime;

      if (!Number.isFinite(dur) || !Number.isFinite(ct) || dur <= 0) return;

      const now = Date.now();

      if (
        currentIndex !== -1 &&
        !video.paused &&
        now - lastRouteSaveTime > 1500
      ){
        saveCurrentRouteSnapshot();
        lastRouteSaveTime = now;
      }

      if (
        !previewArmedForVideo &&
        !video.paused &&
        currentDir === 1 &&
        dur > 12 &&
        (dur - ct) <= 10 &&
        (Date.now() - streetLoadedAt) > previewCooldownMs &&
        ct > 5
      ){
        previewArmedForVideo = true;
        showNextPreview();
      }
    });

    /* VISIBILITY */
    document.addEventListener("visibilitychange", () => {
      if (!audioUnlocked) return;
      if (!document.hidden){
        try{ engineAudio.play().catch(()=>{}); }catch(_){}
        updateEngineSound();
        if (currentDir !== 0){
          video.style.opacity = "0.4";
          setTimeout(() => {
            try{
              if (currentDir === 1) playForward();
              else if (currentDir === -1) playReverse();
              video.style.opacity = "1";
            }catch(_){}
          }, 120);
        }
      }
    });

    /* INIT */
    applySettings();
    renderStreetsList("");

    function pickInitial(){
      if (sharedIndexFromUrl !== -1) return sharedIndexFromUrl;
      if (SELECTED){
        const idx = STREETS.findIndex(s => s?._id === SELECTED?._id);
        return (idx !== -1 ? idx : 0);
      }
      return (STREETS.length ? 0 : -1);
    }

    viewerCanvas?.addEventListener("pointerdown", (e) => {
      if (isSpeedOpen() && !(speedPop.contains(e.target) || speedBtn.contains(e.target))) closeSpeed();
      if (!settingsPanel.classList.contains("open")) return;
      if (settingsPanel.contains(e.target) || settingsBtn.contains(e.target)) return;
      closeSettingsPanel();
    }, { passive:true });

    const first = pickInitial();
    if (first !== -1){
      loadStreetByIndex(first);
      videoLoading.style.display = "flex";
    } else {
      streetNameEl.textContent = "No drives found";
      streetLocationEl.textContent = "Add streets to start driving";
      videoLoading.style.display = "none";
      startHint.style.display = "none";
    }

    // Start in Gear 2 (cruise)
    setGear(2);

    document.addEventListener("pointerdown", () => {
      if (!audioUnlocked) return;
      engineAudio.play().catch(()=>{});
    }, { passive:true });

    video.addEventListener("loadeddata", () => {
      video.style.opacity = "1";
      if (isFirstStreetLoad){
        videoLoading.style.display = "none";
        isFirstStreetLoad = false;
      }
      applySettings();
      if (currentDir === 1) playForward();
      if (audioUnlocked) engineAudio.play().catch(()=>{});
    });

    video.addEventListener("error", () => {
      if (isFirstStreetLoad){
        videoLoading.style.display = "none";
        isFirstStreetLoad = false;
      }
      teleportNext();
    });

    applyPortraitLock();

    /* EXIT-INTENT */
    window.addEventListener("beforeunload", (e) => {
      if (journeyActive && journeyTimeSec > 60 && !sessionSummaryShown){
        const msg = "You‚Äôre halfway through a journey. Continue?";
        e.preventDefault();
        e.returnValue = msg;
        return msg;
      }
    });
  </script>
</body>
</html>
