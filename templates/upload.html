
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Street â€“ Virtual Street Walk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Add new virtual street walks with video or 3D GLB models">

  <!-- MAPLIBRE -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/maplibre-gl.css') }}">
<script src="{{ url_for('static', filename='js/maplibre-gl.js') }}"></script>

  <!-- ICONS -->
  <!-- remove your local all.min.css line and use this instead -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
  referrerpolicy="no-referrer"
>



  <!-- INTER FONT -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-dark: #020617;
      --glass: rgba(15,23,42,0.75);
      --glass-strong: rgba(15,23,42,0.92);
      --border: rgba(148,163,184,0.45);
      --accent: #38bdf8;
      --accent-strong: #0ea5e9;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --text: #e5e7eb;
      --text-muted: #94a3b8;
      --text-light: #cbd5e1;
      --radius: 18px;
      --radius-sm: 12px;
      --shadow: 0 24px 60px rgba(0,0,0,0.65);
      --shadow-hover: 0 32px 80px rgba(0,0,0,0.75);
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 40px 12px;
      background:
        radial-gradient(circle at top, #0f172a 0%, #1e293b 30%, #000 80%),
        linear-gradient(135deg, rgba(56,189,248,0.05) 0%, transparent 50%);
      font-family: 'Inter', system-ui, sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      color: var(--text);
      line-height: 1.6;
    }

    /* CARD */
    .card {
      width: 100%;
      max-width: 680px;
      padding: 40px;
      border-radius: var(--radius);
      background: var(--glass-strong);
      border: 1px solid var(--border);
      backdrop-filter: blur(20px);
      box-shadow: var(--shadow);
      animation: cardSlideIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-strong));
    }

    @keyframes cardSlideIn {
      from { opacity: 0; transform: translateY(30px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* HEADINGS */
    h1 {
      margin: 0 0 8px 0;
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent), var(--text));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      font-size: 15px;
      margin: 0 0 28px;
      color: var(--text-muted);
      font-weight: 400;
    }

    /* FIELD GROUPS */
    .field {
      margin-bottom: 22px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }

    label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    label i {
      color: var(--accent);
      width: 16px;
    }

    input, select, textarea {
      padding: 14px 16px;
      border-radius: var(--radius-sm);
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(148,163,184,0.3);
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(56,189,248,0.15);
      background: rgba(15,23,42,0.85);
      transform: translateY(-1px);
    }

    input::placeholder, textarea::placeholder {
      color: var(--text-muted);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: 'Monaco', 'Consolas', monospace;
    }

    /* MAP PICKER */
    #mapPicker {
      height: 280px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      border: 2px solid rgba(148,163,184,0.2);
      transition: all 0.3s ease;
      cursor: grab;
      position: relative;
    }

    #mapPicker:active {
      cursor: grabbing;
    }

    #mapPicker:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 25px rgba(56,189,248,0.2);
    }

    /* CUSTOM MAP BUTTONS */
    .map-controls {
      position: absolute;
      right: 18px;
      top: 18px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 5;
    }

    .map-controls button {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.7);
      background: radial-gradient(circle at top, #0f172a, #020617);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 12px 28px rgba(0,0,0,0.8);
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease, background 0.18s ease;
    }

    .map-controls button i {
      font-size: 16px;
    }

    .map-controls button:hover {
      transform: translateY(-1px);
      border-color: var(--accent);
      background: radial-gradient(circle at top, #1e293b, #020617);
      box-shadow: 0 16px 35px rgba(56,189,248,0.35);
    }

    .map-controls button:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(15,23,42,0.9);
    }

    /* Hide MapLibre default controls */
    .maplibregl-ctrl-top-right,
    .maplibregl-ctrl-bottom-right,
    .maplibregl-ctrl-bottom-left,
    .maplibregl-ctrl-top-left {
      display: none;
    }

    .note {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
      font-style: italic;
    }

    /* TOGGLE FIELDS */
    #videoFields, #modelFields {
      display: none;
      animation: fieldSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      padding: 20px;
      background: rgba(56,189,248,0.05);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(56,189,248,0.1);
      margin: 16px 0;
    }

    @keyframes fieldSlideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    #videoFields.active, #modelFields.active {
      display: block;
    }

    /* BUTTONS */
    button {
      padding: 16px 32px;
      border-radius: 999px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      color: white;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      box-shadow: 0 12px 30px rgba(56,189,248,0.35);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(56,189,248,0.45);
    }

    button:active {
      transform: translateY(0);
    }

    /* BACK LINK */
    .back-link {
      color: var(--accent);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
    }

    .back-link:hover {
      background: rgba(56,189,248,0.1);
      transform: translateX(-4px);
    }

    /* ACTIONS */
    .actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      gap: 16px;
    }

    /* FLASH MESSAGES */
    .flash {
      padding: 16px 20px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: flashSlide 0.4s ease;
    }

    @keyframes flashSlide {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .flash.success {
      background: rgba(34,197,94,0.15);
      border: 1px solid rgba(34,197,94,0.3);
      color: #bbf7d0;
    }

    .flash.success i { color: var(--success); }

    .flash.error {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      color: #fecaca;
    }

    .flash.error i { color: var(--error); }

    /* FILE INPUTS */
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      padding: 16px 20px;
      border: 2px dashed rgba(148,163,184,0.4);
      border-radius: var(--radius-sm);
      background: rgba(15,23,42,0.4);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      min-height: 72px;
    }

    .file-input-label:hover {
      border-color: var(--accent);
      background: rgba(56,189,248,0.1);
    }

    .file-input-label i {
      font-size: 20px;
      color: var(--accent);
      width: 24px;
    }

    .file-input-label.has-files {
      border-color: var(--success);
      background: rgba(16,185,129,0.1);
    }

    .file-input-label.has-files i {
      color: var(--success);
    }

    .file-list {
      font-size: 13px;
      color: var(--text-light);
      line-height: 1.4;
      max-height: 100px;
      overflow-y: auto;
    }

    /* COORDINATES */
    .coords-row {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .coords-row input {
      flex: 1;
    }

    /* VIDEO MODE */
    .video-mode-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .mode-option {
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148,163,184,0.3);
      background: rgba(15,23,42,0.6);
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
      font-size: 13px;
      font-weight: 500;
    }

    .mode-option:hover,
    .mode-option.active {
      border-color: var(--accent);
      background: rgba(56,189,248,0.15);
      color: var(--accent);
    }

    /* RESPONSIVE */
    @media (max-width: 820px) {
      body { padding: 24px 16px; }
      .card {
        max-width: 100%;
        padding: 28px 24px;
      }
      h1 { font-size: 26px; }
      #mapPicker { height: 240px; }
      .actions {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
      }
      button { width: 100%; }
      .back-link { justify-content: center; }
    }

    @media (max-width: 480px) {
      body { padding: 16px 12px; }
      .card { padding: 24px 20px; }
      h1 { font-size: 24px; }
      .field { margin-bottom: 18px; }
      #mapPicker { height: 200px; }
      .coords-row { flex-direction: column; gap: 8px; }
      .video-mode-grid { grid-template-columns: repeat(2, 1fr); }
      .map-controls { right: 12px; top: 12px; }
    }

    /* LOADING */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .loading button::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 600px) {
      .card {
        backdrop-filter: blur(10px);
      }
    }
  </style>
</head>

<body>
  <div class="card">
    <h1><i class="fas fa-map-marker-alt"></i> Add Street</h1>
    <p class="subtitle">Upload real street videos or 3D GLB worlds for virtual walking experiences</p>

    <!-- FLASH Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash {{ category }}">
            <i class="fas {% if category == 'success' %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %}"></i>
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- FORM -->
    <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" id="streetForm">

      <!-- STREET TYPE -->
      <div class="field">
        <label><i class="fas fa-street-view"></i> Street Type *</label>
        <select name="street_type" id="streetType" required>
          <option value="">Choose Type</option>
          <option value="video">ðŸ“¹ Video Street</option>
          <option value="3d">ðŸ§Š 3D GLB Street</option>
        </select>
        <div class="note">Video streets use MP4/WEBM files, 3D streets use GLB models</div>
      </div>

      <!-- BASIC INFO -->
      <div class="field">
        <label><i class="fas fa-sign-hanging"></i> Street Name *</label>
        <input type="text" name="name" placeholder="Eg: Marina Walk Lane" required maxlength="100">
      </div>

      <div class="field">
        <label><i class="fas fa-city"></i> City *</label>
        <input type="text" name="city" placeholder="Eg: Dubai" required maxlength="50">
      </div>

      <div class="field">
        <label><i class="fas fa-flag"></i> Country *</label>
        <input type="text" name="country" placeholder="Eg: UAE" required maxlength="50">
      </div>

      <!-- MAP PICKER -->
      <div class="field">
        <label><i class="fas fa-map-pin"></i> Select Location *</label>
        <div id="mapPicker">
          <div class="map-controls">
            <button type="button" id="zoomInBtn" title="Zoom in">
              <i class="fas fa-plus"></i>
            </button>
            <button type="button" id="zoomOutBtn" title="Zoom out">
              <i class="fas fa-minus"></i>
            </button>
            <button type="button" id="locateBtn" title="Use my location">
              <i class="fas fa-location-crosshairs"></i>
            </button>
          </div>
        </div>
        <div class="coords-row">
          <input type="number" id="lat" name="lat" step="0.000001" placeholder="Latitude (auto-filled)" required>
          <input type="number" id="lng" name="lng" step="0.000001" placeholder="Longitude (auto-filled)" required>
        </div>
        <div class="note">Click anywhere on the map or use the buttons to set coordinates</div>
      </div>

      <!-- VIDEO STREET FIELDS -->
      <div id="videoFields">
        <div class="field">
          <label><i class="fas fa-video"></i> Video Mode *</label>
          <div class="video-mode-grid">
            <div class="mode-option active" data-mode="walk">
              <i class="fas fa-person-walking"></i><br>Walk
            </div>
            <div class="mode-option" data-mode="drive">
              <i class="fas fa-car"></i><br>Drive
            </div>
            <div class="mode-option" data-mode="fly">
              <i class="fas fa-plane"></i><br>Fly
            </div>
            <div class="mode-option" data-mode="sit">
              <i class="fas fa-chair"></i><br>Sit
            </div>
          </div>
          <input type="hidden" name="mode" id="videoMode" value="walk">
          <div class="note">Choose viewing perspective for avatar synchronization</div>
        </div>

        <!-- CATEGORY FIELD -->
<div class="field">
  <label><i class="fas fa-folder"></i> Category *</label>

  <select id="categorySelect" required>
    <!-- Options will be dynamically inserted -->
  </select>

  <input type="hidden" name="category" id="categoryHidden">

  <div class="note">Category changes automatically based on mode</div>
</div>

<label>Description (optional)</label>
<textarea name="description" rows="4"
          placeholder="Describe this street, what makes it specialâ€¦"
          style="width:100%; border-radius:12px; padding:10px; background:#0f172a; color:#fff; border:1px solid #334155;">
</textarea>



        <div class="field">
          <label><i class="fas fa-upload"></i> Upload Videos (MP4/WEBM)</label>
          <div class="file-input-wrapper">
            <input type="file" name="video" id="videoUpload" accept="video/mp4,video/webm,video/quicktime" multiple>
            <label for="videoUpload" class="file-input-label">
              <i class="fas fa-cloud-upload-alt"></i>
              Choose Videos or Drag & Drop
            </label>
          </div>
          <div class="note">Max 100MB per video. Multiple videos create seamless loops.</div>
        </div>

        <div class="field">
          <label><i class="fas fa-link"></i> OR Video URLs</label>
          <textarea name="video_links" placeholder="https://example.com/video1.mp4
https://example.com/video2.mp4
Paste multiple URLs (one per line)" rows="3"></textarea>
          <div class="note">Cloudinary/Vimeo/YouTube supported URLs (comma or newline separated)</div>
        </div>
      </div>

      <!-- 3D GLB FIELDS -->
      <div id="modelFields">
        <div class="field">
          <label><i class="fas fa-cube"></i> Upload GLB Model *</label>
          <div class="file-input-wrapper">
            <input type="file" name="model" id="modelUpload" accept=".glb,.gltf">
            <label for="modelUpload" class="file-input-label">
              <i class="fas fa-cube"></i>
              Upload GLB Model (Max 50MB)
            </label>
          </div>
          <div class="note">3D street environment stored securely in Supabase Storage</div>
        </div>

        <div class="field">
          <label><i class="fas fa-external-link-alt"></i> OR GLB URL</label>
          <input type="url" name="model_link" placeholder="https://example.com/street.glb">
          <div class="note">Public GLB URL (CORS must allow cross-origin requests)</div>
        </div>
      </div>

      <div class="actions">
        <a class="back-link" href="{{ url_for('index') }}">
          <i class="fas fa-arrow-left"></i>
          Back to Streets
        </a>
        <button type="submit">
          <i class="fas fa-save"></i>
          Save Street
        </button>
      </div>
    </form>
  </div>

  <script>
    /* ===============================
       ENHANCED MAPTILER MAP PICKER
    =============================== */
    let map, marker;
    const MAPTILER_KEY = 'PqdU3M5vnOQK0dDQnkIq'; // Your MapTiler key

    function initMap() {
      map = new maplibregl.Map({
        container: "mapPicker",
        style: `https://api.maptiler.com/maps/streets/style.json?key=${MAPTILER_KEY}`,
        center: [55.2708, 25.2048], // Dubai
        zoom: 12,
        pitch: 45,
        attributionControl: false
      });

      // Click to set marker
      map.on('click', (e) => {
        const lng = e.lngLat.lng.toFixed(6);
        const lat = e.lngLat.lat.toFixed(6);

        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lng;

        if (marker) marker.remove();
        marker = new maplibregl.Marker({
          color: '#38bdf8',
          scale: 1.2
        })
        .setLngLat([lng, lat])
        .setPopup(new maplibregl.Popup().setText(`ðŸ“ ${lat}, ${lng}`))
        .addTo(map);

        map.flyTo({
          center: [lng, lat],
          zoom: 16,
          pitch: 60,
          duration: 1000
        });
      });

      // Custom zoom + locate buttons
      const zoomInBtn  = document.getElementById("zoomInBtn");
      const zoomOutBtn = document.getElementById("zoomOutBtn");
      const locateBtn  = document.getElementById("locateBtn");

      zoomInBtn.addEventListener("click", () => {
        map.zoomIn({ duration: 250 });
      });

      zoomOutBtn.addEventListener("click", () => {
        map.zoomOut({ duration: 250 });
      });

      locateBtn.addEventListener("click", () => {
        if (!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition((pos) => {
          const lng = pos.coords.longitude.toFixed(6);
          const lat = pos.coords.latitude.toFixed(6);

          document.getElementById('lat').value = lat;
          document.getElementById('lng').value = lng;

          if (marker) marker.remove();
          marker = new maplibregl.Marker({
            color: '#38bdf8',
            scale: 1.2
          })
          .setLngLat([lng, lat])
          .addTo(map);

          map.flyTo({
            center: [lng, lat],
            zoom: 16,
            pitch: 60,
            duration: 900
          });
        });
      });
    }

    /* ===============================
       DYNAMIC FIELD TOGGLING
    =============================== */
    const streetType = document.getElementById('streetType');
    const videoFields = document.getElementById('videoFields');
    const modelFields = document.getElementById('modelFields');

    streetType.addEventListener('change', () => {
      videoFields.classList.remove('active');
      modelFields.classList.remove('active');

      if (streetType.value === 'video') {
        videoFields.classList.add('active');
      } else if (streetType.value === '3d') {
        modelFields.classList.add('active');
      }
    });

    /* ===============================
   VIDEO MODE + CATEGORY SELECTOR
=============================== */

const modeButtons = document.querySelectorAll('.mode-option');
const categorySelect = document.getElementById("categorySelect");
const categoryHidden = document.getElementById("categoryHidden");

/* CATEGORY LISTS */
const CATEGORY_MAP = {
  walk: ["City Walk", "Airport Terminal", "Highway Footpath", "Beach Walk", "Park Walk", "Market Walk"],
  drive: ["City Drive", "Highway Drive", "Night Drive", "Rain Drive", "Bridge Drive", "Village Roads"],
  fly: ["Drone Panorama", "Drone Over Beach", "Drone City Flyover", "Mountain Flyover"],
  sit: ["Coffee Shop", "Balcony View", "Sunset View", "Indoor Room", "Street Side Bench"]
};

/* Update category dropdown */
function updateCategories(mode) {
  categorySelect.innerHTML = "";

  CATEGORY_MAP[mode].forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    categorySelect.appendChild(opt);
  });

  categoryHidden.value = CATEGORY_MAP[mode][0];
}

/* When mode clicked */
modeButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    modeButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const mode = btn.dataset.mode;
    document.getElementById("videoMode").value = mode;

    updateCategories(mode);
  });
});

/* When category changed */
categorySelect.addEventListener("change", () => {
  categoryHidden.value = categorySelect.value;
});

/* default mode = walk */
updateCategories("walk");

    /* ===============================
       SHOW SELECTED FILE NAMES
    =============================== */
    function displaySelectedFiles(inputId, labelSelector) {
      const input = document.getElementById(inputId);
      const label = input.nextElementSibling;
      
      input.addEventListener("change", () => {
        const files = input.files;

        if (!files || files.length === 0) {
          label.innerHTML = `
            <i class="fas fa-cloud-upload-alt"></i>
            Choose Files or Drag & Drop
          `;
          label.classList.remove('has-files');
          return;
        }

        let html = "";
        if (files.length === 1) {
          html = `<strong>${files[0].name}</strong>`;
        } else {
          html = `${files.length} files selected:<br><div class="file-list">`;
          for (let f of files) {
            html += `â€¢ ${f.name}<br>`;
          }
          html += `</div>`;
        }

        label.innerHTML = `
          <i class="fas fa-check-circle"></i>
          ${html}
        `;
        label.classList.add('has-files');
      });
    }

    displaySelectedFiles("videoUpload");
    displaySelectedFiles("modelUpload");

    /* ===============================
       FORM VALIDATION & SUBMISSION
    =============================== */
    const form = document.getElementById('streetForm');
    const submitBtn = form.querySelector('button[type="submit"]');

    form.addEventListener('submit', (e) => {
      const streetTypeValue = streetType.value;

      // Client-side validation
      if (streetTypeValue === 'video') {
        const videoFiles = document.getElementById('videoUpload').files;
        const videoLinks = form.video_links.value.trim();
        if (videoFiles.length === 0 && !videoLinks) {
          e.preventDefault();
          alert('Please upload videos or provide video URLs');
          return;
        }
      } else if (streetTypeValue === '3d') {
        const modelFile = document.getElementById('modelUpload').files[0];
        const modelLink = form.model_link.value.trim();
        if (!modelFile && !modelLink) {
          e.preventDefault();
          alert('Please upload a GLB model or provide a GLB URL');
          return;
        }
      }

      // Show loading state
      form.classList.add('loading');
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    });

    /* ===============================
       FILE DRAG & DROP
    =============================== */
    ['videoUpload', 'modelUpload'].forEach(id => {
      const input = document.getElementById(id);
      const label = input.nextElementSibling;

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        label.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        label.addEventListener(eventName, () => label.classList.add('dragover'), false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        label.addEventListener(eventName, () => label.classList.remove('dragover'), false);
      });

      label.addEventListener('drop', (e) => {
        input.files = e.dataTransfer.files;
        displaySelectedFiles(id); // Trigger file display update
      });
    });

    /* ===============================
       GEOLOCATION ON LAT FOCUS
    =============================== */
    document.getElementById('lat').addEventListener('focus', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          document.getElementById('lat').value = pos.coords.latitude.toFixed(6);
          document.getElementById('lng').value = pos.coords.longitude.toFixed(6);
        });
      }
    });

    // Initialize map when DOM is ready
    document.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>

