<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Street â€“ Virtual Street Walk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Add new virtual street walks with video or 3D GLB models">

  <!-- MAPLIBRE -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/maplibre-gl.css') }}">
  <script src="{{ url_for('static', filename='js/maplibre-gl.js') }}"></script>

  <!-- ICONS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    referrerpolicy="no-referrer"
  >

  <!-- INTER FONT -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-dark: #020617;
      --glass: rgba(15,23,42,0.70);
      --glass-strong: rgba(15,23,42,0.92);
      --border: rgba(148,163,184,0.45);
      --accent: #38bdf8;
      --accent-soft: rgba(56,189,248,0.12);
      --accent-strong: #0ea5e9;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --text: #e5e7eb;
      --text-muted: #94a3b8;
      --text-light: #cbd5e1;
      --radius: 20px;
      --radius-sm: 12px;
      --shadow: 0 26px 70px rgba(0,0,0,0.75);
      --shadow-hover: 0 32px 90px rgba(0,0,0,0.85);
      --focus-ring: 0 0 0 3px rgba(56,189,248,0.35);
    }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 32px 12px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      font-family: 'Inter', system-ui, sans-serif;
      color: var(--text);
      line-height: 1.6;
      background:
        radial-gradient(circle at top, #0f172a 0%, #020617 35%, #000 90%),
        linear-gradient(135deg, rgba(56,189,248,0.06) 0%, transparent 55%);
    }

    .card {
      width: 100%;
      max-width: 720px;
      padding: 32px 32px 26px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
      border: 1px solid var(--border);
      backdrop-filter: blur(22px) saturate(130%);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      animation: cardSlideIn 0.55s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-strong));
    }

    .card::after {
      content: '';
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.06), transparent 55%),
        radial-gradient(circle at bottom right, rgba(129,140,248,0.06), transparent 55%);
      opacity: 0.5;
      pointer-events: none;
    }

    @keyframes cardSlideIn {
      from { opacity: 0; transform: translateY(32px) scale(0.98); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }

    h1 {
      margin: 0 0 6px 0;
      font-size: 28px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.01em;
      background: linear-gradient(135deg, var(--accent), #e5e7eb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      z-index: 1;
    }

    h1 i {
      font-size: 20px;
      color: var(--accent);
      -webkit-text-fill-color: initial;
    }

    .subtitle {
      font-size: 14px;
      margin: 0 0 22px;
      color: var(--text-muted);
      max-width: 460px;
    }

    .field {
      margin-bottom: 18px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      position: relative;
      z-index: 1;
    }

    label {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    label i {
      color: var(--accent);
      width: 16px;
    }

    input, select, textarea {
      padding: 11px 13px;
      border-radius: var(--radius-sm);
      background: rgba(15,23,42,0.82);
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.16s ease, box-shadow 0.16s ease, background 0.16s ease, transform 0.12s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: var(--focus-ring);
      background: rgba(15,23,42,0.95);
      transform: translateY(-1px);
    }

    input::placeholder, textarea::placeholder {
      color: var(--text-muted);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: 'Inter', system-ui, sans-serif;
    }

    #mapPicker {
      height: 270px;
      border-radius: var(--radius-sm);
      overflow: hidden;
      border: 1px solid rgba(30,64,175,0.85);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 18px 40px rgba(0,0,0,1),
        0 0 40px rgba(37,99,235,0.4);
      cursor: grab;
      position: relative;
      background: #020617;
    }

    #mapPicker:active {
      cursor: grabbing;
    }

    #mapPicker:hover {
      border-color: var(--accent);
      box-shadow:
        0 0 0 1px rgba(15,23,42,1),
        0 24px 52px rgba(0,0,0,1),
        0 0 48px rgba(56,189,248,0.45);
    }

    .map-controls {
      position: absolute;
      right: 16px;
      top: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 5;
    }

    .map-controls button {
      width: 38px;
      height: 38px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.7);
      background: radial-gradient(circle at top, #0f172a, #020617);
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 12px 28px rgba(0,0,0,0.8);
      transition: transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease, background 0.16s ease;
    }

    .map-controls button i {
      font-size: 15px;
    }

    .map-controls button:hover {
      transform: translateY(-1px);
      border-color: var(--accent);
      background: radial-gradient(circle at top, #1e293b, #020617);
      box-shadow: 0 16px 34px rgba(56,189,248,0.34);
    }

    .map-controls button:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(15,23,42,0.9);
    }

    .maplibregl-ctrl-top-right,
    .maplibregl-ctrl-bottom-right,
    .maplibregl-ctrl-bottom-left,
    .maplibregl-ctrl-top-left {
      display: none;
    }

    .note {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
      font-style: italic;
    }

    #videoFields, #modelFields {
      display: none;
      animation: fieldSlideIn 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      padding: 14px 16px 16px;
      background: var(--accent-soft);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(56,189,248,0.2);
      margin: 10px 0 18px;
    }

    @keyframes fieldSlideIn {
      from { opacity: 0; transform: translateX(12px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    #videoFields.active, #modelFields.active {
      display: block;
    }

    .btn-primary {
      padding: 13px 26px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      color: white;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      box-shadow: 0 14px 32px rgba(56,189,248,0.35);
      transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      min-width: 170px;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 20px 44px rgba(56,189,248,0.45);
      filter: brightness(1.05);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 10px 24px rgba(15,23,42,0.9);
    }

    .back-link {
      color: var(--text-muted);
      text-decoration: none;
      font-size: 13px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 9px 14px;
      border-radius: var(--radius-sm);
      transition: color 0.16s ease, background 0.16s ease, transform 0.16s ease;
    }

    .back-link i {
      font-size: 13px;
    }

    .back-link:hover {
      background: rgba(15,23,42,0.85);
      color: var(--accent);
      transform: translateX(-3px);
    }

    .actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      padding-top: 18px;
      border-top: 1px solid rgba(30,41,59,0.9);
      gap: 16px;
      position: relative;
      z-index: 1;
    }

    .flash {
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: flashSlide 0.35s ease;
    }

    @keyframes flashSlide {
      from { opacity: 0; transform: translateY(-8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .flash.success {
      background: rgba(34,197,94,0.14);
      border: 1px solid rgba(34,197,94,0.32);
      color: #bbf7d0;
    }

    .flash.success i { color: var(--success); }

    .flash.error {
      background: rgba(239,68,68,0.16);
      border: 1px solid rgba(239,68,68,0.34);
      color: #fecaca;
    }

    .flash.error i { color: var(--error); }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }

    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      padding: 13px 14px;
      border: 1px dashed rgba(148,163,184,0.6);
      border-radius: var(--radius-sm);
      background: rgba(15,23,42,0.6);
      cursor: pointer;
      transition: border-color 0.18s ease, background 0.18s ease, transform 0.12s ease;
      font-weight: 500;
      min-height: 64px;
      font-size: 13px;
    }

    .file-input-label:hover {
      border-color: var(--accent);
      background: rgba(56,189,248,0.12);
      transform: translateY(-1px);
    }

    .file-input-label i {
      font-size: 18px;
      color: var(--accent);
      width: 22px;
    }

    .file-input-label.has-files {
      border-color: var(--success);
      background: rgba(16,185,129,0.12);
    }

    .file-input-label.has-files i {
      color: var(--success);
    }

    .file-list {
      font-size: 12px;
      color: var(--text-light);
      line-height: 1.4;
      max-height: 96px;
      overflow-y: auto;
    }

    .coords-row {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    .coords-row input {
      flex: 1;
    }

    .video-mode-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .mode-option {
      padding: 9px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.7);
      cursor: pointer;
      text-align: center;
      transition: border-color 0.16s ease, background 0.16s ease, color 0.16s ease, transform 0.12s ease;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
    }

    .mode-option i {
      display: block;
      margin-bottom: 4px;
      font-size: 15px;
    }

    .mode-option:hover,
    .mode-option.active {
      border-color: var(--accent);
      background: rgba(56,189,248,0.16);
      color: #e0f2fe;
      transform: translateY(-1px);
    }

    @media (max-width: 820px) {
      body { padding: 24px 12px; }
      .card {
        max-width: 100%;
        padding: 26px 20px 22px;
        border-radius: 18px;
      }
      h1 { font-size: 24px; }
      #mapPicker { height: 240px; }
      .actions {
        flex-direction: column-reverse;
        align-items: stretch;
      }
      .btn-primary { width: 100%; }
      .back-link {
        justify-content: center;
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      body { padding: 16px 10px; }
      .card { padding: 22px 16px 18px; border-radius: 16px; }
      h1 { font-size: 22px; }
      .subtitle { font-size: 13px; }
      .field { margin-bottom: 16px; }
      #mapPicker { height: 210px; }
      .coords-row { flex-direction: column; gap: 6px; }
      .video-mode-grid { grid-template-columns: repeat(2, 1fr); }
      .map-controls { right: 10px; top: 10px; }
    }

    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .loading .btn-primary::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 600px) {
      .card {
        backdrop-filter: blur(14px);
      }
    }
  </style>
</head>

<body>
  <div class="card">
    <h1><i class="fas fa-map-marker-alt"></i> Add Street</h1>
    <p class="subtitle">Upload real street videos or 3D GLB worlds for immersive virtual walking experiences.</p>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash {{ category }}">
            <i class="fas {% if category == 'success' %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %}"></i>
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data" id="streetForm">
      <div class="field">
        <label><i class="fas fa-street-view"></i> Street Type *</label>
        <select name="street_type" id="streetType" required>
          <option value="">Choose Type</option>
          <option value="video">ðŸ“¹ Video Street</option>
          <option value="3d">ðŸ§Š 3D GLB Street</option>
        </select>
        <div class="note">Video streets use MP4/WEBM files; 3D streets use GLB models.</div>
      </div>

      <div class="field">
        <label><i class="fas fa-sign-hanging"></i> Street Name *</label>
        <input type="text" name="name" placeholder="Eg: Marina Walk Lane" required maxlength="100">
      </div>

      <div class="field">
        <label><i class="fas fa-city"></i> City *</label>
        <input type="text" name="city" placeholder="Eg: Dubai" required maxlength="50">
      </div>

      <div class="field">
        <label><i class="fas fa-flag"></i> Country *</label>
        <input type="text" name="country" placeholder="Eg: UAE" required maxlength="50">
      </div>

      <div class="field">
        <label><i class="fas fa-map-pin"></i> Select Location *</label>
        <div id="mapPicker">
          <div class="map-controls">
            <button type="button" id="zoomInBtn" title="Zoom in">
              <i class="fas fa-plus"></i>
            </button>
            <button type="button" id="zoomOutBtn" title="Zoom out">
              <i class="fas fa-minus"></i>
            </button>
            <button type="button" id="locateBtn" title="Use my location">
              <i class="fas fa-location-crosshairs"></i>
            </button>
          </div>
        </div>
        <div class="coords-row">
          <input type="number" id="lat" name="lat" step="0.000001" placeholder="Latitude (auto-filled)" required>
          <input type="number" id="lng" name="lng" step="0.000001" placeholder="Longitude (auto-filled)" required>
        </div>
        <div class="note">Click anywhere on the map or use the buttons to set coordinates.</div>
      </div>

      <div id="videoFields">
        <div class="field">
          <label><i class="fas fa-video"></i> Video Mode *</label>
          <div class="video-mode-grid">
            <div class="mode-option active" data-mode="walk">
              <i class="fas fa-person-walking"></i>Walk
            </div>
            <div class="mode-option" data-mode="drive">
              <i class="fas fa-car"></i>Drive
            </div>
            <div class="mode-option" data-mode="fly">
              <i class="fas fa-plane"></i>Fly
            </div>
            <div class="mode-option" data-mode="sit">
              <i class="fas fa-chair"></i>Sit
            </div>
          </div>
          <input type="hidden" name="mode" id="videoMode" value="walk">
          <div class="note">Choose viewing perspective for avatar synchronization.</div>
        </div>

        <div class="field">
          <label><i class="fas fa-folder"></i> Category *</label>
          <select id="categorySelect" required></select>
          <input type="hidden" name="category" id="categoryHidden">
          <div class="note">Category suggestions update automatically based on the selected mode.</div>
        </div>

        <div class="field">
          <label><i class="fas fa-align-left"></i> Description (optional)</label>
          <textarea
            name="description"
            rows="4"
            placeholder="Describe this street and what makes it specialâ€¦"></textarea>
        </div>

        <div class="field">
          <label><i class="fas fa-upload"></i> Upload Videos (MP4/WEBM)</label>
          <div class="file-input-wrapper">
            <input type="file" name="video" id="videoUpload" accept="video/mp4,video/webm,video/quicktime" multiple>
            <label for="videoUpload" class="file-input-label">
              <i class="fas fa-cloud-upload-alt"></i>
              <span>Choose videos or drag & drop</span>
            </label>
          </div>
          <div class="note">Max 100MB per video. Multiple videos create a smoother loop.</div>
        </div>

        <div class="field">
          <label><i class="fas fa-link"></i> OR Video URLs</label>
          <textarea
            name="video_links"
            rows="3"
            placeholder="https://example.com/video1.mp4
https://example.com/video2.mp4
Paste multiple URLs, one per line."></textarea>
          <div class="note">Cloudinary / Vimeo / YouTube URLs supported (newline or comma separated).</div>
        </div>
      </div>

      <div id="modelFields">
        <div class="field">
          <label><i class="fas fa-cube"></i> Upload GLB Model *</label>
          <div class="file-input-wrapper">
            <input type="file" name="model" id="modelUpload" accept=".glb,.gltf">
            <label for="modelUpload" class="file-input-label">
              <i class="fas fa-cube"></i>
              <span>Upload GLB model (max 50MB)</span>
            </label>
          </div>
          <div class="note">3D street environments are stored securely in Supabase Storage.</div>
        </div>

        <div class="field">
          <label><i class="fas fa-external-link-alt"></i> OR GLB URL</label>
          <input type="url" name="model_link" placeholder="https://example.com/street.glb">
          <div class="note">Public GLB URL; CORS must allow crossâ€‘origin requests.</div>
        </div>
      </div>

      <div class="actions">
        <a class="back-link" href="{{ url_for('index') }}">
          <i class="fas fa-arrow-left"></i>
          Back to streets
        </a>
        <button type="submit" class="btn-primary">
          <i class="fas fa-save"></i>
          Save street
        </button>
      </div>
    </form>
  </div>

  <script>
    let map, marker;
    const MAPTILER_KEY = 'PqdU3M5vnOQK0dDQnkIq';

    function initMap() {
      map = new maplibregl.Map({
        container: "mapPicker",
        style: `https://api.maptiler.com/maps/streets/style.json?key=${MAPTILER_KEY}`,
        center: [55.2708, 25.2048],
        zoom: 12,
        pitch: 45,
        attributionControl: false
      });

      map.on('click', (e) => {
        const lng = e.lngLat.lng.toFixed(6);
        const lat = e.lngLat.lat.toFixed(6);

        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lng;

        if (marker) marker.remove();
        marker = new maplibregl.Marker({
          color: '#38bdf8',
          scale: 1.2
        })
        .setLngLat([lng, lat])
        .setPopup(new maplibregl.Popup().setText(`ðŸ“ ${lat}, ${lng}`))
        .addTo(map);

        map.flyTo({
          center: [lng, lat],
          zoom: 16,
          pitch: 60,
          duration: 1000
        });
      });

      const zoomInBtn  = document.getElementById("zoomInBtn");
      const zoomOutBtn = document.getElementById("zoomOutBtn");
      const locateBtn  = document.getElementById("locateBtn");

      zoomInBtn.addEventListener("click", () => {
        map.zoomIn({ duration: 250 });
      });

      zoomOutBtn.addEventListener("click", () => {
        map.zoomOut({ duration: 250 });
      });

      locateBtn.addEventListener("click", () => {
        if (!navigator.geolocation) return;
        navigator.geolocation.getCurrentPosition((pos) => {
          const lng = pos.coords.longitude.toFixed(6);
          const lat = pos.coords.latitude.toFixed(6);

          document.getElementById('lat').value = lat;
          document.getElementById('lng').value = lng;

          if (marker) marker.remove();
          marker = new maplibregl.Marker({
            color: '#38bdf8',
            scale: 1.2
          })
          .setLngLat([lng, lat])
          .addTo(map);

          map.flyTo({
            center: [lng, lat],
            zoom: 16,
            pitch: 60,
            duration: 900
          });
        });
      });
    }

    const streetType = document.getElementById('streetType');
    const videoFields = document.getElementById('videoFields');
    const modelFields = document.getElementById('modelFields');

    streetType.addEventListener('change', () => {
      videoFields.classList.remove('active');
      modelFields.classList.remove('active');

      if (streetType.value === 'video') {
        videoFields.classList.add('active');
      } else if (streetType.value === '3d') {
        modelFields.classList.add('active');
      }
    });

    const modeButtons = document.querySelectorAll('.mode-option');
    const categorySelect = document.getElementById("categorySelect");
    const categoryHidden = document.getElementById("categoryHidden");

    const CATEGORY_MAP = {
      walk: ["City Walk", "Airport Terminal", "Highway Footpath", "Beach Walk", "Park Walk", "Market Walk"],
      drive: ["City Drive", "Highway Drive", "Night Drive", "Rain Drive", "Bridge Drive", "Village Roads"],
      fly:  ["Drone Panorama", "Drone Over Beach", "Drone City Flyover", "Mountain Flyover"],
      sit:  ["Coffee Shop", "Balcony View", "Sunset View", "Indoor Room", "Street Side Bench"]
    };

    function updateCategories(mode) {
      categorySelect.innerHTML = "";
      CATEGORY_MAP[mode].forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
      categoryHidden.value = CATEGORY_MAP[mode][0];
    }

    modeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        modeButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const mode = btn.dataset.mode;
        document.getElementById("videoMode").value = mode;
        updateCategories(mode);
      });
    });

    categorySelect.addEventListener("change", () => {
      categoryHidden.value = categorySelect.value;
    });

    updateCategories("walk");

    function wireFileLabel(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      const label = input.nextElementSibling;

      input.addEventListener("change", () => {
        const files = input.files;

        if (!files || files.length === 0) {
          label.innerHTML = `
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Choose files or drag & drop</span>
          `;
          label.classList.remove('has-files');
          return;
        }

        let html = "";
        if (files.length === 1) {
          html = `<strong>${files[0].name}</strong>`;
        } else {
          html = `${files.length} files selected:<br><div class="file-list">`;
          for (let f of files) {
            html += `â€¢ ${f.name}<br>`;
          }
          html += `</div>`;
        }

        label.innerHTML = `
          <i class="fas fa-check-circle"></i>
          <span>${html}</span>
        `;
        label.classList.add('has-files');
      });
    }

    wireFileLabel("videoUpload");
    wireFileLabel("modelUpload");

    const form = document.getElementById('streetForm');
    const submitBtn = form.querySelector('button[type="submit"]');

    form.addEventListener('submit', (e) => {
      const streetTypeValue = streetType.value;

      if (streetTypeValue === 'video') {
        const videoFiles = document.getElementById('videoUpload').files;
        const videoLinks = form.video_links.value.trim();
        if (videoFiles.length === 0 && !videoLinks) {
          e.preventDefault();
          alert('Please upload at least one video or provide video URLs.');
          return;
        }
      } else if (streetTypeValue === '3d') {
        const modelFile = document.getElementById('modelUpload').files[0];
        const modelLink = form.model_link.value.trim();
        if (!modelFile && !modelLink) {
          e.preventDefault();
          alert('Please upload a GLB model or provide a GLB URL.');
          return;
        }
      }

      form.classList.add('loading');
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Savingâ€¦';
    });

    ['videoUpload', 'modelUpload'].forEach(id => {
      const input = document.getElementById(id);
      if (!input) return;
      const label = input.nextElementSibling;

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        label.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        label.addEventListener(eventName, () => label.classList.add('dragover'), false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        label.addEventListener(eventName, () => label.classList.remove('dragover'), false);
      });

      label.addEventListener('drop', (e) => {
        input.files = e.dataTransfer.files;
        input.dispatchEvent(new Event('change'));
      });
    });

    document.getElementById('lat').addEventListener('focus', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          document.getElementById('lat').value = pos.coords.latitude.toFixed(6);
          document.getElementById('lng').value = pos.coords.longitude.toFixed(6);
        });
      }
    });

    document.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>
