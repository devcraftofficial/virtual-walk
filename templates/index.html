<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ABTO - A Better Travel Observer</title>

  <!-- Viewport & Color Scheme -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <meta name="theme-color" content="#071018" />

  <meta name="description" content="ABTO - A Better Travel Observer. Explore real streets worldwide with immersive walk, drive, sit and fly modes." />
  <link rel="canonical" href="{{ url_for('index', _external=True) }}" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="ABTO - A Better Travel Observer" />
  <meta property="og:description" content="Explore real streets worldwide with immersive walk, drive, sit and fly modes." />
  <meta property="og:url" content="{{ url_for('index', _external=True) }}" />
  <meta property="og:image" content="{{ url_for('static', filename='img/og-image.jpg', _external=True) }}" />

  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ABTO - A Better Travel Observer" />
  <meta name="twitter:description" content="Explore real streets worldwide with immersive walk, drive, sit and fly modes." />
  <meta name="twitter:image" content="{{ url_for('static', filename='img/og-image.jpg', _external=True) }}" />
  <meta name="twitter:url" content="{{ url_for('index', _external=True) }}" />

  <!-- Favicons -->
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}" />
  <link rel="shortcut icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}" />
  <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='img/fav.png') }}" />
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/fav.png') }}" />
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='img/fav.png') }}" />

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <!-- Preload -->
  <link rel="preload" as="image" href="{{ url_for('static', filename='img/main.png') }}" />

  <!-- CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/home-abto.css') }}">

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebSite",
    "name":"ABTO - A Better Travel Observer",
    "url":"{{ url_for('index', _external=True) }}"
  }
  </script>
</head>

<body>
  <a href="#main" class="skip-link">Skip to main content</a>

  <noscript>
    <div style="background:#00111a;color:#f9fafb;text-align:center;padding:8px 16px;font-size:14px;">
      ABTO works best with JavaScript enabled. Please enable it to explore real streets.
    </div>
  </noscript>

  <!-- PRELOADER -->
  <div class="loading" id="preloader" aria-label="Loading ABTO" role="status">
    <div class="loading-inner">
      <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
      <span>Loading streets...</span>
    </div>
  </div>

  <!-- Mobile overlay -->
  <div class="overlay" id="overlay" aria-hidden="true"></div>

  <div class="app-shell">
    <!-- SIDEBAR -->
    <nav id="navbar" role="navigation" aria-label="Main navigation">
      <div class="sidebar-inner">

        <div class="drawer-header">
          <a href="{{ url_for('index') }}" class="logo" aria-label="ABTO Home">
            <div class="logo-badge" aria-hidden="true">
              <img src="{{ url_for('static', filename='img/logo.png') }}" alt="" />
            </div>
            <div class="logo-text">
              <span class="logo-title">ABTO</span>
              <span class="logo-sub">A Better Travel Observer</span>
            </div>
          </a>

          <button class="mobile-close" id="closeSidebar" type="button" aria-label="Close menu">
            <i class="fas fa-xmark"></i>
          </button>
        </div>

        <!-- User label (sidebar) -->
        {% if current_user %}
          {% set USER_LABEL = current_user.name if current_user.name is defined and current_user.name
              else (current_user.full_name if current_user.full_name is defined and current_user.full_name
              else (current_user.email if current_user.email is defined and current_user.email else 'User')) %}
          <div style="margin-top:10px; padding:0 6px;">
            <div class="user-pill" style="width:100%; justify-content:flex-start;">
              <i class="fas fa-user-circle" aria-hidden="true"></i>
              <span title="{{ USER_LABEL }}">Hi, {{ USER_LABEL }}</span>
            </div>
          </div>
        {% endif %}

        <div class="sidebar-scroll" id="navLinks">
          <div class="sidebar-section-label">Explore</div>
          <div class="nav-links">
            <a href="{{ url_for('index') }}" class="nav-link" aria-current="page">
              <i class="fas fa-compass" aria-hidden="true"></i><span>Explore</span>
            </a>
            <a href="#streets" class="nav-link">
              <i class="fas fa-road" aria-hidden="true"></i><span>All streets</span>
            </a>
            <a href="#tour-preview" class="nav-link">
              <i class="fas fa-location-dot" aria-hidden="true"></i><span>Tour places</span>
            </a>
            <a href="#how-it-works" class="nav-link">
              <i class="fas fa-circle-info" aria-hidden="true"></i><span>How it works</span>
            </a>
            <a href="#trip-price" class="nav-link">
              <i class="fas fa-ticket-alt" aria-hidden="true"></i><span>Trip price check</span>
            </a>

            <div class="sidebar-section-label">Modes</div>
            <a href="{{ url_for('world_walk') }}" class="nav-link">
              <i class="fas fa-person-walking" aria-hidden="true"></i><span>Walk</span>
            </a>
            <a href="{{ url_for('world_drive') }}" class="nav-link">
              <i class="fas fa-car" aria-hidden="true"></i><span>Drive</span>
            </a>
            <a href="{{ url_for('world_sit') }}" class="nav-link">
              <i class="fas fa-chair" aria-hidden="true"></i><span>Sit</span>
            </a>
            <a href="{{ url_for('world_fly') }}" class="nav-link">
              <i class="fas fa-plane" aria-hidden="true"></i><span>Fly</span>
            </a>

            <div class="sidebar-section-label">Account</div>
            {% if current_user %}
              <a href="{{ url_for('dashboard') }}" class="nav-link">
                <i class="fas fa-gauge-high" aria-hidden="true"></i><span>Dashboard</span>
              </a>
              <a href="{{ url_for('logout') }}" class="nav-link">
                <i class="fas fa-sign-out-alt" aria-hidden="true"></i><span>Logout</span>
              </a>
            {% else %}
              <a href="{{ url_for('login') }}" class="nav-link">
                <i class="fas fa-right-to-bracket" aria-hidden="true"></i><span>Login</span>
              </a>
              <a href="{{ url_for('signup') }}" class="nav-link">
                <i class="fas fa-rocket" aria-hidden="true"></i><span>Get started</span>
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>

    <!-- MAIN -->
    <div class="app-main">
      <div class="topbar-wrap">
        <header class="topbar" aria-label="Search and quick actions">
          <button class="mobile-open" id="openSidebar" type="button" aria-label="Open menu">
            <i class="fas fa-bars"></i>
          </button>

          <div class="topbar-search">
            <i class="fas fa-search" aria-hidden="true"></i>
            <input id="globalSearch" type="text" class="topbar-search-input"
                   placeholder="Search streets, cities, countries..." autocomplete="off" />
          </div>

          <div class="topbar-right">
            {% if current_user %}
              {% set USER_LABEL = current_user.name if current_user.name is defined and current_user.name
                  else (current_user.full_name if current_user.full_name is defined and current_user.full_name
                  else (current_user.email if current_user.email is defined and current_user.email else 'User')) %}
              <div class="user-pill" title="{{ USER_LABEL }}">
                <i class="fas fa-user-circle" aria-hidden="true"></i>
                <span>{{ USER_LABEL }}</span>
              </div>
            {% endif %}

            <div class="chip">Live streets</div>
            <div class="meta">
              <span class="dot"></span>
              <span>{{ streets|length if streets else 0 }} locations</span>
            </div>

            <!-- ✅ If logged out, send them to login and back to upload -->
            {% if current_user %}
              <a href="{{ url_for('upload') }}" class="btn">
                <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                <span>Upload</span>
              </a>
            {% else %}
              <a href="{{ url_for('login') }}?next={{ url_for('upload') }}" class="btn">
                <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                <span>Upload</span>
              </a>
            {% endif %}
          </div>
        </header>
      </div>

      <main id="main">
        <!-- ✅ Flash messages (so you see login/logout/reset notices) -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="flash-wrap" aria-live="polite">
              {% for category, message in messages %}
                <div class="flash {{ category|e }}">
                  <span class="flash-text">{{ message }}</span>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <!-- HERO -->
        <section class="banner" aria-label="ABTO hero">
          <div>
            <div class="hero-kicker">
              <span class="pill">Live travel</span>
              <span>Real streets • Real vibes</span>
            </div>

            <h1 class="hero-title">
              Explore <span class="grad">Real Streets</span><br/>from anywhere
            </h1>

            <p class="hero-sub">
              Walk, drive, sit or fly through real places around the world.
              No games — just reality powered by real video footage.
            </p>

            <div class="hero-actions">
              <a href="#streets" class="cta-primary">
                <i class="fas fa-play" aria-hidden="true"></i>
                Start exploring
              </a>

              {% if current_user %}
                <a href="{{ url_for('upload') }}" class="cta-secondary">
                  <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                  Upload a street
                </a>
              {% else %}
                <a href="{{ url_for('login') }}?next={{ url_for('upload') }}" class="cta-secondary">
                  <i class="fas fa-cloud-upload-alt" aria-hidden="true"></i>
                  Upload a street
                </a>
              {% endif %}
            </div>
          </div>

          <div class="hero-right">
            <div class="mini-map">
              <img src="{{ url_for('static', filename='img/main.png') }}" alt="ABTO street preview" />
              <div class="badge-float">
                <span class="pin"></span>
                <span id="streetCount" data-count="{{ streets|length if streets else 0 }}">
                  {{ streets|length if streets else 0 }}+ Streets
                </span>
              </div>
            </div>

            <div class="hero-stats" aria-label="ABTO quick stats">
              <div class="stat">
                <strong>{{ streets|length if streets else 0 }}+</strong>
                <span>Streets uploaded</span>
              </div>
              <div class="stat">
                <strong>4</strong>
                <span>Exploration modes</span>
              </div>
              <div class="stat">
                <strong>Global</strong>
                <span>Coverage growing</span>
              </div>
            </div>
          </div>
        </section>

        <!-- CATEGORY TABS -->
        <section class="controls" aria-label="Categories">
          <div class="tabs" role="tablist" aria-label="Categories">
            <button class="tab active" type="button" data-scroll="#streets">For you</button>
            <button class="tab" type="button" data-scroll="#tour-preview">Tour</button>
            <button class="tab" type="button" data-scroll="#streets">Night Walk</button>
            <button class="tab" type="button" data-scroll="#streets">Driving</button>
            <button class="tab" type="button" data-scroll="#streets">Beach</button>
            <button class="tab" type="button" data-scroll="#streets">Mountains</button>
            <button class="tab more" type="button" aria-label="More categories">
              <i class="fas fa-ellipsis-h"></i>
            </button>
          </div>
        </section>

        <!-- HOW IT WORKS -->
        <section class="section" id="how-it-works" aria-labelledby="how-title">
          <div class="section-header">
            <h2 id="how-title">How ABTO Works</h2>
            <p>ABTO converts real-world footage into a simple “press play and travel” experience.</p>
            <p class="section-subline">NO HEADSET • NO CONTROLS • JUST PRESS PLAY</p>
          </div>

          <div class="how-grid">
            <article class="how-step">
              <div class="how-step-badge">01</div>
              <h3>Upload real footage</h3>
              <p>Creators upload walking, driving, sitting or flying videos from any city using a simple upload flow.</p>
            </article>
            <article class="how-step">
              <div class="how-step-badge">02</div>
              <h3>We optimize the session</h3>
              <p>We prepare pacing and quality so viewers get smooth, distraction-free travel sessions.</p>
            </article>
            <article class="how-step">
              <div class="how-step-badge">03</div>
              <h3>Explore instantly</h3>
              <p>Pick a street, choose a mode (walk/drive/sit/fly) and drop into a real place in seconds.</p>
            </article>
          </div>

          <div class="usecases-strip" aria-label="Popular ways people use ABTO">
            <div class="usecase-pill"><i class="fas fa-coffee" aria-hidden="true"></i> Ambient travel while working</div>
            <div class="usecase-pill"><i class="fas fa-brain" aria-hidden="true"></i> Relaxing focus backgrounds</div>
            <div class="usecase-pill"><i class="fas fa-plane-departure" aria-hidden="true"></i> Pre-trip scouting</div>
            <div class="usecase-pill"><i class="fas fa-city" aria-hidden="true"></i> Explore cities you may never visit</div>
          </div>
        </section>

        <!-- TOUR PLACES -->
        {% set effective_tour_streets = tour_streets if tour_streets is defined
            else (streets|selectattr('is_tour')|list if streets else []) %}

        <section class="section" id="tour-preview" aria-labelledby="tour-title">
          <div class="section-header">
            <h3 id="tour-title">Best Tour Places</h3>
            <p>Preview popular destinations before you book. Filter by country and type.</p>
            <p class="section-subline">SEARCH • FILTER • EXPLORE</p>
          </div>

          {% if effective_tour_streets and effective_tour_streets|length > 0 %}
            <div class="tour-filters" aria-label="Filter tour places">
              <div class="tour-search-wrap">
                <i class="fas fa-search" aria-hidden="true"></i>
                <input type="text" id="tourSearch" class="tour-search-input"
                       placeholder="Search Dubai Marina, Paris, New York..." autocomplete="off" />
              </div>

              <select id="tourCountryFilter" class="tour-filter-select" aria-label="Filter by country">
                <option value="">All countries</option>
              </select>

              <select id="tourCategoryFilter" class="tour-filter-select" aria-label="Filter by tour type">
                <option value="">All types</option>
              </select>
            </div>

            <div class="tour-grid" id="tourGrid">
              {% for st in effective_tour_streets[:8] %}
                {% if st.videos and st.videos|length > 0 and st.videos[0].url %}
                  {% set thumb_url_tour = st.videos[0].url|replace('video/upload', 'video/upload/so_1,f_jpg,q_auto,w_400,c_fill,g_center') %}
                  {% set is_placeholder_tour = False %}
                {% else %}
                  <!-- ✅ use same folder as your project (img/...) -->
                  {% set thumb_url_tour = url_for('static', filename='img/placeholder-street.jpg') %}
                  {% set is_placeholder_tour = True %}
                {% endif %}

                <a href="{{ url_for('world', street_id=st._id) }}"
                   class="card tour-card"
                   data-search="{{ (st.name ~ ' ' ~ (st.city or '') ~ ' ' ~ (st.country or '') ~ ' ' ~ (st.tour_category or '') ~ ' ' ~ (st.tour_best_time or ''))|lower }}"
                   data-country="{{ (st.country or '')|lower }}"
                   data-category="{{ (st.tour_category or '')|lower }}">
                  <div class="thumb" style="background-image:url('{{ thumb_url_tour }}')">
                    <div class="thumb-tag"><span class="pin"></span> Tour</div>
                    {% if is_placeholder_tour %}
                      <div class="thumb-placeholder"><i class="fas fa-map-marked-alt" aria-hidden="true"></i></div>
                    {% endif %}
                  </div>
                  <div class="card-body">
                    <h4 title="{{ st.name }}">{{ st.name[:50] }}{% if st.name|length > 50 %}...{% endif %}</h4>
                    <div class="card-location">
                      <i class="fas fa-location-dot" aria-hidden="true"></i>
                      <span>{{ st.city or 'Unknown' }}, {{ st.country or 'Unknown' }}</span>
                    </div>
                  </div>
                </a>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state">
              <i class="fas fa-map-location-dot" aria-hidden="true"></i>
              <h3>Tour places coming soon</h3>
              <p>Upload your first tour street (mark as “Tour / Trip Preview”) to see it here.</p>
            </div>
          {% endif %}
        </section>

        <!-- TRIP PRICE CHECK -->
        <section class="section" id="trip-price" aria-labelledby="price-title">
          <div class="section-header">
            <h3 id="price-title">Check a Sample Trip Price</h3>
            <p>Type a route like <strong>Dubai → Taj Mahal</strong> for a rough distance-based estimate (experimental).</p>
            <p class="section-subline">EXPERIMENTAL • DISTANCE-BASED ONLY</p>
          </div>

          <form id="priceCheckForm" autocomplete="off">
            <div class="price-input-row">
              <div class="price-input-group">
                <label for="priceFrom">From</label>
                <input type="text" id="priceFrom" class="price-input" placeholder="Dubai, UAE" required />
              </div>
              <div class="price-input-group">
                <label for="priceTo">To</label>
                <input type="text" id="priceTo" class="price-input" placeholder="Taj Mahal, Agra" required />
              </div>
              <button type="submit" class="price-cta" id="priceSubmitBtn">
                <i class="fas fa-ticket-alt" aria-hidden="true"></i> Check price
              </button>
            </div>
          </form>

          <div class="price-result" id="priceResult" aria-live="polite" style="margin-top:12px;">
            <p>Try <strong>Dubai, UAE</strong> to <strong>Taj Mahal, Agra</strong> to see a sample.</p>
          </div>
        </section>

        <!-- FEATURED STREETS -->
        <section class="section" id="streets" aria-labelledby="featured-streets-title">
          <div class="section-header">
            <h2 id="featured-streets-title">Featured Streets</h2>
            <p>Handpicked immersive locations from around the world, ready to walk, drive, sit or fly through.</p>
            <p class="section-subline">{{ streets|length if streets else 0 }} AVAILABLE • GROWING</p>
          </div>

          {% if streets and streets|length > 0 %}
            <div class="streets-search-wrap" aria-label="Search streets">
              <i class="fas fa-search" aria-hidden="true"></i>
              <input type="text" id="streetsSearch" class="streets-search-input"
                     placeholder="Search any street, city or country..." autocomplete="off" />
            </div>

            <div class="grid" id="streetsGrid">
              {% for st in streets %}
                {% if st.videos and st.videos|length > 0 and st.videos[0].url %}
                  {% set thumb_url = st.videos[0].url|replace('video/upload', 'video/upload/so_1,f_jpg,q_auto,w_400,c_fill,g_center') %}
                  {% set is_placeholder = False %}
                {% else %}
                  {% set thumb_url = url_for('static', filename='img/placeholder-street.jpg') %}
                  {% set is_placeholder = True %}
                {% endif %}

                <a href="{{ url_for('world', street_id=st._id) }}"
                   class="card street-card"
                   data-search="{{ (st.name ~ ' ' ~ (st.city or '') ~ ' ' ~ (st.country or ''))|lower }}">
                  <div class="thumb" style="background-image:url('{{ thumb_url }}')">
                    <div class="thumb-tag"><span class="pin"></span> Street</div>
                    {% if is_placeholder %}
                      <div class="thumb-placeholder"><i class="fas fa-map-marked-alt" aria-hidden="true"></i></div>
                    {% endif %}
                  </div>
                  <div class="card-body">
                    <h4 title="{{ st.name }}">{{ st.name[:50] }}{% if st.name|length > 50 %}...{% endif %}</h4>
                    <div class="card-location">
                      <i class="fas fa-location-dot" aria-hidden="true"></i>
                      <span>{{ st.city or 'Unknown' }}, {{ st.country or 'Unknown' }}</span>
                    </div>
                  </div>
                </a>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state">
              <i class="fas fa-map" aria-hidden="true"></i>
              <h3>No streets available yet</h3>
              <p>Be the first to upload and explore real streets around the world.</p>
              <p style="margin-top:12px;">
                {% if current_user %}
                  <a class="btn" href="{{ url_for('upload') }}">
                    <i class="fas fa-upload" aria-hidden="true"></i> Upload first street
                  </a>
                {% else %}
                  <a class="btn" href="{{ url_for('login') }}?next={{ url_for('upload') }}">
                    <i class="fas fa-upload" aria-hidden="true"></i> Upload first street
                  </a>
                {% endif %}
              </p>
            </div>
          {% endif %}
        </section>

        <footer>
          <p class="footer-main">&copy; 2025 ABTO</p>
          <p class="footer-sub">A Better Travel Observer • Walk • Drive • Sit • Fly</p>
        </footer>
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Preloader
      const preloader = document.getElementById('preloader');
      const hidePreloader = () => {
        if (!preloader) return;
        preloader.style.opacity = '0';
        preloader.style.transform = 'scale(0.98)';
        setTimeout(() => preloader.remove(), 240);
      };
      setTimeout(hidePreloader, 550);

      // Mobile sidebar drawer
      const navbar = document.getElementById('navbar');
      const overlay = document.getElementById('overlay');
      const openBtn = document.getElementById('openSidebar');
      const closeBtn = document.getElementById('closeSidebar');

      let scrollY = 0;
      let lastFocus = null;

      const lockBody = () => {
        scrollY = window.scrollY || 0;
        document.body.classList.add('nav-open');
        document.body.style.top = `-${scrollY}px`;
      };

      const unlockBody = () => {
        document.body.classList.remove('nav-open');
        document.body.style.top = '';
        window.scrollTo(0, scrollY);
      };

      const openSidebar = () => {
        if (!navbar || !overlay) return;
        lastFocus = document.activeElement;

        navbar.classList.add('open');
        overlay.classList.add('show');
        lockBody();

        if (closeBtn) closeBtn.focus();
      };

      const closeSidebar = () => {
        if (!navbar || !overlay) return;

        navbar.classList.remove('open');
        overlay.classList.remove('show');
        unlockBody();

        if (lastFocus && typeof lastFocus.focus === 'function') lastFocus.focus();
      };

      openBtn?.addEventListener('click', openSidebar);
      closeBtn?.addEventListener('click', closeSidebar);
      overlay?.addEventListener('click', closeSidebar);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && navbar?.classList.contains('open')) closeSidebar();
      });

      // Close drawer when clicking nav links (mobile)
      document.querySelectorAll('#navLinks a.nav-link').forEach(a => {
        a.addEventListener('click', () => {
          if (window.matchMedia('(max-width: 980px)').matches) closeSidebar();
        });
      });

      // Tabs scroll
      document.querySelectorAll('.tab[data-scroll]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const sel = btn.getAttribute('data-scroll');
          const el = sel ? document.querySelector(sel) : null;
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
      });

      // Street count formatting
      const streetCount = document.getElementById('streetCount');
      if (streetCount) {
        const rawVal = streetCount.dataset.count || '0';
        const val = parseInt(rawVal, 10);
        if (!isNaN(val)) streetCount.textContent = `${val.toLocaleString('en-US')}+ Streets`;
      }

      // Tour search + filters
      const tourSearch         = document.getElementById('tourSearch');
      const tourGrid           = document.getElementById('tourGrid');
      const tourCountryFilter  = document.getElementById('tourCountryFilter');
      const tourCategoryFilter = document.getElementById('tourCategoryFilter');

      if (tourGrid) {
        const tourCards = Array.from(tourGrid.querySelectorAll('.tour-card'));
        const countrySet = new Set();
        const categorySet = new Set();

        tourCards.forEach(card => {
          const c = (card.dataset.country || '').trim();
          const cat = (card.dataset.category || '').trim();
          if (c) countrySet.add(c);
          if (cat) categorySet.add(cat);
        });

        const toLabel = (str) => str
          ? str.split(' ').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')
          : '';

        if (tourCountryFilter && countrySet.size) {
          Array.from(countrySet).sort().forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = toLabel(c);
            tourCountryFilter.appendChild(opt);
          });
        }
        if (tourCategoryFilter && categorySet.size) {
          Array.from(categorySet).sort().forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = toLabel(cat);
            tourCategoryFilter.appendChild(opt);
          });
        }

        let t;
        function applyTourFilters() {
          const q = (tourSearch?.value || '').trim().toLowerCase();
          const country = (tourCountryFilter?.value || '').trim();
          const category = (tourCategoryFilter?.value || '').trim();

          tourCards.forEach(card => {
            const text = (card.dataset.search || '');
            const c = (card.dataset.country || '');
            const cat = (card.dataset.category || '');

            const show = (!q || text.includes(q)) &&
                         (!country || c === country) &&
                         (!category || cat === category);

            card.style.display = show ? '' : 'none';
          });
        }

        tourSearch?.addEventListener('input', () => {
          clearTimeout(t);
          t = setTimeout(applyTourFilters, 140);
        });
        tourCountryFilter?.addEventListener('change', applyTourFilters);
        tourCategoryFilter?.addEventListener('change', applyTourFilters);
      }

      // Streets search + global sync
      const streetsSearch = document.getElementById('streetsSearch');
      const globalSearch  = document.getElementById('globalSearch');
      const streetsGridEl = document.getElementById('streetsGrid');

      function applyStreetSearch(value) {
        if (!streetsGridEl) return;
        const cards = Array.from(streetsGridEl.querySelectorAll('.street-card'));
        const q = (value || '').trim().toLowerCase();
        cards.forEach(card => {
          const text = (card.dataset.search || '');
          card.style.display = (!q || text.includes(q)) ? '' : 'none';
        });
      }

      streetsSearch?.addEventListener('input', () => {
        applyStreetSearch(streetsSearch.value);
        if (globalSearch && globalSearch.value !== streetsSearch.value) globalSearch.value = streetsSearch.value;
      });

      globalSearch?.addEventListener('input', () => {
        applyStreetSearch(globalSearch.value);
        if (streetsSearch && streetsSearch.value !== globalSearch.value) streetsSearch.value = globalSearch.value;
      });

      // Trip price checker
      const priceForm      = document.getElementById('priceCheckForm');
      const priceFrom      = document.getElementById('priceFrom');
      const priceTo        = document.getElementById('priceTo');
      const priceResult    = document.getElementById('priceResult');
      const priceSubmitBtn = document.getElementById('priceSubmitBtn');

      async function runPriceCheck(e) {
        if (e) e.preventDefault();
        if (!priceFrom || !priceTo || !priceResult || !priceSubmitBtn) return;

        const origin = priceFrom.value.trim();
        const destination = priceTo.value.trim();

        if (!origin || !destination) {
          priceResult.innerHTML = `
            <div class="price-result-card">
              <h4>Please enter both places</h4>
              <p>Example: <strong>Dubai, UAE</strong> to <strong>Taj Mahal, Agra</strong>.</p>
            </div>`;
          return;
        }

        const old = priceSubmitBtn.innerHTML;
        priceSubmitBtn.disabled = true;
        priceSubmitBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>&nbsp;Checking...`;
        priceResult.innerHTML = `<p>Calculating distance and rough estimate...</p>`;

        try {
          const resp = await fetch("{{ url_for('api_price') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ origin, destination })
          });

          const data = await resp.json();

          if (!resp.ok) {
            const msg = data && data.error ? data.error : "Something went wrong on the server.";
            priceResult.innerHTML = `
              <div class="price-result-card">
                <h4>Could not fetch estimate</h4>
                <p>${msg}</p>
              </div>`;
            return;
          }

          const originLabel = data.origin_formatted || origin;
          const destLabel   = data.destination_formatted || destination;

          const distanceText = data.distance_text || "";
          const priceText    = data.price_text || "";

          priceResult.innerHTML = `
            <div class="price-result-card">
              <h4>${originLabel} → ${destLabel}</h4>
              ${distanceText ? `<p>${distanceText}</p>` : ""}
              ${priceText ? `<p class="price-tag">${priceText}</p>` : ""}
              <p class="price-disclaimer">
                Automatic estimate based on distance only. Real prices vary by airline, season and booking date.
              </p>
            </div>`;
        } catch (err) {
          console.error(err);
          priceResult.innerHTML = `
            <div class="price-result-card">
              <h4>Network error</h4>
              <p>Couldn’t reach the pricing service. Please try again.</p>
            </div>`;
        } finally {
          priceSubmitBtn.disabled = false;
          priceSubmitBtn.innerHTML = old;
        }
      }

      priceForm?.addEventListener('submit', runPriceCheck);
    });
  </script>
</body>
</html>
